name: Jekyll site CI

# GitHub Pages ë°°í¬ ì›Œí¬í”Œë¡œìš°
# Free í‹°ì–´ ìµœì í™”: ìºì‹±, ì¡°ê±´ë¶€ ì‹¤í–‰, ë³‘ë ¬í™”

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    # PRì—ì„œëŠ” ë¹Œë“œë§Œ ì‹¤í–‰ (ë°°í¬ ì œì™¸)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  check-changes:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    permissions:
      contents: read
    outputs:
      should-build: ${{ steps.set-output.outputs.should-build }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Check changed files
        id: filter
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        uses: dorny/paths-filter@v2
        with:
          filters: |
            should-build:
              - '**_posts/**'
              - '**_includes/**'
              - '**_layouts/**'
              - '**assets/**'
              - '**_config.yml'
              - '**vercel.json'
              - '**.github/workflows/**'
      
      - name: Set output
        id: set-output
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should-build=true" >> $GITHUB_OUTPUT
          elif [ -n "${{ steps.filter.outputs.should-build }}" ]; then
            echo "should-build=${{ steps.filter.outputs.should-build }}" >> $GITHUB_OUTPUT
          else
            echo "should-build=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Output decision
        run: |
          echo "Should build: ${{ steps.set-output.outputs.should-build }}"

  build:
    runs-on: ubuntu-latest
    # íƒ€ì„ì•„ì›ƒ ì„¤ì • (ë¬´í•œ ì‹¤í–‰ ë°©ì§€)
    timeout-minutes: 10
    # CI ìµœì í™”: ê´€ë ¨ íŒŒì¼ ë³€ê²½ ì‹œì—ë§Œ ë¹Œë“œ (workflow_dispatchëŠ” í•­ìƒ ì‹¤í–‰)
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'push' && (needs.check-changes.outputs.should-build == 'true' || needs.check-changes.outputs.should-build == ''))
    needs: [check-changes]
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true # ìë™ ìºì‹± (ë¹„ìš© ì ˆê°)

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node.js dependencies
        run: |
          echo "ğŸ“¦ Installing Node.js dependencies..."
          npm ci || npm install
          echo "âœ… Node.js dependencies installed"

      - name: Setup Python (for favicon generation)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: scripts/requirements.txt

      - name: Install Python dependencies
        run: |
          echo "ğŸ“¦ Installing Python dependencies..."
          pip install --quiet Pillow || echo "âš ï¸ Pillow installation failed, continuing..."
          echo "âœ… Python dependencies installed"

      - name: Validate Jekyll Configuration
        run: |
          bundle exec jekyll doctor || true
          echo "âœ… Jekyll configuration validation completed"

      - name: Build with build.sh (consistent with Vercel)
        run: |
          set -e
          echo "ğŸ” Building Jekyll site using build.sh..."
          echo "Ruby version: $(ruby -v)"
          echo "Bundler version: $(bundle -v)"
          echo "Jekyll version: $(bundle exec jekyll -v)"
          echo "Node version: $(node -v)"
          echo "Python version: $(python3 --version)"
          echo ""
          echo "ğŸ“¦ Installing Ruby dependencies..."
          bundle install --jobs 4 --retry 3 || (echo "âŒ Bundle install failed" && exit 1)
          echo ""
          echo "ğŸ—ï¸  Building site with build.sh..."
          chmod +x build.sh
          # Set baseurl for GitHub Pages (if configured)
          export BASEURL="${{ steps.pages.outputs.base_path }}"
          if ./build.sh; then
            echo "âœ… Build completed successfully"
          else
            echo "âŒ Build failed"
            exit 1
          fi
        env:
          JEKYLL_ENV: production
          LANG: C.UTF-8
          LC_ALL: C.UTF-8
          LANGUAGE: C.UTF-8
          # Vercelê³¼ ë™ê¸°í™”ë¥¼ ìœ„í•œ ë¹Œë“œ ì •ë³´
          BUILD_ID: ${{ github.sha }}
          BUILD_TIME: ${{ github.event.head_commit.timestamp }}
          DEPLOYMENT_URL: ${{ github.event.repository.html_url }}

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    # PRì—ì„œëŠ” ë°°í¬í•˜ì§€ ì•ŠìŒ (ë¹„ìš© ì ˆê°)
    # CI ìµœì í™”: ê´€ë ¨ íŒŒì¼ ë³€ê²½ ì‹œì—ë§Œ ë°°í¬
    # build ì‘ì—…ì´ ì„±ê³µí–ˆì„ ë•Œë§Œ ë°°í¬ (ëª…ì‹œì  ì¡°ê±´ ì¶”ê°€)
    if: |
      always() &&
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main' &&
      (needs.check-changes.outputs.should-build == 'true' || needs.check-changes.outputs.should-build == '') &&
      needs.build.result == 'success'
    
    # ë™ì‹œ ë°°í¬ ë°©ì§€: ê°™ì€ ë¸Œëœì¹˜ì˜ ë°°í¬ëŠ” íì— ëŒ€ê¸°
    # cancel-in-progress: falseë¡œ ì„¤ì •í•˜ì—¬ ì´ì „ ë¹Œë“œê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
    concurrency:
      group: pages-deploy-${{ github.ref }}
      cancel-in-progress: false
    
    # ë°°í¬ job íƒ€ì„ì•„ì›ƒ: GitHub Pages ë°°í¬ëŠ” ìµœëŒ€ 15ë¶„ê¹Œì§€ ì†Œìš”ë  ìˆ˜ ìˆìŒ
    timeout-minutes: 15
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: [check-changes, build]
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Check build status
        run: |
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "âŒ Build job failed or was cancelled. Skipping deployment."
            exit 1
          fi
          echo "âœ… Build job succeeded. Proceeding with deployment."
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        # deploy-pages ì•¡ì…˜ íƒ€ì„ì•„ì›ƒ: 10ë¶„ (600000ms)
        # ì•¡ì…˜ ë‚´ë¶€ì—ì„œ deployment_queued ìƒíƒœë¥¼ ëª¨ë‹ˆí„°ë§í•˜ë©° ëŒ€ê¸°
        timeout-minutes: 10
        continue-on-error: false
      
      - name: Deployment Info
        if: success()
        run: |
          echo "âœ… Deployed to GitHub Pages"
          echo "URL: ${{ steps.deployment.outputs.page_url }}"
          echo "Commit: ${{ github.sha }}"
      
      - name: Deployment Error
        if: failure()
        run: |
          echo "âŒ Deployment failed"
          echo "Please check the logs above for details"
          exit 1