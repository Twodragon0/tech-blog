name: Jekyll site CI

# GitHub Pages 배포 워크플로우
# Free 티어 최적화: 캐싱, 조건부 실행, 병렬화

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    # PR에서는 빌드만 실행 (배포 제외)
  workflow_dispatch: # 수동 실행 가능

jobs:
  build:
    runs-on: ubuntu-latest
    # 타임아웃 설정 (무한 실행 방지)
    timeout-minutes: 10
    
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true # 자동 캐싱 (비용 절감)

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: Build with Jekyll
        run: bundle exec jekyll build --baseurl "${{ steps.pages.outputs.base_path }}"
        env:
          JEKYLL_ENV: production
          LANG: en_US.UTF-8
          LC_ALL: en_US.UTF-8
          # Vercel과 동기화를 위한 빌드 정보
          BUILD_ID: ${{ github.sha }}
          BUILD_TIME: ${{ github.event.head_commit.timestamp }}
          DEPLOYMENT_URL: ${{ github.event.repository.html_url }}

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    # PR에서는 배포하지 않음 (비용 절감)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Wait for previous deployment
        run: |
          echo "⏳ Checking for in-progress deployments..."
          # Wait longer to allow previous deployment to complete
          # GitHub Pages deployments can take 1-2 minutes
          sleep 90
          echo "✅ Proceeding with deployment..."
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        timeout-minutes: 5
      
      - name: Deployment Info
        if: success()
        run: |
          echo "✅ Deployed to GitHub Pages"
          echo "URL: ${{ steps.deployment.outputs.page_url }}"
          echo "Commit: ${{ github.sha }}"