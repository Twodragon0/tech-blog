name: Generate Post Images

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë§Œ í—ˆìš© (ë¹„ìš© ê´€ë¦¬)
    inputs:
      post_file:
        description: 'í¬ìŠ¤íŠ¸ íŒŒì¼ëª… (ì˜ˆ: 2026-01-10-2026ë…„_DevSecOps_ë¡œë“œë§µ_ì™„ë²½_ê°€ì´ë“œ.md)'
        required: false
        type: string
      image_type:
        description: 'ì´ë¯¸ì§€ ìƒì„± íƒ€ìž…'
        required: false
        type: choice
        options:
          - post
          - segment
          - both
        default: 'post'
      force:
        description: 'ì´ë¯¸ì§€ê°€ ìžˆì–´ë„ ê°•ì œë¡œ ìž¬ìƒì„±'
        required: false
        type: boolean
        default: false
  # push ì´ë²¤íŠ¸ëŠ” ì£¼ì„ ì²˜ë¦¬ (ë¹„ìš© ê´€ë¦¬)
  # push:
  #   paths:
  #     - '_posts/**'

jobs:
  generate-images:
    runs-on: ubuntu-latest
    # ë³´ì•ˆ: ìµœì†Œ ê¶Œí•œ ì›ì¹™ ì ìš©
    permissions:
      contents: read
      actions: read
    # ë¹„ìš© ê´€ë¦¬: ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
    continue-on-error: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          if [ -f "scripts/requirements.txt" ]; then
            pip install -r scripts/requirements.txt
          else
            pip install requests frontmatter pillow
          fi

      - name: Verify GEMINI_API_KEY
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # ë³´ì•ˆ: GitHub Secretsì— ë°˜ë“œì‹œ ì„¤ì •í•´ì•¼ í•¨
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "âŒ GEMINI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "GitHub Secretsì— GEMINI_API_KEYë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”."
            echo "ì„¤ì • ë°©ë²•: .github/SECRETS_MANAGEMENT.md ì°¸ê³ "
            echo ""
            echo "GitHub CLIë¡œ ì„¤ì •:"
            echo "  gh secret set GEMINI_API_KEY --body 'your-gemini-api-key'"
            exit 1
          fi
          
          # API í‚¤ í˜•ì‹ ê²€ì¦ (ë³´ì•ˆ ê°•í™”)
          if [ ${#GEMINI_API_KEY} -lt 20 ]; then
            echo "âš ï¸ GEMINI_API_KEY í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì„ ìˆ˜ ìžˆìŠµë‹ˆë‹¤. (ìµœì†Œ 20ìž)"
            echo "âš ï¸ ì›Œí¬í”Œë¡œìš°ëŠ” ê³„ì† ì§„í–‰í•˜ì§€ë§Œ ì‹¤íŒ¨í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤."
          fi
          
          echo "âœ… GEMINI_API_KEY ê²€ì¦ ì™„ë£Œ"
          echo "ðŸ”’ ë³´ì•ˆ: API í‚¤ ê°’ì€ ë¡œê·¸ì— ì¶œë ¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."

      - name: Generate Post Images
        if: github.event.inputs.image_type == 'post' || github.event.inputs.image_type == 'both' || github.event.inputs.image_type == ''
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          USE_GEMINI_PRO_IMAGE: ${{ secrets.USE_GEMINI_PRO_IMAGE || 'false' }}
        run: |
          echo "ðŸŽ¨ í¬ìŠ¤íŠ¸ ì´ë¯¸ì§€ ìƒì„± ì‹œìž‘..."
          echo "ðŸ’° ë¹„ìš© ê´€ë¦¬: Gemini API ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§ ê¶Œìž¥"
          echo "ðŸ“Š ì‚¬ìš©ëŸ‰ í™•ì¸: https://makersuite.google.com/app/apikey"
          echo ""
          
          if [ -n "${{ github.event.inputs.post_file }}" ]; then
            # íŠ¹ì • í¬ìŠ¤íŠ¸ íŒŒì¼ ì²˜ë¦¬
            POST_FILE="_posts/${{ github.event.inputs.post_file }}"
            if [ ! -f "$POST_FILE" ]; then
              echo "âŒ í¬ìŠ¤íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $POST_FILE"
              exit 1
            fi
            echo "ðŸ“„ ì²˜ë¦¬í•  í¬ìŠ¤íŠ¸: $POST_FILE"
            
            if [ "${{ github.event.inputs.force }}" = "true" ]; then
              python3 scripts/generate_post_images.py "$POST_FILE" --force
            else
              python3 scripts/generate_post_images.py "$POST_FILE"
            fi
          else
            # ìµœê·¼ í¬ìŠ¤íŠ¸ ì²˜ë¦¬
            echo "ðŸ“„ ìµœê·¼ í¬ìŠ¤íŠ¸ ì´ë¯¸ì§€ ìƒì„± ì¤‘..."
            if [ "${{ github.event.inputs.force }}" = "true" ]; then
              python3 scripts/generate_post_images.py --recent 1 --force
            else
              python3 scripts/generate_post_images.py --recent 1
            fi
          fi
          
          # ìƒì„±ëœ ì´ë¯¸ì§€ íŒŒì¼ í™•ì¸
          if [ -d "assets/images" ]; then
            echo ""
            echo "ðŸ“¦ ìƒì„±ëœ ì´ë¯¸ì§€ íŒŒì¼:"
            ls -lh assets/images/*.png assets/images/*.jpg 2>/dev/null | tail -n 10 || echo "âš ï¸ ì´ë¯¸ì§€ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          fi

      - name: Generate Segment Images
        if: github.event.inputs.image_type == 'segment' || github.event.inputs.image_type == 'both'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          USE_GEMINI_PRO_IMAGE: ${{ secrets.USE_GEMINI_PRO_IMAGE || 'false' }}
        run: |
          echo "ðŸŽ¨ ì„¸ê·¸ë¨¼íŠ¸ ì´ë¯¸ì§€ ìƒì„± ì‹œìž‘..."
          echo "ðŸ’° ë¹„ìš© ê´€ë¦¬: Gemini API ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§ ê¶Œìž¥"
          echo "ðŸ“Š ì‚¬ìš©ëŸ‰ í™•ì¸: https://makersuite.google.com/app/apikey"
          echo ""
          
          if [ -n "${{ github.event.inputs.post_file }}" ]; then
            # íŠ¹ì • í¬ìŠ¤íŠ¸ì˜ ì„¸ê·¸ë¨¼íŠ¸ ì´ë¯¸ì§€ ìƒì„±
            POST_BASENAME=$(basename "${{ github.event.inputs.post_file }}" .md)
            SEGMENTS_JSON="output/${POST_BASENAME}_script_segments.json"
            
            if [ ! -f "$SEGMENTS_JSON" ]; then
              echo "âš ï¸ ì„¸ê·¸ë¨¼íŠ¸ JSON íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $SEGMENTS_JSON"
              echo "ðŸ’¡ ë¨¼ì € ì˜¤ë””ì˜¤ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ ì„¸ê·¸ë¨¼íŠ¸ íŒŒì¼ì„ ìƒì„±í•˜ì„¸ìš”."
              exit 1
            fi
            
            echo "ðŸ“„ ì²˜ë¦¬í•  ì„¸ê·¸ë¨¼íŠ¸: $SEGMENTS_JSON"
            python3 scripts/generate_segment_images.py "$POST_BASENAME"
          else
            # ìµœê·¼ ì„¸ê·¸ë¨¼íŠ¸ íŒŒì¼ ì°¾ê¸°
            RECENT_SEGMENTS=$(find output -name "*_script_segments.json" -type f | sort -r | head -n 1)
            
            if [ -z "$RECENT_SEGMENTS" ]; then
              echo "âš ï¸ ì„¸ê·¸ë¨¼íŠ¸ JSON íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              echo "ðŸ’¡ ë¨¼ì € ì˜¤ë””ì˜¤ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ ì„¸ê·¸ë¨¼íŠ¸ íŒŒì¼ì„ ìƒì„±í•˜ì„¸ìš”."
              exit 1
            fi
            
            POST_BASENAME=$(basename "$RECENT_SEGMENTS" _script_segments.json)
            echo "ðŸ“„ ì²˜ë¦¬í•  ì„¸ê·¸ë¨¼íŠ¸: $POST_BASENAME"
            python3 scripts/generate_segment_images.py "$POST_BASENAME"
          fi
          
          # ìƒì„±ëœ ì´ë¯¸ì§€ íŒŒì¼ í™•ì¸
          if [ -d "assets/images" ]; then
            echo ""
            echo "ðŸ“¦ ìƒì„±ëœ ì„¸ê·¸ë¨¼íŠ¸ ì´ë¯¸ì§€ íŒŒì¼:"
            ls -lh assets/images/*segment*.png 2>/dev/null | tail -n 10 || echo "âš ï¸ ì„¸ê·¸ë¨¼íŠ¸ ì´ë¯¸ì§€ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          fi

      - name: Upload Generated Images
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: generated-images
          path: |
            assets/images/*.png
            assets/images/*.jpg
          retention-days: 7  # 7ì¼ê°„ ë³´ê´€ (ë¹„ìš© ê´€ë¦¬)
          if-no-files-found: warn

      - name: Show Summary
        if: always()
        run: |
          echo "## ðŸ“Š ì´ë¯¸ì§€ ìƒì„± ìž‘ì—… ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ìƒì„± íƒ€ìž…: ${{ github.event.inputs.image_type || 'post' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "assets/images" ]; then
            echo "### ìƒì„±ëœ ì´ë¯¸ì§€ íŒŒì¼:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -lh assets/images/*.png assets/images/*.jpg 2>/dev/null | tail -n 20 >> $GITHUB_STEP_SUMMARY || echo "ì´ë¯¸ì§€ íŒŒì¼ ì—†ìŒ" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ë‹¤ìŒ ë‹¨ê³„:" >> $GITHUB_STEP_SUMMARY
          echo "1. ìƒì„±ëœ ì´ë¯¸ì§€ í™•ì¸: \`assets/images/\` ë””ë ‰í† ë¦¬" >> $GITHUB_STEP_SUMMARY
          echo "2. í¬ìŠ¤íŠ¸ì˜ \`image\` í•„ë“œì— ì´ë¯¸ì§€ ê²½ë¡œ ì¶”ê°€" >> $GITHUB_STEP_SUMMARY
          echo "3. ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ" >> $GITHUB_STEP_SUMMARY
