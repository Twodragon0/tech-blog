name: Sentry Release

# Sentry Release ÏÉùÏÑ± ÏõåÌÅ¨ÌîåÎ°úÏö∞
# Free Ìã∞Ïñ¥ ÏµúÏ†ÅÌôî: ÌîÑÎ°úÎçïÏÖò Î∞∞Ìè¨ ÏãúÏóêÎßå Ïã§Ìñâ, ÏÜåÏä§Îßµ ÏóÖÎ°úÎìú Ï†úÏô∏

on:
  push:
    branches:
      - main
    # ÌäπÏ†ï ÌååÏùº Î≥ÄÍ≤Ω ÏãúÏóêÎßå Ïã§Ìñâ (ÎπÑÏö© Ï†àÍ∞ê)
    paths:
      - '_includes/**'
      - '_layouts/**'
      - '_posts/**'
      - 'assets/**'
      - '_config.yml'
      - 'vercel.json'
      - '.github/workflows/sentry-release.yml'
  workflow_dispatch: # ÏàòÎèô Ïã§Ìñâ Í∞ÄÎä•

jobs:
  create-sentry-release:
    runs-on: ubuntu-latest
    # ÌÉÄÏûÑÏïÑÏõÉ ÏÑ§Ï†ï (Î¨¥Ìïú Ïã§Ìñâ Î∞©ÏßÄ)
    timeout-minutes: 5
    
    permissions:
      contents: read
      # Sentry Release ÏÉùÏÑ±Ïóê ÌïÑÏöîÌïú ÏµúÏÜå Í∂åÌïúÎßå
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ï†ÑÏ≤¥ ÌûàÏä§ÌÜ†Î¶¨ ÌïÑÏöî (Ïª§Î∞ã Ï†ïÎ≥¥ Ï∂îÏ∂ú)
      
      - name: Verify Sentry Configuration
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: twodragon
          SENTRY_PROJECT: tech-blog
        run: |
          echo "üîç Verifying Sentry configuration..."
          echo "Organization: $SENTRY_ORG"
          echo "Project: $SENTRY_PROJECT"
          echo "Token: ${SENTRY_AUTH_TOKEN:0:10}..." # Ï≤´ 10ÏûêÎßå ÌëúÏãú
          
          # Token Ï°¥Ïû¨ ÌôïÏù∏
          if [ -z "$SENTRY_AUTH_TOKEN" ]; then
            echo "‚ùå SENTRY_AUTH_TOKEN is not set in GitHub Secrets"
            exit 1
          fi
          
          # Sentry API Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
          echo "üîó Testing Sentry API connection..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $SENTRY_AUTH_TOKEN" \
            -H "Content-Type: application/json" \
            "https://sentry.io/api/0/projects/$SENTRY_ORG/$SENTRY_PROJECT/")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Successfully connected to Sentry API"
          elif [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "403" ]; then
            echo "‚ùå Authentication failed (HTTP $HTTP_CODE)"
            echo "   Please check token permissions (project:releases required)"
            exit 1
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "‚ùå Project not found (HTTP $HTTP_CODE)"
            echo "   Please verify org: $SENTRY_ORG, project: $SENTRY_PROJECT"
            exit 1
          else
            echo "‚ö†Ô∏è  Unexpected response (HTTP $HTTP_CODE)"
          fi
      
      - name: Check if Release Exists
        id: check_release
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: twodragon
          SENTRY_PROJECT: tech-blog
        run: |
          RELEASE_VERSION="${{ github.sha }}"
          echo "üîç Checking if release $RELEASE_VERSION already exists..."
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $SENTRY_AUTH_TOKEN" \
            -H "Content-Type: application/json" \
            "https://sentry.io/api/0/projects/$SENTRY_ORG/$SENTRY_PROJECT/releases/$RELEASE_VERSION/")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚ÑπÔ∏è  Release $RELEASE_VERSION already exists"
            echo "exists=true" >> $GITHUB_OUTPUT
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "‚úÖ Release $RELEASE_VERSION does not exist, will create new"
            echo "exists=false" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Unexpected response (HTTP $HTTP_CODE), will attempt to create"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Sentry Release
        id: create_release
        if: steps.check_release.outputs.exists != 'true'
        # Free Ìã∞Ïñ¥ ÏµúÏ†ÅÌôî: ÏÜåÏä§Îßµ ÏóÖÎ°úÎìú Ï†úÏô∏ (ÎπÑÏö© Ï†àÍ∞ê)
        continue-on-error: true
        uses: getsentry/action-release@v1
        env:
          # GitHub SecretsÏóê Ï†ÄÏû• ÌïÑÏöî
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: twodragon
          SENTRY_PROJECT: tech-blog
          # ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏ ÌôúÏÑ±Ìôî (Î¨∏Ï†ú Ìï¥Í≤∞Ïö©)
          SENTRY_LOG_LEVEL: debug
        with:
          environment: production
          version: ${{ github.sha }}
          # Free Ìã∞Ïñ¥ ÏµúÏ†ÅÌôî: ÏÜåÏä§Îßµ Ï†úÏô∏ (Jekyll Ï†ïÏ†Å ÏÇ¨Ïù¥Ìä∏Ïù¥ÎØÄÎ°ú Î∂àÌïÑÏöî)
          sourcemaps: false
          # Ïª§Î∞ã Ï†ïÎ≥¥Îßå Ï∂îÏ†Å (ÎπÑÏö© Ï†àÍ∞ê)
          set_commits: auto
          # GitHub ÌÜµÌï©ÏùÑ ÌÜµÌïú Ïª§Î∞ã Ï†ïÎ≥¥ ÏûêÎèô Ïó∞Í≤∞
          ignore_missing: true
          # Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Î¶¥Î¶¨Ïä§ Î¨¥Ïãú
          ignore_empty: true
      
      - name: Handle Release Creation Result
        id: handle_release
        if: always() && steps.create_release.outcome != 'success'
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: twodragon
          SENTRY_PROJECT: tech-blog
        run: |
          RELEASE_VERSION="${{ github.sha }}"
          echo "‚ö†Ô∏è  Release creation had issues, checking final status..."
          
          # ÏµúÏ¢Ö ÏÉÅÌÉú ÌôïÏù∏
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $SENTRY_AUTH_TOKEN" \
            -H "Content-Type: application/json" \
            "https://sentry.io/api/0/projects/$SENTRY_ORG/$SENTRY_PROJECT/releases/$RELEASE_VERSION/")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Release $RELEASE_VERSION exists (may have been created by another process)"
            echo "‚úÖ Continuing workflow..."
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Release $RELEASE_VERSION does not exist"
            echo "‚ùå Please check the error logs above for details"
            echo ""
            echo "Common issues:"
            echo "1. Token lacks 'project:releases' permission"
            echo "2. Organization or project name mismatch"
            echo "3. Rate limiting (free tier)"
            echo "4. Network/API issues"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Output Release Info
        if: always()
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: twodragon
          SENTRY_PROJECT: tech-blog
        run: |
          RELEASE_VERSION="${{ github.sha }}"
          
          # ÏµúÏ¢Ö Î¶¥Î¶¨Ïä§ Ï°¥Ïû¨ Ïó¨Î∂Ä ÌôïÏù∏
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $SENTRY_AUTH_TOKEN" \
            -H "Content-Type: application/json" \
            "https://sentry.io/api/0/projects/$SENTRY_ORG/$SENTRY_PROJECT/releases/$RELEASE_VERSION/")
          
          if [ "$HTTP_CODE" = "200" ]; then
            if [ "${{ steps.check_release.outputs.exists }}" = "true" ]; then
              echo "‚ÑπÔ∏è  Sentry Release already existed"
            else
              echo "‚úÖ Sentry Release created successfully"
            fi
            echo ""
            echo "Release: $RELEASE_VERSION"
            echo "Environment: production"
            echo "Project: tech-blog"
            echo "Org: twodragon"
            echo ""
            echo "View release: https://sentry.io/organizations/twodragon/releases/$RELEASE_VERSION/"
          else
            echo "‚ùå Sentry Release not found"
            echo "Release: $RELEASE_VERSION"
            echo "HTTP Status: $HTTP_CODE"
          fi
