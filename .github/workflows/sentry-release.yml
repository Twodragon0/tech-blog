name: Sentry Release

# Sentry Release ÏÉùÏÑ± ÏõåÌÅ¨ÌîåÎ°úÏö∞
# Free Ìã∞Ïñ¥ ÏµúÏ†ÅÌôî: ÌîÑÎ°úÎçïÏÖò Î∞∞Ìè¨ ÏãúÏóêÎßå Ïã§Ìñâ, ÏÜåÏä§Îßµ ÏóÖÎ°úÎìú Ï†úÏô∏
# test-sentry-release Í∏∞Îä• ÌÜµÌï©: dry_run=trueÎ°ú Í≤ÄÏ¶ùÎßå ÏàòÌñâ Í∞ÄÎä•

on:
  push:
    branches:
      - main
    # ÌäπÏ†ï ÌååÏùº Î≥ÄÍ≤Ω ÏãúÏóêÎßå Ïã§Ìñâ (ÎπÑÏö© Ï†àÍ∞ê)
    paths:
      - '_includes/**'
      - '_layouts/**'
      - '_posts/**'
      - 'assets/**'
      - '_config.yml'
      - 'vercel.json'
      - '.github/workflows/sentry-release.yml'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run - verify config only, no release creation'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

concurrency:
  group: sentry-release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  create-sentry-release:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # Free Ìã∞Ïñ¥ÏóêÏÑúÎäî Release ÏÉùÏÑ± Ïã§Ìå®Î•º ÏπòÎ™ÖÏ†Å Ïò§Î•òÎ°ú Ï≤òÎ¶¨ÌïòÏßÄ ÏïäÏùå
    continue-on-error: true

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify Sentry Configuration
        id: verify
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG || 'twodragon' }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT || 'tech-blog' }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          # ‚îÄ‚îÄ‚îÄ Reusable curl-retry function ‚îÄ‚îÄ‚îÄ
          sentry_api() {
            local url="$1"
            local method="${2:-GET}"
            local max_retries=3
            local retry=0
            local http_code=""
            local body=""
            local response=""

            while [ $retry -lt $max_retries ]; do
              response=$(curl -s --max-time 15 -w "\n%{http_code}" \
                -X "$method" \
                -H "Authorization: Bearer $SENTRY_AUTH_TOKEN" \
                -H "Content-Type: application/json" \
                "$url" 2>&1)
              local exit_code=$?

              http_code=$(echo "$response" | tail -n1)
              body=$(echo "$response" | sed '$d')

              if [ "$exit_code" -eq 0 ] && echo "$http_code" | grep -qE '^[0-9]{3}$'; then
                echo "$http_code"
                return 0
              fi

              retry=$((retry + 1))
              if [ $retry -lt $max_retries ]; then
                echo "‚ö†Ô∏è  Retry $retry/$max_retries (curl exit: $exit_code)..." >&2
                sleep $((retry + 1))
              fi
            done

            echo "NETWORK_ERROR"
            return 1
          }

          echo "üîç Verifying Sentry configuration..."
          echo "Organization: $SENTRY_ORG"
          echo "Project: $SENTRY_PROJECT"
          if [ "$DRY_RUN" = "true" ]; then
            echo "Mode: DRY RUN (verification only)"
          fi

          # Token Ï°¥Ïû¨ ÌôïÏù∏
          if [ -z "$SENTRY_AUTH_TOKEN" ]; then
            echo "‚ùå SENTRY_AUTH_TOKEN is not set in GitHub Secrets"
            echo "üí° Create token at: https://sentry.io/settings/account/api/auth-tokens/"
            echo "   Required permissions: project:read, project:releases, org:read"
            exit 1
          fi

          # Token ÌòïÏãù ÌôïÏù∏
          TOKEN_PREFIX="${SENTRY_AUTH_TOKEN:0:15}"
          echo "Token prefix: ${TOKEN_PREFIX}..."
          if [[ ! "$SENTRY_AUTH_TOKEN" =~ ^(sntryu_|sentry-release) ]]; then
            echo "‚ö†Ô∏è  Token format unusual (expected sntryu_ or sentry-release prefix)"
          else
            echo "‚úÖ Token format OK"
          fi

          # API Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
          echo "üîó Testing Sentry API connection..."
          HTTP_CODE=$(sentry_api "https://sentry.io/api/0/projects/$SENTRY_ORG/$SENTRY_PROJECT/")

          case "$HTTP_CODE" in
            200)
              echo "‚úÖ API connection OK, project access verified"

              # Token Í∂åÌïú ÌôïÏù∏ (releases API)
              echo "üîç Checking releases permission..."
              RELEASE_CODE=$(sentry_api "https://sentry.io/api/0/projects/$SENTRY_ORG/$SENTRY_PROJECT/releases/")

              case "$RELEASE_CODE" in
                200|404)
                  echo "‚úÖ Token has 'project:releases' permission"
                  ;;
                403)
                  echo "‚ö†Ô∏è  Token lacks 'project:releases' permission (HTTP 403)"
                  echo "üí° Update token at: https://sentry.io/settings/account/api/auth-tokens/"
                  ;;
                *)
                  echo "‚ö†Ô∏è  Could not verify releases permission ($RELEASE_CODE), continuing..."
                  ;;
              esac
              ;;
            401)
              echo "‚ùå Authentication failed (HTTP 401) - token invalid or expired"
              echo "üí° Create new token at: https://sentry.io/settings/account/api/auth-tokens/"
              exit 1
              ;;
            403)
              echo "‚ùå Access denied (HTTP 403)"
              # Discover accessible orgs for debugging
              echo "üîç Discovering accessible organizations..."
              sentry_api "https://sentry.io/api/0/organizations/" > /dev/null 2>&1
              echo "üí° Check org/project names and token permissions"
              echo "   Current: SENTRY_ORG=$SENTRY_ORG, SENTRY_PROJECT=$SENTRY_PROJECT"
              exit 1
              ;;
            404)
              echo "‚ùå Project not found (HTTP 404)"
              echo "üí° Verify org/project names:"
              echo "   SENTRY_ORG=$SENTRY_ORG"
              echo "   SENTRY_PROJECT=$SENTRY_PROJECT"
              echo "   Dashboard: https://sentry.io/organizations/$SENTRY_ORG/projects/"
              exit 1
              ;;
            NETWORK_ERROR)
              echo "‚ùå Network error connecting to Sentry API after retries"
              echo "üí° Check: https://status.sentry.io/"
              exit 1
              ;;
            *)
              echo "‚ö†Ô∏è  Unexpected response (HTTP $HTTP_CODE), continuing..."
              ;;
          esac

          echo "verified=true" >> $GITHUB_OUTPUT

          # Dry run summary
          if [ "$DRY_RUN" = "true" ]; then
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üìã Dry Run Summary"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "‚úÖ Configuration verified"
            echo "‚úÖ Commit SHA: ${{ github.sha }}"
            echo "‚úÖ Environment: production"
            echo "‚úÖ Sourcemaps: false (Free tier)"
            echo "‚úÖ Ready to create Sentry Release"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          fi

      - name: Check if Release Exists
        id: check_release
        if: github.event.inputs.dry_run != 'true'
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG || 'twodragon' }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT || 'tech-blog' }}
        run: |
          RELEASE_VERSION="${{ github.sha }}"
          echo "üîç Checking if release $RELEASE_VERSION already exists..."

          # Reuse curl-retry pattern
          MAX_RETRIES=3
          RETRY=0
          HTTP_CODE=""

          while [ $RETRY -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s --max-time 15 -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer $SENTRY_AUTH_TOKEN" \
              "https://sentry.io/api/0/projects/$SENTRY_ORG/$SENTRY_PROJECT/releases/$RELEASE_VERSION/" 2>&1)
            EXIT_CODE=$?

            if [ "$EXIT_CODE" -eq 0 ] && echo "$HTTP_CODE" | grep -qE '^[0-9]{3}$'; then
              break
            fi

            RETRY=$((RETRY + 1))
            [ $RETRY -lt $MAX_RETRIES ] && sleep $((RETRY + 1))
          done

          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚ÑπÔ∏è  Release already exists"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Release does not exist, will create"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Sentry Release
        id: create_release
        if: |
          github.event.inputs.dry_run != 'true' &&
          steps.check_release.outputs.exists != 'true'
        continue-on-error: true
        uses: getsentry/action-release@v3
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG || 'twodragon' }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT || 'tech-blog' }}
          SENTRY_LOG_LEVEL: debug
        with:
          environment: production
          version: ${{ github.sha }}
          sourcemaps: false
          set_commits: auto
          ignore_missing: true
          ignore_empty: true
          finalize: true

      - name: Verify Release & Summary
        if: always() && github.event.inputs.dry_run != 'true'
        continue-on-error: true
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG || 'twodragon' }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT || 'tech-blog' }}
        run: |
          RELEASE_VERSION="${{ github.sha }}"

          # Final verification with retry
          MAX_RETRIES=3
          RETRY=0
          HTTP_CODE=""

          while [ $RETRY -lt $MAX_RETRIES ]; do
            sleep $((RETRY + 1))
            HTTP_CODE=$(curl -s --max-time 15 -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer $SENTRY_AUTH_TOKEN" \
              "https://sentry.io/api/0/projects/$SENTRY_ORG/$SENTRY_PROJECT/releases/$RELEASE_VERSION/" 2>&1)
            EXIT_CODE=$?

            if [ "$EXIT_CODE" -eq 0 ] && [ "$HTTP_CODE" = "200" ]; then
              break
            fi

            RETRY=$((RETRY + 1))
          done

          if [ "$HTTP_CODE" = "200" ]; then
            if [ "${{ steps.check_release.outputs.exists }}" = "true" ]; then
              echo "‚ÑπÔ∏è  Sentry Release already existed"
            else
              echo "‚úÖ Sentry Release created successfully"
            fi
            echo "Release: $RELEASE_VERSION"
            echo "Environment: production"
            echo "View: https://sentry.io/organizations/$SENTRY_ORG/releases/$RELEASE_VERSION/"
          else
            echo "‚ö†Ô∏è  Release status: HTTP $HTTP_CODE"
            echo "üí° Free tier limitations may prevent release creation."
            echo "   Sentry error tracking still works without releases."
          fi
