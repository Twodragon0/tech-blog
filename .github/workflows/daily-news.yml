name: Daily Tech News Auto Publish

on:
  schedule:
    # Îß§Ïùº Ïò§Ï†Ñ 10Ïãú KST = UTC 01:00
    - cron: '0 1 * * *'
  
  workflow_dispatch:
    inputs:
      hours:
        description: 'Hours to look back for news'
        required: false
        default: '24'
      dry_run:
        description: 'Dry run (preview only)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      max_news:
        description: 'Maximum news items to include'
        required: false
        default: '10'

env:
  PYTHON_VERSION: '3.11'

jobs:
  collect-and-publish:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install feedparser requests beautifulsoup4 python-frontmatter PyYAML
      
      - name: Create directories
        run: mkdir -p _data _posts assets/images
      
      - name: Collect tech news from RSS
        run: |
          HOURS="${{ github.event.inputs.hours || '24' }}"
          echo "Collecting news from last $HOURS hours..."
          python3 scripts/collect_tech_news.py --hours $HOURS
      
      - name: Check collected news
        id: check_news
        run: |
          if [ -f "_data/collected_news.json" ]; then
            TOTAL=$(python3 -c "import json; d=json.load(open('_data/collected_news.json')); print(d.get('total_items', 0))")
            echo "news_count=$TOTAL" >> $GITHUB_OUTPUT
            echo "Collected $TOTAL news items"
            
            if [ "$TOTAL" -ge 5 ]; then
              echo "has_enough_news=true" >> $GITHUB_OUTPUT
            else
              echo "has_enough_news=false" >> $GITHUB_OUTPUT
              echo "Not enough news to publish (minimum: 5)"
            fi
          else
            echo "news_count=0" >> $GITHUB_OUTPUT
            echo "has_enough_news=false" >> $GITHUB_OUTPUT
            echo "No news collected"
          fi
      
      - name: Auto publish news post
        if: steps.check_news.outputs.has_enough_news == 'true'
        run: |
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          MAX_NEWS="${{ github.event.inputs.max_news || '10' }}"
          HOURS="${{ github.event.inputs.hours || '24' }}"
          
          CMD="python3 scripts/auto_publish_news.py --hours $HOURS --max-news $MAX_NEWS"
          
          if [ "$DRY_RUN" = "true" ]; then
            CMD="$CMD --dry-run"
          fi
          
          echo "Running: $CMD"
          $CMD
      
      - name: Check for new post
        id: check_post
        if: steps.check_news.outputs.has_enough_news == 'true'
        run: |
          TODAY=$(date +%Y-%m-%d)
          POST_FILE="_posts/${TODAY}-Tech_Security_Weekly_Digest.md"
          
          if [ -f "$POST_FILE" ]; then
            echo "post_created=true" >> $GITHUB_OUTPUT
            echo "post_file=$POST_FILE" >> $GITHUB_OUTPUT
            echo "Post created: $POST_FILE"
          else
            echo "post_created=false" >> $GITHUB_OUTPUT
            echo "No post created"
          fi
      
      - name: Commit and push
        if: steps.check_post.outputs.post_created == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          TODAY=$(date +%Y-%m-%d)
          
          git add _posts/*.md assets/images/*.svg _data/collected_news.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "feat: auto publish daily news digest - $TODAY"
            git push
            echo "Changes committed and pushed"
          fi
      
      - name: Summary
        run: |
          echo "## üì∞ Daily News Auto Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "- **News Collected**: ${{ steps.check_news.outputs.news_count }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_post.outputs.post_created }}" = "true" ]; then
            echo "- **Status**: ‚úÖ Post published successfully" >> $GITHUB_STEP_SUMMARY
            echo "- **File**: \`${{ steps.check_post.outputs.post_file }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: ‚è≠Ô∏è Skipped (not enough news or dry run)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Hours lookback: ${{ github.event.inputs.hours || '24' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Max news: ${{ github.event.inputs.max_news || '10' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dry run: ${{ github.event.inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY

  weekly-source-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 1 * * 1'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: pip install feedparser requests
      
      - name: Check RSS feed health
        run: |
          python3 -c "
          import sys
          sys.path.insert(0, 'scripts')
          from collect_tech_news import NEWS_SOURCES
          import feedparser
          
          print('üîç Checking RSS feed status...')
          print('=' * 50)
          
          ok_count = 0
          failed = []
          
          for key, config in NEWS_SOURCES.items():
              feed_url = config.get('feed_url', '')
              if not feed_url:
                  continue
              
              try:
                  feed = feedparser.parse(feed_url)
                  if feed.bozo and not feed.entries:
                      failed.append((key, config['name'], str(feed.bozo_exception)[:50]))
                      print(f'‚ùå {config[\"name\"]}')
                  else:
                      ok_count += 1
                      print(f'‚úÖ {config[\"name\"]} ({len(feed.entries)} entries)')
              except Exception as e:
                  failed.append((key, config['name'], str(e)[:50]))
                  print(f'‚ùå {config[\"name\"]}: {str(e)[:30]}')
          
          print('=' * 50)
          print(f'Summary: {ok_count}/{len(NEWS_SOURCES)} sources OK')
          
          if failed:
              print('\\nFailed sources:')
              for key, name, error in failed:
                  print(f'  - {name}: {error}')
          "
