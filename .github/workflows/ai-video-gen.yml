name: Generate AI Video Lecture

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë§Œ í—ˆìš© (ë¹„ìš© ê´€ë¦¬)
    inputs:
      post_file:
        description: 'í¬ìŠ¤íŠ¸ íŒŒì¼ëª… (ì˜ˆ: 2026-01-10-2026ë…„_DevSecOps_ë¡œë“œë§µ_ì™„ë²½_ê°€ì´ë“œ_roadmap.sh_ë¶„ì„.md)'
        required: false
        type: string
      video_method:
        description: 'ì˜ìƒ ìƒì„± ë°©ë²• (ffmpeg ë˜ëŠ” remotion)'
        required: false
        type: choice
        options:
          - ffmpeg
          - remotion
        default: 'ffmpeg'
  # push ì´ë²¤íŠ¸ëŠ” ì£¼ì„ ì²˜ë¦¬ (ë¹„ìš© ê´€ë¦¬)
  # push:
  #   paths:
  #     - '_posts/**'

jobs:
  generate-audio:
    runs-on: ubuntu-latest
    # ë¹„ìš© ê´€ë¦¬: ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
    continue-on-error: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r scripts/requirements.txt

      - name: Verify API Keys
        env:
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
          ELEVENLABS_VOICE_ID: ${{ secrets.ELEVENLABS_VOICE_ID }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          # API í‚¤ ê²€ì¦ (ë³´ì•ˆ: í‚¤ ê°’ì€ ì¶œë ¥í•˜ì§€ ì•ŠìŒ)
          if [ -z "$ELEVENLABS_API_KEY" ]; then
            echo "âŒ ELEVENLABS_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "GitHub Secretsì— ELEVENLABS_API_KEYë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”."
            echo "ì„¤ì • ë°©ë²•: .github/SECRETS_MANAGEMENT.md ì°¸ê³ "
            exit 1
          fi
          if [ -z "$ELEVENLABS_VOICE_ID" ]; then
            echo "âŒ ELEVENLABS_VOICE_IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "GitHub Secretsì— ELEVENLABS_VOICE_IDë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”."
            echo "ì„¤ì • ë°©ë²•: scripts/ELEVENLABS_PLATFORM_GUIDE.md ì°¸ê³ "
            exit 1
          fi
          if [ -z "$DEEPSEEK_API_KEY" ]; then
            echo "âŒ DEEPSEEK_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "GitHub Secretsì— DEEPSEEK_API_KEYë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”."
            exit 1
          fi
          
          # API í‚¤ í˜•ì‹ ê²€ì¦ (ë³´ì•ˆ ê°•í™”)
          if [[ ! "$ELEVENLABS_API_KEY" =~ ^sk_ ]]; then
            echo "âš ï¸ ELEVENLABS_API_KEY í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (sk_ë¡œ ì‹œìž‘í•´ì•¼ í•¨)"
            exit 1
          fi
          
          echo "âœ… ëª¨ë“  API í‚¤ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "ðŸ”’ ë³´ì•ˆ: API í‚¤ ê°’ì€ ë¡œê·¸ì— ì¶œë ¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."

      - name: Generate Audio from Post
        env:
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
          ELEVENLABS_VOICE_ID: ${{ secrets.ELEVENLABS_VOICE_ID }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          echo "ðŸ’° ë¹„ìš© ê´€ë¦¬: ElevenLabs ë¬´ë£Œ í‹°ì–´ëŠ” ì›” 10,000ìž ì œí•œ"
          echo "ðŸ“Š ì‚¬ìš©ëŸ‰ í™•ì¸: https://elevenlabs.io/app/usage"
          
          if [ -n "${{ github.event.inputs.post_file }}" ]; then
            python3 scripts/generate_audio.py "${{ github.event.inputs.post_file }}"
          else
            python3 scripts/generate_audio.py
          fi
          
          # ìƒì„±ëœ ì˜¤ë””ì˜¤ íŒŒì¼ í¬ê¸° í™•ì¸ (ë¹„ìš© ëª¨ë‹ˆí„°ë§)
          if [ -d "output" ]; then
            echo "ðŸ“¦ ìƒì„±ëœ íŒŒì¼:"
            ls -lh output/*.mp3 2>/dev/null || echo "âš ï¸ ì˜¤ë””ì˜¤ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          fi

      - name: Install FFmpeg
        if: github.event.inputs.video_method == 'ffmpeg' || github.event.inputs.video_method == ''
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Set up Node.js
        if: github.event.inputs.video_method == 'remotion'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: video-generator/package.json

      - name: Install Remotion dependencies
        if: github.event.inputs.video_method == 'remotion'
        run: |
          cd video-generator
          npm install

      - name: Create Video with FFmpeg
        if: github.event.inputs.video_method == 'ffmpeg' || github.event.inputs.video_method == ''
        run: |
          # output ë””ë ‰í† ë¦¬ í™•ì¸
          if [ ! -d "output" ]; then
            echo "âŒ output ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ì˜¤ë””ì˜¤ ìƒì„±ì´ ì‹¤íŒ¨í–ˆì„ ìˆ˜ ìžˆìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          # ìƒì„±ëœ ì˜¤ë””ì˜¤ íŒŒì¼ ì°¾ê¸°
          AUDIO_FILE=$(find output -name "*_audio.mp3" -type f | head -n 1)
          
          if [ -z "$AUDIO_FILE" ]; then
            echo "âŒ ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          echo "ðŸ“¹ ì˜ìƒ ìƒì„± ì¤‘: $AUDIO_FILE"
          
          # ì¸ë„¤ì¼ ì´ë¯¸ì§€ ì°¾ê¸° (í¬ìŠ¤íŠ¸ì˜ image í•„ë“œì—ì„œ ê°€ì ¸ì˜¤ê±°ë‚˜ ê¸°ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©)
          # ê¸°ë³¸ ì´ë¯¸ì§€ëŠ” assets/images ë””ë ‰í† ë¦¬ì—ì„œ ì°¾ê¸°
          THUMBNAIL=$(find assets/images -name "*.png" -o -name "*.jpg" | head -n 1)
          
          if [ -z "$THUMBNAIL" ]; then
            echo "âš ï¸ ì¸ë„¤ì¼ ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."
            # ê°„ë‹¨í•œ ìƒ‰ìƒ ì´ë¯¸ì§€ ìƒì„± (ImageMagickì´ ì„¤ì¹˜ë˜ì–´ ìžˆë‹¤ë©´)
            if command -v convert &> /dev/null; then
              convert -size 1920x1080 xc:#1a1a1a -pointsize 72 -fill white -gravity center \
                -annotate +0+0 "Tech Blog Lecture" output/default_thumbnail.png
              THUMBNAIL="output/default_thumbnail.png"
            else
              echo "âŒ ì¸ë„¤ì¼ ì´ë¯¸ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤. assets/images ë””ë ‰í† ë¦¬ì— ì´ë¯¸ì§€ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ImageMagickì„ ì„¤ì¹˜í•´ì£¼ì„¸ìš”."
              exit 1
            fi
          fi
          
          # ì˜ìƒ íŒŒì¼ëª… ìƒì„±
          VIDEO_FILE="${AUDIO_FILE%.mp3}.mp4"
          
          # FFmpegë¡œ ì˜ìƒ ìƒì„±
          # -loop 1: ì´ë¯¸ì§€ë¥¼ ë°˜ë³µí•˜ì—¬ ì˜¤ë””ì˜¤ ê¸¸ì´ì— ë§žì¶¤
          # -tune stillimage: ì •ì  ì´ë¯¸ì§€ ìµœì í™”
          # -shortest: ì˜¤ë””ì˜¤ ê¸¸ì´ì— ë§žì¶¤
          ffmpeg -loop 1 -i "$THUMBNAIL" -i "$AUDIO_FILE" \
            -c:v libx264 -tune stillimage -c:a aac -b:a 192k \
            -pix_fmt yuv420p -shortest -y "$VIDEO_FILE"
          
          if [ -f "$VIDEO_FILE" ]; then
            echo "âœ… ì˜ìƒ ìƒì„± ì™„ë£Œ: $VIDEO_FILE"
            ls -lh "$VIDEO_FILE"
          else
            echo "âŒ ì˜ìƒ ìƒì„± ì‹¤íŒ¨"
            exit 1
          fi

      - name: Create Video with Remotion
        if: github.event.inputs.video_method == 'remotion'
        run: |
          # output ë””ë ‰í† ë¦¬ í™•ì¸
          if [ ! -d "output" ]; then
            echo "âŒ output ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ì˜¤ë””ì˜¤ ìƒì„±ì´ ì‹¤íŒ¨í–ˆì„ ìˆ˜ ìžˆìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          # ìƒì„±ëœ ì˜¤ë””ì˜¤ íŒŒì¼ ì°¾ê¸°
          AUDIO_FILE=$(find output -name "*_audio.mp3" -type f | head -n 1)
          
          if [ -z "$AUDIO_FILE" ]; then
            echo "âŒ ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          echo "ðŸ“¹ Remotionìœ¼ë¡œ ì˜ìƒ ìƒì„± ì¤‘: $AUDIO_FILE"
          
          # í¬ìŠ¤íŠ¸ íŒŒì¼ ì°¾ê¸°
          if [ -n "${{ github.event.inputs.post_file }}" ]; then
            POST_FILE="_posts/${{ github.event.inputs.post_file }}"
          else
            POST_FILE=$(ls -t _posts/*.md | head -n 1)
          fi
          
          # Python ìŠ¤í¬ë¦½íŠ¸ë¡œ Remotion ì˜ìƒ ìƒì„±
          python3 scripts/generate_video_with_remotion.py "$POST_FILE"
          
          # ìƒì„±ëœ ì˜ìƒ íŒŒì¼ í™•ì¸
          VIDEO_FILE=$(find output -name "*_video.mp4" -type f | head -n 1)
          
          if [ -f "$VIDEO_FILE" ]; then
            echo "âœ… Remotion ì˜ìƒ ìƒì„± ì™„ë£Œ: $VIDEO_FILE"
            ls -lh "$VIDEO_FILE"
          else
            echo "âŒ Remotion ì˜ìƒ ìƒì„± ì‹¤íŒ¨"
            exit 1
          fi

      - name: Upload Video Artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: generated-video
          path: output/*.mp4
          retention-days: 7  # 7ì¼ê°„ ë³´ê´€ (ë¹„ìš© ê´€ë¦¬)

      - name: Upload Audio Artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: generated-audio
          path: output/*.mp3
          retention-days: 7

      - name: Show Summary
        if: always()
        run: |
          echo "## ðŸ“Š ìž‘ì—… ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "output" ]; then
            echo "### ìƒì„±ëœ íŒŒì¼:" >> $GITHUB_STEP_SUMMARY
            ls -lh output/ >> $GITHUB_STEP_SUMMARY || true
          fi
          if [ -f "video_generation_log.txt" ]; then
            echo "### ë¡œê·¸ (ë§ˆì§€ë§‰ 20ì¤„):" >> $GITHUB_STEP_SUMMARY
            tail -n 20 video_generation_log.txt >> $GITHUB_STEP_SUMMARY || true
          fi
