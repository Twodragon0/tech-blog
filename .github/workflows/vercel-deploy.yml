name: Vercel Deploy Notification

# Vercel 배포 알림 및 Sentry Release 생성
# Free 티어 최적화: 프로덕션 배포 시에만 실행

on:
  # Vercel 배포 완료 시 트리거 (Vercel GitHub Integration 필요)
  # 또는 수동 실행
  workflow_dispatch:
    inputs:
      deployment_url:
        description: 'Vercel Deployment URL'
        required: false
      commit_sha:
        description: 'Git Commit SHA'
        required: false

jobs:
  notify-sentry:
    # 프로덕션 배포 시에만 실행
    if: github.ref == 'refs/heads/main'
    
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Get Commit SHA
        id: get_sha
        run: |
          if [ -n "${{ github.event.inputs.commit_sha }}" ]; then
            echo "sha=${{ github.event.inputs.commit_sha }}" >> $GITHUB_OUTPUT
          else
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Sentry Release (Vercel)
        uses: getsentry/action-release@v3
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: twodragon
          SENTRY_PROJECT: tech-blog
        with:
          environment: production
          version: ${{ steps.get_sha.outputs.sha }}
          sourcemaps: false
          set_commits: auto
          ignore_missing: true
      
      - name: Output Deployment Info
        if: success()
        run: |
          echo "✅ Sentry Release created for Vercel deployment"
          echo "Release: ${{ steps.get_sha.outputs.sha }}"
          echo "Deployment URL: ${{ github.event.inputs.deployment_url || 'N/A' }}"
