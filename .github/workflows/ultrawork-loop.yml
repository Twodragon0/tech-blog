name: Ultrawork Loop

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:
    inputs:
      run_post_checks:
        description: "Run post checks"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
      run_image_checks:
        description: "Run image checks"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
      run_link_checks:
        description: "Run link checks"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
      run_vercel_checks:
        description: "Run Vercel checks"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"

concurrency:
  group: ultrawork-loop
  cancel-in-progress: false

jobs:
  ultrawork:
    if: github.event_name != 'schedule' || vars.ULTRAWORK_LOOP_SCHEDULE == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: read

    env:
      RUN_POST_CHECKS: ${{ github.event.inputs.run_post_checks || github.event.client_payload.run_post_checks || 'true' }}
      RUN_IMAGE_CHECKS: ${{ github.event.inputs.run_image_checks || github.event.client_payload.run_image_checks || 'true' }}
      RUN_LINK_CHECKS: ${{ github.event.inputs.run_link_checks || github.event.client_payload.run_link_checks || 'true' }}
      RUN_VERCEL_CHECKS: ${{ github.event.inputs.run_vercel_checks || github.event.client_payload.run_vercel_checks || 'false' }}
      OPENCLAW_GATEWAY_URL: ${{ secrets.OPENCLAW_GATEWAY_URL }}
      OPENCLAW_GATEWAY_TOKEN: ${{ secrets.OPENCLAW_GATEWAY_TOKEN }}
      SLACK_CHANNEL_ID_OPS: ${{ secrets.SLACK_CHANNEL_ID_OPS }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: python -m pip install --upgrade pip pyyaml

      - name: Run ultrawork loop
        id: loop
        run: |
          set -euo pipefail
          message=$(python3 scripts/ultrawork_loop.py || true)
          {
            echo "message<<EOF"
            echo "$message"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Post to Slack via OpenClaw Gateway
        if: env.OPENCLAW_GATEWAY_URL != '' && env.OPENCLAW_GATEWAY_TOKEN != '' && env.SLACK_CHANNEL_ID_OPS != ''
        shell: bash
        env:
          MESSAGE: ${{ steps.loop.outputs.message }}
          TARGET_CHANNEL_ID: ${{ env.SLACK_CHANNEL_ID_OPS }}
        run: |
          set -euo pipefail
          payload=$(python -c 'import json,os; message=os.environ.get("MESSAGE", ""); channel_id=os.environ.get("TARGET_CHANNEL_ID", ""); payload={"tool":"message","action":"send","args":{"channel":"slack","target":f"channel:{channel_id}","message":message}}; print(json.dumps(payload, ensure_ascii=False))')
          curl -sS "${OPENCLAW_GATEWAY_URL}/tools/invoke" \
            -H "Authorization: Bearer ${OPENCLAW_GATEWAY_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$payload"
