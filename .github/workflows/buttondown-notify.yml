name: Buttondown Email Notification

# ìƒˆ í¬ìŠ¤íŠ¸ ë°œí–‰ ì‹œ Buttondownì„ í†µí•´ êµ¬ë…ìì—ê²Œ ì´ë©”ì¼ ë°œì†¡
# ì—…ë°ì´íŠ¸ëœ í¬ìŠ¤íŠ¸ëŠ” ì´ë©”ì¼ ë°œì†¡í•˜ì§€ ì•ŠìŒ (ìƒˆ í¬ìŠ¤íŠ¸ë§Œ ë°œì†¡)
# Free í‹°ì–´ ìµœì í™”: ì¡°ê±´ë¶€ ì‹¤í–‰, íƒ€ì„ì•„ì›ƒ ì„¤ì •

on:
  push:
    branches: [main]
    paths:
      - '_posts/**' # í¬ìŠ¤íŠ¸ ë³€ê²½ ì‹œì—ë§Œ ì‹¤í–‰

concurrency:
  group: buttondown-notify-${{ github.ref }}
  cancel-in-progress: true

jobs:
  notify:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for new posts
        id: check_posts
        run: |
          # Get the list of added posts in this push
          # Use --diff-filter=A to only get added files (not modified)
          # Use -z option for null-terminated strings to handle Unicode filenames correctly
          # Only new posts trigger email notifications (updated posts do not)
          NEW_POSTS=$(git diff --name-only -z --diff-filter=A HEAD~1 HEAD -- '_posts/*.md' 2>/dev/null | tr '\0' '\n' || echo "")
          
          echo "ğŸ” Debug: Checking for new posts..."
          echo "  New posts: ${NEW_POSTS:-none}"
          echo "  Note: Modified posts are excluded from email notifications"
          
          if [ -z "$NEW_POSTS" ]; then
            echo "No new posts found"
            echo "has_new_posts=false" >> $GITHUB_OUTPUT
            echo "posts_json=[]" >> $GITHUB_OUTPUT
            echo "post_count=0" >> $GITHUB_OUTPUT
          else
            echo "New posts found:"
            echo "$NEW_POSTS"
            echo "has_new_posts=true" >> $GITHUB_OUTPUT
            
            # Count posts
            POST_COUNT=$(echo "$NEW_POSTS" | grep -c '^' || echo "0")
            echo "post_count=$POST_COUNT" >> $GITHUB_OUTPUT
            
            # Encode all posts as JSON array (more reliable than multiline)
            # Convert each post path to base64 and store as JSON array
            POSTS_JSON="["
            FIRST=true
            while IFS= read -r post; do
              if [ -n "$post" ]; then
                POST_ENCODED=$(echo -n "$post" | base64 -w 0)
                if [ "$FIRST" = true ]; then
                  POSTS_JSON="$POSTS_JSON\"$POST_ENCODED\""
                  FIRST=false
                else
                  POSTS_JSON="$POSTS_JSON,\"$POST_ENCODED\""
                fi
              fi
            done <<< "$NEW_POSTS"
            POSTS_JSON="$POSTS_JSON]"
            
            # Store as single-line JSON (GitHub Actions output is more reliable this way)
            echo "posts_json=$POSTS_JSON" >> $GITHUB_OUTPUT
            
            echo "Found $POST_COUNT new post(s) to process"
          fi

      - name: Set up Python
        if: steps.check_posts.outputs.has_new_posts == 'true'
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: steps.check_posts.outputs.has_new_posts == 'true'
        run: |
          pip install pyyaml requests

      - name: Send Buttondown Email
        if: steps.check_posts.outputs.has_new_posts == 'true'
        continue-on-error: true
        env:
          BUTTONDOWN_API_KEY: ${{ secrets.BUTTONDOWN_API_KEY }}
          SITE_URL: "https://tech.2twodragon.com"
        run: |
          # ë³´ì•ˆ: API í‚¤ ê²€ì¦
          if [ -z "$BUTTONDOWN_API_KEY" ]; then
            echo "âŒ BUTTONDOWN_API_KEY is not set in GitHub Secrets"
            echo "Please set it in: Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi

          # Python ìŠ¤í¬ë¦½íŠ¸ê°€ ì§ì ‘ git diffë¥¼ ìˆ˜í–‰í•˜ì—¬ í¬ìŠ¤íŠ¸ë¥¼ ê°ì§€
          # ì´ ë°©ë²•ì´ ë” ì•ˆì •ì ì´ê³  í° JSONì„ ë‹¤ë£° ë•Œ ë¬¸ì œê°€ ì—†ìŒ
          echo "ğŸ“§ Processing posts detected by git diff..."
          echo ""

          # Python ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ git diffë¡œ í¬ìŠ¤íŠ¸ ê°ì§€ ë° ì´ë©”ì¼ ë°œì†¡
          python3 scripts/buttondown_notify_batch.py || echo "âš ï¸ Buttondown notification failed (non-critical)"
          
