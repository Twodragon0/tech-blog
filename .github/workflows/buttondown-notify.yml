name: Buttondown Email Notification

# ìƒˆ í¬ìŠ¤íŠ¸ ë°œí–‰ ì‹œ Buttondownì„ í†µí•´ êµ¬ë…ìì—ê²Œ ì´ë©”ì¼ ë°œì†¡
# Free í‹°ì–´ ìµœì í™”: ì¡°ê±´ë¶€ ì‹¤í–‰, íƒ€ì„ì•„ì›ƒ ì„¤ì •

on:
  push:
    branches: [main]
    paths:
      - '_posts/**' # í¬ìŠ¤íŠ¸ ë³€ê²½ ì‹œì—ë§Œ ì‹¤í–‰

jobs:
  notify:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for new posts
        id: check_posts
        run: |
          # Get the list of added posts in this push
          # Use --diff-filter=A to only get added files (not modified)
          # Use -z option for null-terminated strings to handle Unicode filenames correctly
          NEW_POSTS=$(git diff --name-only -z --diff-filter=A HEAD~1 HEAD -- '_posts/*.md' 2>/dev/null | tr '\0' '\n' || echo "")
          
          if [ -z "$NEW_POSTS" ]; then
            echo "No new posts found"
            echo "has_new_posts=false" >> $GITHUB_OUTPUT
          else
            echo "New posts found:"
            echo "$NEW_POSTS"
            echo "has_new_posts=true" >> $GITHUB_OUTPUT
            # Get the most recent new post (first line)
            # Base64 encode to preserve Unicode characters in GitHub Actions output
            LATEST_POST=$(echo "$NEW_POSTS" | head -1 | tr -d '\n')
            LATEST_POST_ENCODED=$(echo -n "$LATEST_POST" | base64 -w 0)
            echo "latest_post_encoded=$LATEST_POST_ENCODED" >> $GITHUB_OUTPUT
            echo "Processing: $LATEST_POST"
          fi

      - name: Set up Python
        if: steps.check_posts.outputs.has_new_posts == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: steps.check_posts.outputs.has_new_posts == 'true'
        run: |
          pip install pyyaml requests

      - name: Send Buttondown Email
        if: steps.check_posts.outputs.has_new_posts == 'true'
        env:
          BUTTONDOWN_API_KEY: ${{ secrets.BUTTONDOWN_API_KEY }}
          SITE_URL: "https://tech.2twodragon.com"
        run: |
          # ë³´ì•ˆ: API í‚¤ ê²€ì¦
          if [ -z "$BUTTONDOWN_API_KEY" ]; then
            echo "âŒ BUTTONDOWN_API_KEY is not set in GitHub Secrets"
            echo "Please set it in: Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi
          
          # íŒŒì¼ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸° ë° ë””ì½”ë”© (base64ë¡œ ì¸ì½”ë”©ëœ í•œê¸€ íŒŒì¼ëª… ì²˜ë¦¬)
          POST_FILE_ENCODED="${{ steps.check_posts.outputs.latest_post_encoded }}"
          if [ -z "$POST_FILE_ENCODED" ]; then
            echo "âŒ No post file specified"
            exit 1
          fi
          
          # Base64 ë””ì½”ë”©
          POST_FILE=$(echo -n "$POST_FILE_ENCODED" | base64 -d)
          
          if [ -z "$POST_FILE" ]; then
            echo "âŒ Failed to decode post file path"
            exit 1
          fi
          
          echo "ğŸ“„ Decoded post file: $POST_FILE"
          
          # íŒŒì¼ ì¡´ì¬ í™•ì¸
          if [ ! -f "$POST_FILE" ]; then
            echo "âš ï¸ Post file not found: $POST_FILE"
            echo "Available files in _posts/:"
            ls -la _posts/ | head -10
            exit 1
          fi
          
          echo "ğŸ“§ Sending email notification for: $POST_FILE"
          python scripts/buttondown_notify.py "$POST_FILE"
