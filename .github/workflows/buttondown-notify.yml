name: Buttondown Email Notification

# ìƒˆ í¬ìŠ¤íŠ¸ ë°œí–‰ ì‹œ Buttondownì„ í†µí•´ êµ¬ë…ìì—ê²Œ ì´ë©”ì¼ ë°œì†¡
# Free í‹°ì–´ ìµœì í™”: ì¡°ê±´ë¶€ ì‹¤í–‰, íƒ€ì„ì•„ì›ƒ ì„¤ì •

on:
  push:
    branches: [main]
    paths:
      - '_posts/**' # í¬ìŠ¤íŠ¸ ë³€ê²½ ì‹œì—ë§Œ ì‹¤í–‰

jobs:
  notify:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for new posts
        id: check_posts
        run: |
          # Get the list of added posts in this push
          # Use --diff-filter=A to only get added files (not modified)
          # Use -z option for null-terminated strings to handle Unicode filenames correctly
          NEW_POSTS=$(git diff --name-only -z --diff-filter=A HEAD~1 HEAD -- '_posts/*.md' 2>/dev/null | tr '\0' '\n' || echo "")
          
          if [ -z "$NEW_POSTS" ]; then
            echo "No new posts found"
            echo "has_new_posts=false" >> $GITHUB_OUTPUT
          else
            echo "New posts found:"
            echo "$NEW_POSTS"
            echo "has_new_posts=true" >> $GITHUB_OUTPUT
            
            # Count posts
            POST_COUNT=$(echo "$NEW_POSTS" | grep -c '^' || echo "0")
            echo "post_count=$POST_COUNT" >> $GITHUB_OUTPUT
            
            # Encode all posts as JSON array (more reliable than multiline)
            # Convert each post path to base64 and store as JSON array
            POSTS_JSON="["
            FIRST=true
            while IFS= read -r post; do
              if [ -n "$post" ]; then
                POST_ENCODED=$(echo -n "$post" | base64 -w 0)
                if [ "$FIRST" = true ]; then
                  POSTS_JSON="$POSTS_JSON\"$POST_ENCODED\""
                  FIRST=false
                else
                  POSTS_JSON="$POSTS_JSON,\"$POST_ENCODED\""
                fi
              fi
            done <<< "$NEW_POSTS"
            POSTS_JSON="$POSTS_JSON]"
            
            # Store as single-line JSON (GitHub Actions output is more reliable this way)
            echo "posts_json=$POSTS_JSON" >> $GITHUB_OUTPUT
            
            echo "Found $POST_COUNT new post(s) to process"
          fi

      - name: Set up Python
        if: steps.check_posts.outputs.has_new_posts == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: steps.check_posts.outputs.has_new_posts == 'true'
        run: |
          pip install pyyaml requests

      - name: Send Buttondown Email
        if: steps.check_posts.outputs.has_new_posts == 'true'
        env:
          BUTTONDOWN_API_KEY: ${{ secrets.BUTTONDOWN_API_KEY }}
          SITE_URL: "https://tech.2twodragon.com"
        run: |
          # ë³´ì•ˆ: API í‚¤ ê²€ì¦
          if [ -z "$BUTTONDOWN_API_KEY" ]; then
            echo "âŒ BUTTONDOWN_API_KEY is not set in GitHub Secrets"
            echo "Please set it in: Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi
          
          # ëª¨ë“  ìƒˆ í¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° (JSON ë°°ì—´ í˜•ì‹)
          POSTS_JSON="${{ steps.check_posts.outputs.posts_json }}"
          POST_COUNT="${{ steps.check_posts.outputs.post_count }}"
          
          if [ -z "$POSTS_JSON" ] || [ "$POSTS_JSON" = "[]" ]; then
            echo "âŒ No post files specified"
            exit 1
          fi
          
          echo "ğŸ“§ Processing $POST_COUNT new post(s)..."
          echo ""
          
          # Python ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ JSON ë°°ì—´ íŒŒì‹± ë° ì²˜ë¦¬
          # ì—¬ëŸ¬ í¬ìŠ¤íŠ¸ë¥¼ í•œ ë²ˆì— ì²˜ë¦¬í•˜ëŠ” ë°°ì¹˜ ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©
          python3 scripts/buttondown_notify_batch.py
          
