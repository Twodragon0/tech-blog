name: Buttondown Email Notification

# ÏÉà Ìè¨Ïä§Ìä∏ Î∞úÌñâ Ïãú ButtondownÏùÑ ÌÜµÌï¥ Íµ¨ÎèÖÏûêÏóêÍ≤å Ïù¥Î©îÏùº Î∞úÏÜ°
# Free Ìã∞Ïñ¥ ÏµúÏ†ÅÌôî: Ï°∞Í±¥Î∂Ä Ïã§Ìñâ, ÌÉÄÏûÑÏïÑÏõÉ ÏÑ§Ï†ï

on:
  push:
    branches: [main]
    paths:
      - '_posts/**' # Ìè¨Ïä§Ìä∏ Î≥ÄÍ≤Ω ÏãúÏóêÎßå Ïã§Ìñâ

jobs:
  notify:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for new posts
        id: check_posts
        run: |
          # Get the list of added posts in this push
          # Use --diff-filter=A to only get added files (not modified)
          NEW_POSTS=$(git diff --name-only --diff-filter=A HEAD~1 HEAD -- '_posts/*.md' 2>/dev/null || echo "")
          
          if [ -z "$NEW_POSTS" ]; then
            echo "No new posts found"
            echo "has_new_posts=false" >> $GITHUB_OUTPUT
          else
            echo "New posts found:"
            echo "$NEW_POSTS"
            echo "has_new_posts=true" >> $GITHUB_OUTPUT
            # Get the most recent new post (first line)
            LATEST_POST=$(echo "$NEW_POSTS" | head -1 | tr -d '\n')
            echo "latest_post=$LATEST_POST" >> $GITHUB_OUTPUT
            echo "Processing: $LATEST_POST"
          fi

      - name: Set up Python
        if: steps.check_posts.outputs.has_new_posts == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: steps.check_posts.outputs.has_new_posts == 'true'
        run: |
          pip install pyyaml requests

      - name: Send Buttondown Email
        if: steps.check_posts.outputs.has_new_posts == 'true'
        env:
          BUTTONDOWN_API_KEY: ${{ secrets.BUTTONDOWN_API_KEY }}
          SITE_URL: "https://tech.2twodragon.com"
        run: |
          # Î≥¥Ïïà: API ÌÇ§ Í≤ÄÏ¶ù
          if [ -z "$BUTTONDOWN_API_KEY" ]; then
            echo "‚ùå BUTTONDOWN_API_KEY is not set in GitHub Secrets"
            echo "Please set it in: Settings ‚Üí Secrets and variables ‚Üí Actions"
            exit 1
          fi
          
          # ÌååÏùº Í≤ΩÎ°ú Í∞ÄÏ†∏Ïò§Í∏∞ Î∞è Í≤ÄÏ¶ù
          POST_FILE="${{ steps.check_posts.outputs.latest_post }}"
          if [ -z "$POST_FILE" ]; then
            echo "‚ùå No post file specified"
            exit 1
          fi
          
          # ÌååÏùº Ï°¥Ïû¨ ÌôïÏù∏
          if [ ! -f "$POST_FILE" ]; then
            echo "‚ö†Ô∏è Post file not found: $POST_FILE"
            echo "Available files in _posts/:"
            ls -la _posts/ | head -10
            exit 1
          fi
          
          echo "üìß Sending email notification for: $POST_FILE"
          python scripts/buttondown_notify.py "$POST_FILE"
