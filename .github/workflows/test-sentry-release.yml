name: Test Sentry Release

# Sentry Release ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸ìš©
# ì‹¤ì œ Release ìƒì„± ì—†ì´ ê²€ì¦ë§Œ ìˆ˜í–‰

on:
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë§Œ

jobs:
  test-sentry-config:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Verify Sentry Token
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: twodragon
          SENTRY_PROJECT: tech-blog
        run: |
          echo "ğŸ” Testing Sentry Configuration..."
          
          # Token ì¡´ì¬ í™•ì¸
          if [ -z "$SENTRY_AUTH_TOKEN" ]; then
            echo "âŒ SENTRY_AUTH_TOKEN is not set in GitHub Secrets"
            exit 1
          fi
          
          echo "âœ… SENTRY_AUTH_TOKEN is set"
          
          # Token í˜•ì‹ í™•ì¸ (sntryu_ë¡œ ì‹œì‘í•˜ëŠ”ì§€)
          if [[ ! "$SENTRY_AUTH_TOKEN" =~ ^sntryu_ ]]; then
            echo "âš ï¸  Warning: Token format may be incorrect (should start with 'sntryu_')"
          else
            echo "âœ… Token format is correct"
          fi
          
          # Sentry API ì—°ê²° í…ŒìŠ¤íŠ¸ (ì½ê¸° ì „ìš©)
          echo "ğŸ”— Testing Sentry API connection..."
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $SENTRY_AUTH_TOKEN" \
            -H "Content-Type: application/json" \
            "https://sentry.io/api/0/projects/$SENTRY_ORG/$SENTRY_PROJECT/")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Successfully connected to Sentry API"
            echo "ğŸ“Š Project info retrieved"
          elif [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "403" ]; then
            echo "âŒ Authentication failed (HTTP $HTTP_CODE)"
            echo "   Please check:"
            echo "   1. Token is correct"
            echo "   2. Token has 'project:releases' permission"
            echo "   3. Organization and project names are correct"
            exit 1
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "âŒ Project not found (HTTP $HTTP_CODE)"
            echo "   Please check:"
            echo "   1. Organization name: $SENTRY_ORG"
            echo "   2. Project name: $SENTRY_PROJECT"
            exit 1
          else
            echo "âš ï¸  Unexpected response (HTTP $HTTP_CODE)"
            echo "   Response: $BODY"
          fi
      
      - name: Verify Release Configuration
        run: |
          echo "ğŸ” Verifying Release configuration..."
          
          # ì»¤ë°‹ SHA í™•ì¸
          COMMIT_SHA="${{ github.sha }}"
          if [ -z "$COMMIT_SHA" ]; then
            echo "âŒ Cannot get commit SHA"
            exit 1
          fi
          
          echo "âœ… Commit SHA: $COMMIT_SHA"
          echo "âœ… Release version will be: tech-blog@${COMMIT_SHA:0:7}"
          echo "âœ… Environment: production"
          echo "âœ… Sourcemaps: false (Free tier optimization)"
          echo "âœ… Set commits: auto"
      
      - name: Test Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Test Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… Configuration verified"
          echo "âœ… Ready to create Sentry Release"
          echo ""
          echo "Next steps:"
          echo "1. Run the 'Sentry Release' workflow"
          echo "2. Check Sentry dashboard for new release"
          echo "3. Verify commit information is linked"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
