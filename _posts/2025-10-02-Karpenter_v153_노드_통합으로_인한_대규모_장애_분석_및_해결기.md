---
layout: post
title: "Karpenter v1.5.3 ë…¸ë“œ í†µí•©ìœ¼ë¡œ ì¸í•œ ëŒ€ê·œëª¨ ì¥ì•  ë¶„ì„ ë° í•´ê²°ê¸°"
date: 2025-10-02 17:25:43 +0900
category: incident
tags: [Karpenter, Kubernetes, AWS, Post-Mortem, Incident, EKS]
excerpt: "Karpenter v1.5.3ì˜ ê³µê²©ì ì¸ ë…¸ë“œ í†µí•©(Consolidation) ì •ì±…ê³¼ PodDisruptionBudget ë¯¸ì„¤ì •ìœ¼ë¡œ ì¸í•´ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ 20ê°œ ì´ìƒì˜ Podê°€ ë™ì‹œì— ì¬ì‹œì‘ë˜ë©° ì•½ 10ë¶„ê°„ ì„œë¹„ìŠ¤ ì¥ì• ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì´ ê¸€ì—ì„œëŠ” ì¥ì• ì˜ ê·¼ë³¸ ì›ì¸ ë¶„ì„ë¶€í„° í•´ê²° ë°©ì•ˆê¹Œì§€ ìƒì„¸íˆ ë‹¤ë£¹ë‹ˆë‹¤."
comments: true
toc: true
original_url: https://twodragon.tistory.com/695
image: /assets/images/2025-10-02-Karpenter_v153_ë…¸ë“œ_í†µí•©ìœ¼ë¡œ_ì¸í•œ_ëŒ€ê·œëª¨_ì¥ì• _ë¶„ì„_ë°_í•´ê²°ê¸°.svg
---

## ğŸ“‹ í¬ìŠ¤íŒ… ìš”ì•½

> **ì œëª©**: Karpenter v1.5.3 ë…¸ë“œ í†µí•©ìœ¼ë¡œ ì¸í•œ ëŒ€ê·œëª¨ ì¥ì•  ë¶„ì„ ë° í•´ê²°ê¸°
>
> **ì¹´í…Œê³ ë¦¬**: incident
>
> **íƒœê·¸**: Karpenter, Kubernetes, AWS, Post-Mortem, Incident, EKS
>
> **í•µì‹¬ ë‚´ìš©**: Karpenter v1.5.3ì˜ ê³µê²©ì ì¸ ë…¸ë“œ í†µí•©(Consolidation) ì •ì±…(WhenEmptyOrUnderutilized, 30ì´ˆ íƒ€ì´ë¨¸, 100% ë…¸ë“œ ì‚­ì œ í—ˆìš©)ê³¼ PodDisruptionBudget ë¯¸ì„¤ì •ìœ¼ë¡œ ì•½ 10ë¶„ê°„ ì„œë¹„ìŠ¤ ì¥ì•  ë°œìƒ. í•´ê²°ì±…ìœ¼ë¡œ NodePool ì„¤ì • ì™„í™”(WhenEmpty, 5ë¶„ ëŒ€ê¸°, 20% ì œí•œ), PDB ì ìš©, Pod Anti-Affinity ì„¤ì •, Prometheus/Datadog ëª¨ë‹ˆí„°ë§ ì•Œë¦¼ ì¶”ê°€ë¥¼ ë‹¤ë£¹ë‹ˆë‹¤.
>
> ---
>
> *ì´ í¬ìŠ¤íŒ…ì€ AI(Cursor, Claude ë“±)ê°€ ì‰½ê²Œ ì´í•´í•˜ê³  í™œìš©í•  ìˆ˜ ìˆë„ë¡ êµ¬ì¡°í™”ëœ ìš”ì•½ì„ í¬í•¨í•©ë‹ˆë‹¤.*


Karpenter v1.5.3ì˜ ê³µê²©ì ì¸ ë…¸ë“œ í†µí•©(Consolidation) ì •ì±…ê³¼ PodDisruptionBudget ë¯¸ì„¤ì •ìœ¼ë¡œ ì¸í•´ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ 20ê°œ ì´ìƒì˜ Podê°€ ë™ì‹œì— ì¬ì‹œì‘ë˜ë©° **ì•½ 10ë¶„ê°„ ì„œë¹„ìŠ¤ ì¥ì• **ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì´ ê¸€ì—ì„œëŠ” ì¥ì• ì˜ ê·¼ë³¸ ì›ì¸ ë¶„ì„ë¶€í„° í•´ê²° ë°©ì•ˆê¹Œì§€ ìƒì„¸íˆ ë‹¤ë£¹ë‹ˆë‹¤.

## 1. ì‚¬ê±´ì˜ ì‹œì‘

### 1.1 íƒ€ì„ë¼ì¸

| ì‹œê°„ | ì´ë²¤íŠ¸ |
|------|--------|
| 15:43:00 | Karpenterê°€ ë…¸ë“œ í†µí•© ì‹œì‘ |
| 15:43:15 | Node `ip-10-0-1-234` ë“œë ˆì¸ ì‹œì‘ |
| 15:43:20 | 20+ Pod ë™ì‹œ Terminating |
| 15:43:30 | API Gateway health check ì‹¤íŒ¨ ì•Œë¦¼ |
| 15:44:00 | ì„œë¹„ìŠ¤ ì „ì²´ ì¥ì•  ì¸ì§€ |
| 15:45:00 | ê¸´ê¸‰ ëŒ€ì‘ ì‹œì‘ |
| 15:50:00 | ìˆ˜ë™ ë…¸ë“œ ì¶”ê°€ |
| 15:53:00 | ì„œë¹„ìŠ¤ ë³µêµ¬ ì™„ë£Œ |
| 15:55:00 | ì¥ì•  ê³µì§€ ë°œì†¡ |

### 1.2 ìµœì´ˆ ì•Œë¦¼

```
[CRITICAL] API Gateway health-check failed
Time: 2025-10-02 15:43:30 KST
Service: api-gateway
Status: 0/3 healthy endpoints
Duration: ongoing
```

## 2. ê·¼ë³¸ ì›ì¸ ë¶„ì„

### 2.1 Karpenter ë…¸ë“œ í†µí•©ì´ë€?

KarpenterëŠ” í´ëŸ¬ìŠ¤í„° ë¹„ìš© ìµœì í™”ë¥¼ ìœ„í•´ **ë…¸ë“œ í†µí•©(Consolidation)** ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤. ì´ëŠ” ì—¬ëŸ¬ ë…¸ë“œì— ë¶„ì‚°ëœ Podë¥¼ ë” ì ì€ ìˆ˜ì˜ ë…¸ë“œë¡œ ëª¨ì•„ ë¹ˆ ë…¸ë“œë¥¼ ì‚­ì œí•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

```
Before Consolidation:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node 1 â”‚ â”‚ Node 2 â”‚ â”‚ Node 3 â”‚
â”‚ [Pod][Pod] â”‚ â”‚ [Pod] â”‚ â”‚ [Pod] â”‚
â”‚ CPU: 30% â”‚ â”‚ CPU: 15% â”‚ â”‚ CPU: 20% â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

After Consolidation:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node 1 â”‚ â”‚ (deleted) â”‚
â”‚ [Pod][Pod] â”‚ â”‚ â”‚
â”‚ [Pod][Pod] â”‚ â”‚ â”‚
â”‚ CPU: 65% â”‚ â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ë¬¸ì œì˜ NodePool ì„¤ì •

```yaml
# ë¬¸ì œê°€ ëœ NodePool ì„¤ì •
apiVersion: karpenter.sh/v1
kind: NodePool
metadata:
 name: default
spec:
 template:
 spec:
 nodeClassRef:
 group: karpenter.k8s.aws
 kind: EC2NodeClass
 name: default
 disruption:
 consolidationPolicy: WhenEmptyOrUnderutilized # ë„ˆë¬´ ê³µê²©ì 
 consolidateAfter: 30s # 30ì´ˆ í›„ ë°”ë¡œ í†µí•© ì‹œë„
 budgets:
 - nodes: "100%" # ëª¨ë“  ë…¸ë“œ ë™ì‹œ ì‚­ì œ ê°€ëŠ¥!
```

### 2.3 PDB ë¯¸ì„¤ì • ë¬¸ì œ

```yaml
# PodDisruptionBudgetì´ ì—†ì—ˆìŒ
# ê²°ê³¼: ëª¨ë“  Podê°€ ë™ì‹œì— ì¢…ë£Œë  ìˆ˜ ìˆìŒ

# ìˆì–´ì•¼ í–ˆë˜ ì„¤ì •:
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
 name: api-gateway-pdb
spec:
 minAvailable: 2 # ë˜ëŠ” maxUnavailable: 1
 selector:
 matchLabels:
 app: api-gateway
```

## 3. ì¥ì•  ë°œìƒ ê³¼ì • ìƒì„¸

### 3.1 ì´ë²¤íŠ¸ ë¡œê·¸ ë¶„ì„

```bash
# Karpenter ë¡œê·¸ í™•ì¸
kubectl logs -n karpenter deploy/karpenter -c controller --since=1h | grep -i consolidat

# ì¶œë ¥ (ì¬êµ¬ì„±)
15:43:00 INFO controller.disruption Computing consolidation candidates
15:43:05 INFO controller.disruption Found 3 consolidatable nodes
15:43:10 INFO controller.disruption Disrupting node ip-10-0-1-234 for consolidation
15:43:10 INFO controller.disruption Disrupting node ip-10-0-2-156 for consolidation
15:43:15 INFO controller.node Draining node ip-10-0-1-234
15:43:15 INFO controller.node Draining node ip-10-0-2-156
```

### 3.2 Pod ì´ë²¤íŠ¸

```bash
kubectl get events --field-selector reason=Killing -A

NAMESPACE LAST SEEN TYPE REASON OBJECT MESSAGE
prod 10m Warning Killing pod/api-gateway-abc12 Stopping container...
prod 10m Warning Killing pod/api-gateway-def34 Stopping container...
prod 10m Warning Killing pod/order-service-xyz Stopping container...
# ... 20ê°œ ì´ìƒì˜ Podê°€ ë™ì‹œì— ì¢…ë£Œë¨
```

### 3.3 ì˜í–¥ ë²”ìœ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Impact Analysis â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”‚
â”‚ Affected Services: â”‚
â”‚ â”œâ”€â”€ api-gateway (3/3 pods down) â”€â”€â–º ì „ì²´ API ë¶ˆê°€ â”‚
â”‚ â”œâ”€â”€ order-service (2/2 pods down) â”€â”€â–º ì£¼ë¬¸ ì²˜ë¦¬ ë¶ˆê°€ â”‚
â”‚ â”œâ”€â”€ payment-service (2/2 pods down) â”€â”€â–º ê²°ì œ ì‹¤íŒ¨ â”‚
â”‚ â””â”€â”€ notification (1/1 pod down) â”€â”€â–º ì•Œë¦¼ ë°œì†¡ ì§€ì—° â”‚
â”‚ â”‚
â”‚ Business Impact: â”‚
â”‚ â”œâ”€â”€ Failed API calls: ~15,000 â”‚
â”‚ â”œâ”€â”€ Failed orders: ~200 â”‚
â”‚ â”œâ”€â”€ Estimated revenue loss: ~2,000,000 KRW â”‚
â”‚ â””â”€â”€ Customer complaints: 50+ â”‚
â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 4. ê¸´ê¸‰ ëŒ€ì‘

### 4.1 ì¦‰ì‹œ ì¡°ì¹˜ ì‚¬í•­

```bash
# 1. Karpenter ë¹„í™œì„±í™” (ê¸´ê¸‰)
kubectl scale deployment karpenter -n karpenter --replicas=0

# 2. ìˆ˜ë™ìœ¼ë¡œ ë…¸ë“œ ì¶”ê°€
eksctl scale nodegroup --cluster=prod-cluster \
 --name=workers --nodes=5 --nodes-min=5

# 3. ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
kubectl get pods -n prod -o wide
kubectl get nodes

# 4. Pod ì¬ì‹œì‘ ê°•ì œ
kubectl rollout restart deployment -n prod
```

### 4.2 ì„œë¹„ìŠ¤ ë³µêµ¬ í™•ì¸

```bash
# Health check í™•ì¸
for svc in api-gateway order-service payment-service; do
 echo "=== $svc ==="
 kubectl get pods -n prod -l app=$svc
 kubectl exec -n prod deploy/$svc -- curl -s localhost:8080/health
done
```

## 5. ì˜êµ¬ì  í•´ê²°ì±…

### 5.1 NodePool ì„¤ì • ìˆ˜ì •

```yaml
# ìˆ˜ì •ëœ NodePool ì„¤ì •
apiVersion: karpenter.sh/v1
kind: NodePool
metadata:
 name: default
spec:
 template:
 spec:
 nodeClassRef:
 group: karpenter.k8s.aws
 kind: EC2NodeClass
 name: default
 requirements:
 - key: karpenter.sh/capacity-type
 operator: In
 values: ["on-demand", "spot"]
 - key: kubernetes.io/arch
 operator: In
 values: ["amd64"]
 disruption:
 consolidationPolicy: WhenEmpty # ë¹ˆ ë…¸ë“œë§Œ ì‚­ì œ
 consolidateAfter: 5m # 5ë¶„ ëŒ€ê¸°
 budgets:
 - nodes: "20%" # ìµœëŒ€ 20%ì˜ ë…¸ë“œë§Œ ë™ì‹œ ì‚­ì œ
 - nodes: "0"
 schedule: "0 9-18 * * 1-5" # ì—…ë¬´ ì‹œê°„ì—ëŠ” ì‚­ì œ ê¸ˆì§€
 duration: 9h
```

### 5.2 PodDisruptionBudget ì ìš©

```yaml
# Critical ì„œë¹„ìŠ¤ìš© PDB
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
 name: api-gateway-pdb
 namespace: prod
spec:
 minAvailable: 2
 selector:
 matchLabels:
 app: api-gateway
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
 name: order-service-pdb
 namespace: prod
spec:
 maxUnavailable: 1
 selector:
 matchLabels:
 app: order-service
---
# ì „ì²´ critical ì„œë¹„ìŠ¤ì— PDB ì¼ê´„ ì ìš© ìŠ¤í¬ë¦½íŠ¸
# deploy-pdbs.sh
for app in api-gateway order-service payment-service notification; do
 cat <<EOF | kubectl apply -f -
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
 name: ${app}-pdb
 namespace: prod
spec:
 maxUnavailable: 1
 selector:
 matchLabels:
 app: ${app}
EOF
done
```

### 5.3 Pod Anti-Affinity ì„¤ì •

```yaml
# ê°™ì€ ì„œë¹„ìŠ¤ì˜ Podë¥¼ ë‹¤ë¥¸ ë…¸ë“œì— ë¶„ì‚°
apiVersion: apps/v1
kind: Deployment
metadata:
 name: api-gateway
spec:
 replicas: 3
 template:
 spec:
 affinity:
 podAntiAffinity:
 requiredDuringSchedulingIgnoredDuringExecution:
 - labelSelector:
 matchLabels:
 app: api-gateway
 topologyKey: kubernetes.io/hostname
 topologySpreadConstraints:
 - maxSkew: 1
 topologyKey: topology.kubernetes.io/zone
 whenUnsatisfiable: DoNotSchedule
 labelSelector:
 matchLabels:
 app: api-gateway
```

## 6. ëª¨ë‹ˆí„°ë§ ê°•í™”

### 6.1 Karpenter ì•Œë¦¼ ì„¤ì •

```yaml
# Prometheus Alert Rules
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
 name: karpenter-alerts
spec:
 groups:
 - name: karpenter
 rules:
 - alert: KarpenterHighDisruptionRate
 expr: |
 sum(rate(karpenter_nodes_terminated_total[5m])) > 2
 for: 2m
 labels:
 severity: warning
 annotations:
 summary: "Karpenter is terminating nodes rapidly"
 description: "{{ $value }} nodes terminated in last 5 minutes"

 - alert: KarpenterConsolidationActive
 expr: |
 karpenter_disruption_actions_performed_total{action="consolidate"} > 0
 for: 0m
 labels:
 severity: info
 annotations:
 summary: "Karpenter consolidation in progress"
```

### 6.2 Datadog ëŒ€ì‹œë³´ë“œ

```yaml
# Datadog Monitor
{
 "name": "[Karpenter] Node Disruption Alert",
 "type": "metric alert",
 "query": "sum(last_5m):sum:karpenter.nodes.terminated{*} > 3",
 "message": "Karpenterê°€ 5ë¶„ ë‚´ 3ê°œ ì´ìƒì˜ ë…¸ë“œë¥¼ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.\n\n@slack-platform-alerts",
 "tags": ["karpenter", "kubernetes", "critical"],
 "priority": 2,
 "options": {
 "thresholds": {
 "critical": 3,
 "warning": 2
 }
 }
}
```

## 7. ì¬ë°œ ë°©ì§€ ì²´í¬ë¦¬ìŠ¤íŠ¸

| í•­ëª© | ìƒíƒœ | ë‹´ë‹¹ì |
|------|------|--------|
| NodePool consolidation ì •ì±… ì™„í™” | âœ… | Platform |
| ì—…ë¬´ì‹œê°„ disruption ê¸ˆì§€ ì„¤ì • | âœ… | Platform |
| ëª¨ë“  Critical ì„œë¹„ìŠ¤ PDB ì ìš© | âœ… | DevOps |
| Pod Anti-Affinity ì„¤ì • | âœ… | DevOps |
| Karpenter ëª¨ë‹ˆí„°ë§ ì•Œë¦¼ ì¶”ê°€ | âœ… | SRE |
| ëŸ°ë¶ ì—…ë°ì´íŠ¸ | âœ… | SRE |
| íŒ€ ê³µìœ  ë° êµìœ¡ | âœ… | All |

## 8. êµí›ˆ (Lessons Learned)

### 8.1 ê¸°ìˆ ì  êµí›ˆ

1. **ê¸°ë³¸ê°’ì„ ì‹ ë¢°í•˜ì§€ ë§ ê²ƒ**: Karpenterì˜ ê¸°ë³¸ consolidation ì •ì±…ì€ í”„ë¡œë•ì…˜ì— ë„ˆë¬´ ê³µê²©ì 
2. **PDBëŠ” í•„ìˆ˜**: Critical ì„œë¹„ìŠ¤ëŠ” ë°˜ë“œì‹œ PodDisruptionBudget ì„¤ì •
3. **ì ì§„ì  ì ìš©**: ìƒˆë¡œìš´ ë„êµ¬ëŠ” ìŠ¤í…Œì´ì§•ì—ì„œ ì¶©ë¶„íˆ í…ŒìŠ¤íŠ¸ í›„ ì ìš©
4. **ê°€ì‹œì„± í™•ë³´**: ì¸í”„ë¼ ë³€ê²½ ë„êµ¬ëŠ” ë°˜ë“œì‹œ ëª¨ë‹ˆí„°ë§ê³¼ ì•Œë¦¼ ì„¤ì •

### 8.2 í”„ë¡œì„¸ìŠ¤ êµí›ˆ

1. **ë³€ê²½ ê´€ë¦¬ ê°•í™”**: Karpenter ì„¤ì • ë³€ê²½ ì‹œ Change Advisory Board ê²€í†  í•„ìˆ˜
2. **ëŸ°ë¶ ì‚¬ì „ ì¤€ë¹„**: "Karpenter ê¸´ê¸‰ ë¹„í™œì„±í™”" ëŸ°ë¶ ì‚¬ì „ ì‘ì„±
3. **ì •ê¸°ì  DR í›ˆë ¨**: ì¸í”„ë¼ ì¥ì•  ì‹œë‚˜ë¦¬ì˜¤ í›ˆë ¨ ë¶„ê¸°ë³„ ì‹¤ì‹œ

## 9. ë§ˆë¬´ë¦¬

ì´ë²ˆ ì¥ì• ë¥¼ í†µí•´ **Kubernetes ì˜¤í† ìŠ¤ì¼€ì¼ëŸ¬ì˜ ìœ„í—˜ì„±**ê³¼ **PDBì˜ ì¤‘ìš”ì„±**ì„ ë‹¤ì‹œ í•œë²ˆ ê¹¨ë‹¬ì•˜ìŠµë‹ˆë‹¤. ë¹„ìš© ìµœì í™”ë„ ì¤‘ìš”í•˜ì§€ë§Œ, ì„œë¹„ìŠ¤ ì•ˆì •ì„±ì´ í•­ìƒ ìš°ì„ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

> "Move fast and break things" ëŠ” í”„ë¡œë•ì…˜ì—ì„œëŠ” ê¸ˆë¬¼ì…ë‹ˆë‹¤.

---

ğŸ“š **ì°¸ê³  ìë£Œ:**
- [Karpenter Disruption ê³µì‹ ë¬¸ì„œ](https://karpenter.sh/docs/concepts/disruption/)
- [Kubernetes PDB Best Practices](https://kubernetes.io/docs/tasks/run-application/configure-pdb/)
- [AWS EKS Best Practices](https://aws.github.io/aws-eks-best-practices/)
