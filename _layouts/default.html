<!DOCTYPE html>
<html lang="{{ site.lang | default: 'ko' }}">
{% include head.html %}
{% include error-handler.html %}
<body>
  {% include header.html %}

  <main id="main-content" class="main-content" role="main">
    <div class="container">
      {{ content }}
    </div>
  </main>

  {% include footer.html %}
  {% include subscribe-float.html %}
  {% include chat-widget.html %}
  <!-- Chat widget is loaded on-demand when user interacts -->
  <script>
    // Lazy load chat widget script only when user interacts
    (function() {
      'use strict';
      let chatWidgetLoaded = false;
      const chatToggle = document.getElementById('chat-widget-toggle');
      
      function loadChatWidget() {
        if (chatWidgetLoaded) return;
        chatWidgetLoaded = true;

        const script = document.createElement('script');
        script.src = "{{ "/assets/js/chat-widget.js" | relative_url }}";
        script.defer = true;
        script.onload = function() {
          // Auto-toggle chat on first click (script just loaded)
          if (chatToggle) chatToggle.click();
        };
        script.onerror = function() {
          console.error('[Chat Widget] Failed to load script');
          chatWidgetLoaded = false;
        };
        document.body.appendChild(script);
      }
      
      // Load on toggle click or after 3 seconds (if user is still on page)
      if (chatToggle) {
        chatToggle.addEventListener('click', loadChatWidget, { once: true, passive: true });
        
        // Also load after 3 seconds if user hasn't left (non-blocking)
        setTimeout(function() {
          if (document.visibilityState === 'visible' && !chatWidgetLoaded) {
            if (typeof requestIdleCallback !== 'undefined') {
              requestIdleCallback(loadChatWidget, { timeout: 2000 });
            } else {
              setTimeout(loadChatWidget, 0);
            }
          }
        }, 3000);
      }
    })();
  </script>
</body>
</html>
