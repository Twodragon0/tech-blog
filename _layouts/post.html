---
layout: default
---
<div class="reading-progress" id="reading-progress"></div>

<article class="post-article" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    {% comment %} 모바일 최적화: 카테고리 → 제목 → 메타 → 이미지 순서로 표시 {% endcomment %}
    {% if page.category %}
    <div class="post-category">
      <a href="{{ '/categories/' | relative_url }}#{{ page.category | downcase }}" class="category-badge {{ page.category | downcase }}">
        {{ page.category }}
      </a>
    </div>
    {% elsif page.categories.first %}
    <div class="post-category">
      <a href="{{ '/categories/' | relative_url }}#{{ page.categories.first | downcase | replace: ' ', '-' }}" class="category-badge {{ page.categories.first | downcase | replace: ' ', '-' }}">
        {{ page.categories.first }}
      </a>
    </div>
    {% endif %}

    <h1 class="post-title" itemprop="name headline">{{ page.title | escape }}</h1>

    <div class="post-meta">
      <span class="meta-item">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
          <line x1="16" y1="2" x2="16" y2="6"/>
          <line x1="8" y1="2" x2="8" y2="6"/>
          <line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
        <time class="dt-published" datetime="{{ page.date | date_to_xmlschema }}" itemprop="datePublished">
          {{ page.date | date: "%Y. %m. %d" }}
        </time>
      </span>

      <span class="meta-item">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
        <span id="reading-time"></span>
      </span>

      <span class="meta-item" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
          <circle cx="12" cy="7" r="4"/>
        </svg>
        <span itemprop="name">{{ site.author.name }}</span>
      </span>

      {% if page.last_modified_at %}
      <span class="meta-item meta-updated" title="Last Updated">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M23 4v6h-6"/>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
        </svg>
        <time class="dt-updated" datetime="{{ page.last_modified_at | date_to_xmlschema }}" itemprop="dateModified">
          {{ page.last_modified_at | date: "%Y. %m. %d" }}
        </time>
      </span>
      {% endif %}
    </div>

    {% if page.tags.size > 0 %}
    <div class="post-tags">
      {% for tag in page.tags %}
      <a href="{{ '/tags/' | relative_url }}#{{ tag | append: '' | slugify }}" class="tag">{{ tag }}</a>
      {% endfor %}
    </div>
    {% endif %}

    {% comment %} 포스트 이미지: 메타 정보 아래에 표시 {% endcomment %}
    {% if page.image %}
    <div class="post-image">
      {% assign image_path = page.image | relative_url %}
      {% if page.image_alt %}
        {% assign image_alt_text = page.image_alt | escape %}
      {% else %}
        {% assign image_alt_text = page.title | escape %}
      {% endif %}
      <img src="{{ image_path }}" alt="{{ image_alt_text }}" class="clickable-image" data-full-src="{{ image_path }}" data-original-src="{{ page.image }}" loading="eager" decoding="async" fetchpriority="high" width="1200" height="675" style="width:100%; height:auto; border-radius:8px; margin-bottom: 20px; cursor: zoom-in; aspect-ratio: 16/9; object-fit: cover;" onerror="this.style.display='none';" sizes="(max-width: 768px) 100vw, 1200px">
    </div>
    {% endif %}
  </header>

  {% if page.audio_file %}
    {% include audio-player.html audio_url=page.audio_file %}
  {% endif %}

  {% if page.toc %}
  {% include toc.html content=content %}
  {% endif %}

  {% comment %} TOC 아래 광고 - 긴 글에서만 표시 {% endcomment %}
  {% assign word_count = content | number_of_words %}
  {% if word_count > 500 and site.google_adsense %}
  {% include adsense.html type="in-article" %}
  {% endif %}

  <div class="post-content" itemprop="articleBody">
    {{ content }}
  </div>

  {% comment %} 콘텐츠 하단 광고 {% endcomment %}
  {% if site.google_adsense %}
  {% include adsense.html type="multiplex" %}
  {% endif %}

  <footer class="post-footer">
    {% include share-buttons.html %}
  </footer>

  {% assign posts = site.posts | where_exp: "post", "post.url != page.url" %}
  {% if page.category %}
    {% assign related = posts | where: "category", page.category | limit: 3 %}
  {% elsif page.categories.first %}
    {% assign cat = page.categories.first %}
    {% assign related = posts | where_exp: "post", "post.categories contains cat" | limit: 3 %}
  {% else %}
    {% assign related = posts | limit: 3 %}
  {% endif %}

  {% comment %} 관련 포스트 위 광고 {% endcomment %}
  {% if site.google_adsense %}
  {% include adsense.html type="footer" %}
  {% endif %}

  {% if related.size > 0 %}
  <section class="related-posts-section" aria-labelledby="related-posts-heading">
    <div class="related-posts-header">
      <div class="related-posts-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
          <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
          <line x1="8" y1="6" x2="16" y2="6" opacity="0.5"/>
          <line x1="8" y1="10" x2="16" y2="10" opacity="0.5"/>
          <line x1="8" y1="14" x2="12" y2="14" opacity="0.5"/>
        </svg>
      </div>
      <div class="related-posts-title-wrapper">
        <h3 id="related-posts-heading">Continue Reading</h3>
        <p class="related-posts-subtitle">이 글과 관련된 포스트를 확인해보세요</p>
      </div>
      <div class="related-posts-count">{{ related.size }}개의 관련 글</div>
    </div>
    <div class="related-posts-grid">
      {% for post in related limit: 3 %}
      <article class="related-post-card" data-category="{{ post.category | default: post.categories.first | default: 'blog' | downcase }}">
        <a href="{{ post.url | relative_url }}" class="related-post-link" aria-label="Read: {{ post.title | escape }}">
          <div class="related-post-header">
            <span class="related-post-category">{{ post.category | default: post.categories.first | default: "Blog" }}</span>
            <span class="related-post-number">{{ forloop.index | prepend: '0' | slice: -2, 2 }}</span>
          </div>
          <div class="related-post-body">
            <h4 class="related-post-title">{{ post.title | escape }}</h4>
            {% if post.excerpt %}
            <p class="related-post-excerpt">{{ post.excerpt | strip_html | truncate: 100 }}</p>
            {% endif %}
          </div>
          <div class="related-post-footer">
            <time class="related-post-date" datetime="{{ post.date | date_to_xmlschema }}">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
              {{ post.date | date: "%Y. %m. %d" }}
            </time>
            <span class="related-post-cta">
              <span>Read more</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="5" y1="12" x2="19" y2="12"/>
                <polyline points="12 5 19 12 12 19"/>
              </svg>
            </span>
          </div>
        </a>
      </article>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  {% include giscus.html %}
</article>

<script>
// Auto-generate IDs for headings (runs immediately for TOC to work)
(function() {
  'use strict';
  
    // Generate safe ID from text (handles Korean and special characters)
    // Matches kramdown's auto_id format as closely as possible
    function generateId(text) {
      if (!text) return '';
      
      // Security: Use textContent instead of innerHTML to prevent XSS
      // Remove HTML tags if any by parsing safely
      const tempDiv = document.createElement('div');
      // Security: Only set textContent, not innerHTML, to prevent XSS
      tempDiv.textContent = text;
      text = tempDiv.textContent || text;
    
    // Remove anchor links if present
    text = text.replace(/<a[^>]*>.*?<\/a>/gi, '');
    
    // Trim and normalize whitespace
    text = text.trim().replace(/\s+/g, ' ');
    
    // Convert to lowercase
    let id = text.toLowerCase();
    
    // Replace spaces with hyphens (kramdown style)
    id = id.replace(/\s+/g, '-');
    
    // Remove special characters but keep alphanumeric, Korean, and hyphens
    // Korean Unicode ranges: \uAC00-\uD7A3 (Hangul syllables), \u3131-\u318E (Hangul Jamo)
    id = id.replace(/[^\w\uAC00-\uD7A3\u3131-\u318E-]/g, '');
    
    // Remove consecutive hyphens
    id = id.replace(/-+/g, '-');
    
    // Remove leading/trailing hyphens
    id = id.replace(/^-+|-+$/g, '');
    
    // If empty, use fallback
    if (!id) {
      id = 'heading';
    }
    
    // If starts with number, add prefix (HTML ID cannot start with number)
    if (/^\d/.test(id)) {
      id = 'heading-' + id;
    }
    
    // Ensure uniqueness
    let uniqueId = id;
    let counter = 1;
    while (document.getElementById(uniqueId)) {
      uniqueId = id + '-' + counter;
      counter++;
    }
    
    return uniqueId;
  }
  
  // Generate IDs for all headings in post content
  function generateHeadingIds() {
    const postContent = document.querySelector('.post-content');
    if (!postContent) return;
    
    const headings = postContent.querySelectorAll('h1, h2, h3, h4, h5, h6');
    
    headings.forEach(heading => {
      // Skip if already has an ID
      if (heading.id) return;
      
      // Get text content excluding any existing anchor links
      let text = '';
      const children = Array.from(heading.childNodes);
      children.forEach(node => {
        if (node.nodeType === Node.TEXT_NODE) {
          text += node.textContent;
        } else if (node.nodeType === Node.ELEMENT_NODE && !node.classList.contains('heading-anchor')) {
          text += node.textContent || node.innerText || '';
        }
      });
      
      // Fallback to textContent if no text found
      if (!text.trim()) {
        text = heading.textContent || heading.innerText || '';
      }
      
      const id = generateId(text);
      
      if (id) {
        heading.id = id;
        
        // Add anchor link icon for better UX
        if (!heading.querySelector('.heading-anchor')) {
          const anchor = document.createElement('a');
          anchor.className = 'heading-anchor';
          anchor.href = '#' + id;
          anchor.setAttribute('aria-label', 'Permalink to ' + text.trim());
          anchor.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>';
          
          // Insert anchor at the beginning
          heading.insertBefore(anchor, heading.firstChild);
        }
      }
    });
  }
  
  // Run immediately when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', generateHeadingIds);
  } else {
    generateHeadingIds();
  }
})();

// Reading time calculation (deferred to idle time)
(function() {
  'use strict';
  
  // Use requestIdleCallback for non-critical work
  const scheduleIdleWork = (callback, timeout = 2000) => {
    if ('requestIdleCallback' in window) {
      requestIdleCallback(callback, { timeout });
    } else {
      setTimeout(callback, 0);
    }
  };
  
  scheduleIdleWork(() => {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initReadingTime);
    } else {
      initReadingTime();
    }
  });
  
  function initReadingTime() {
    const content = document.querySelector('.post-content');
    if (content) {
      const text = content.textContent || content.innerText;
      const wordCount = text.trim().split(/\s+/).length;
      const readingTime = Math.ceil(wordCount / 200);
      const readingTimeEl = document.getElementById('reading-time');
      if (readingTimeEl) {
        readingTimeEl.textContent = readingTime + ' min read';
      }
    }

    // Enhance external links in post content (non-critical)
    scheduleIdleWork(enhanceExternalLinks, 3000);
  }
})();

// Function to enhance external links with icons and attributes
function enhanceExternalLinks() {
  const postContent = document.querySelector('.post-content');
  if (!postContent) return;

  const links = postContent.querySelectorAll('a[href]');
  const currentHost = window.location.hostname;
  const currentProtocol = window.location.protocol;

  links.forEach(link => {
    const href = link.getAttribute('href');
    if (!href) return;

    // Skip if already processed or is a special link
    if (link.classList.contains('external-link-processed') || 
        href.startsWith('#') || 
        href.startsWith('mailto:') || 
        href.startsWith('tel:')) {
      return;
    }

    // Check if it's an external link
    const isExternal = (href.startsWith('http://') || href.startsWith('https://')) &&
                       !href.includes(currentHost) &&
                       !link.hasAttribute('target');

    // Check if it's an internal link that should open in new tab
    const shouldOpenNewTab = link.hasAttribute('target') && 
                             link.getAttribute('target') === '_blank';

    if (isExternal || shouldOpenNewTab) {
      // Add external link attributes for security
      if (!link.hasAttribute('target')) {
        link.setAttribute('target', '_blank');
      }
      if (!link.hasAttribute('rel')) {
        link.setAttribute('rel', 'noopener noreferrer');
      }

      // Add aria-label for accessibility
      const linkText = link.textContent.trim();
      if (!link.hasAttribute('aria-label')) {
        link.setAttribute('aria-label', `${linkText} (새 창에서 열림)`);
      }

      // Add class for styling
      link.classList.add('external-link', 'external-link-processed');

      // Add title attribute if not present
      if (!link.hasAttribute('title')) {
        link.setAttribute('title', '새 창에서 열림');
      }
    }
  });
}

// Reading progress bar
window.addEventListener('scroll', function() {
  const article = document.querySelector('.post-article');
  const progressBar = document.getElementById('reading-progress');
  if (article && progressBar) {
    const articleTop = article.offsetTop;
    const articleHeight = article.offsetHeight;
    const windowHeight = window.innerHeight;
    const scrollY = window.scrollY;
    const progress = Math.min(Math.max((scrollY - articleTop + windowHeight * 0.3) / articleHeight * 100, 0), 100);
    progressBar.style.width = progress + '%';
  }
});

// Giscus loading state management
document.addEventListener('DOMContentLoaded', function() {
  const giscusContainer = document.getElementById('giscus-container');
  const giscusLoading = document.getElementById('giscus-loading');
  
  if (giscusContainer && giscusLoading) {
    // Giscus가 로드되면 로딩 인디케이터 숨기기
    const observer = new MutationObserver(function(mutations) {
      const giscusFrame = giscusContainer.querySelector('iframe');
      if (giscusFrame && giscusFrame.contentDocument) {
        giscusLoading.classList.add('hidden');
        observer.disconnect();
      }
    });

    observer.observe(giscusContainer, {
      childList: true,
      subtree: true
    });

    // 최대 대기 시간 설정 (10초 후 자동으로 로딩 인디케이터 숨기기)
    setTimeout(function() {
      if (!giscusLoading.classList.contains('hidden')) {
        giscusLoading.classList.add('hidden');
      }
    }, 10000);

    // Giscus 스크립트 로드 확인
    const giscusScript = document.querySelector('script[src*="giscus.app"]');
    if (giscusScript) {
      giscusScript.addEventListener('load', function() {
        // 스크립트 로드 후 짧은 지연을 두고 확인
        setTimeout(function() {
          const giscusFrame = giscusContainer.querySelector('iframe');
          if (giscusFrame) {
            giscusLoading.classList.add('hidden');
          }
        }, 2000);
      });
    }
  }
});

// Image Lightbox functionality - Enhanced UI/UX
(function() {
  const style = document.createElement('style');
  style.textContent = `
    .image-lightbox {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.35s;
    }
    
    .image-lightbox.active {
      opacity: 1;
      visibility: visible;
    }
    
    .lightbox-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(0,0,0,0.95) 0%, rgba(15,15,25,0.98) 100%);
      cursor: pointer;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    
    .lightbox-content {
      position: relative;
      width: 98vw;
      height: 98vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 1rem;
      box-sizing: border-box;
    }
    
    .lightbox-image-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 1;
      width: 100%;
      min-height: 0;
      overflow: hidden;
    }
    
    .lightbox-image {
      max-width: 100%;
      max-height: calc(98vh - 120px);
      width: auto;
      height: auto;
      object-fit: contain;
      border-radius: 12px;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6), 0 10px 30px rgba(0, 0, 0, 0.4);
      cursor: grab;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
      transform-origin: center center;
      user-select: none;
      -webkit-user-drag: none;
    }
    
    .lightbox-image.zoomed {
      cursor: move;
      max-width: none;
      max-height: none;
    }
    
    .lightbox-image.dragging {
      cursor: grabbing;
      transition: none;
    }
    
    .image-lightbox.active .lightbox-image {
      animation: lightbox-zoom-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    
    @keyframes lightbox-zoom-in {
      from { transform: scale(0.85); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    .lightbox-caption {
      margin-top: 1.25rem;
      padding: 0.875rem 1.5rem;
      color: rgba(255, 255, 255, 0.95);
      font-size: 0.95rem;
      text-align: center;
      max-width: 90%;
      word-break: break-word;
      line-height: 1.6;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .lightbox-controls {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      gap: 0.5rem;
      z-index: 10001;
    }
    
    .lightbox-btn {
      width: 44px;
      height: 44px;
      border: none;
      background: rgba(255, 255, 255, 0.12);
      color: #ffffff;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
    
    .lightbox-btn:hover {
      background: rgba(255, 255, 255, 0.22);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }
    
    .lightbox-btn:active {
      transform: translateY(0) scale(0.95);
    }
    
    .lightbox-btn svg {
      width: 22px;
      height: 22px;
    }
    
    .lightbox-btn.active {
      background: rgba(99, 102, 241, 0.5);
      border-color: rgba(99, 102, 241, 0.6);
    }
    
    .lightbox-zoom-info {
      position: absolute;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      padding: 0.5rem 1rem;
      background: rgba(0, 0, 0, 0.7);
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.8rem;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    
    .lightbox-zoom-info.visible {
      opacity: 1;
    }
    
    .lightbox-hint {
      position: absolute;
      bottom: 4rem;
      left: 50%;
      transform: translateX(-50%);
      padding: 0.625rem 1.25rem;
      background: rgba(99, 102, 241, 0.2);
      color: rgba(255, 255, 255, 0.85);
      font-size: 0.8rem;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(99, 102, 241, 0.3);
      opacity: 0;
      transition: opacity 0.5s ease;
      pointer-events: none;
    }
    
    .lightbox-hint.visible {
      animation: hint-fade 3s ease-in-out forwards;
    }
    
    @keyframes hint-fade {
      0% { opacity: 0; }
      10% { opacity: 1; }
      80% { opacity: 1; }
      100% { opacity: 0; }
    }
    
    @media (max-width: 768px) {
      .lightbox-content {
        padding: 0.5rem;
      }
      
      .lightbox-image {
        max-height: calc(98vh - 100px);
        border-radius: 8px;
      }
      
      .lightbox-controls {
        top: 0.5rem;
        right: 0.5rem;
        gap: 0.375rem;
      }
      
      .lightbox-btn {
        width: 40px;
        height: 40px;
        border-radius: 10px;
      }
      
      .lightbox-btn svg {
        width: 20px;
        height: 20px;
      }
      
      .lightbox-caption {
        font-size: 0.875rem;
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        max-width: 95%;
      }
      
      .lightbox-hint {
        bottom: 3rem;
        font-size: 0.75rem;
      }
    }
    
    @media (hover: none) {
      .lightbox-btn:hover {
        transform: none;
        box-shadow: none;
      }
    }
  `;
  document.head.appendChild(style);

  const lightbox = document.createElement('div');
  lightbox.id = 'image-lightbox';
  lightbox.className = 'image-lightbox';
  lightbox.innerHTML = `
    <div class="lightbox-backdrop"></div>
    <div class="lightbox-content">
      <div class="lightbox-controls">
        <button class="lightbox-btn lightbox-zoom-out" aria-label="축소" title="축소 (-)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"/>
            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            <line x1="8" y1="11" x2="14" y2="11"/>
          </svg>
        </button>
        <button class="lightbox-btn lightbox-zoom-in" aria-label="확대" title="확대 (+)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"/>
            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            <line x1="11" y1="8" x2="11" y2="14"/>
            <line x1="8" y1="11" x2="14" y2="11"/>
          </svg>
        </button>
        <button class="lightbox-btn lightbox-reset" aria-label="원래 크기" title="원래 크기 (0)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 3 21 3 21 9"/>
            <polyline points="9 21 3 21 3 15"/>
            <line x1="21" y1="3" x2="14" y2="10"/>
            <line x1="3" y1="21" x2="10" y2="14"/>
          </svg>
        </button>
        <button class="lightbox-btn lightbox-close" aria-label="닫기" title="닫기 (ESC)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="lightbox-image-wrapper">
        <img class="lightbox-image" src="" alt="">
      </div>
      <div class="lightbox-caption"></div>
      <div class="lightbox-zoom-info"></div>
      <div class="lightbox-hint">더블클릭 또는 휠로 확대/축소</div>
    </div>
  `;
  document.body.appendChild(lightbox);

  const lightboxImage = lightbox.querySelector('.lightbox-image');
  const lightboxCaption = lightbox.querySelector('.lightbox-caption');
  const lightboxClose = lightbox.querySelector('.lightbox-close');
  const lightboxBackdrop = lightbox.querySelector('.lightbox-backdrop');
  const lightboxContent = lightbox.querySelector('.lightbox-content');
  const lightboxZoomIn = lightbox.querySelector('.lightbox-zoom-in');
  const lightboxZoomOut = lightbox.querySelector('.lightbox-zoom-out');
  const lightboxReset = lightbox.querySelector('.lightbox-reset');
  const lightboxZoomInfo = lightbox.querySelector('.lightbox-zoom-info');
  const lightboxHint = lightbox.querySelector('.lightbox-hint');
  const lightboxWrapper = lightbox.querySelector('.lightbox-image-wrapper');

  let currentZoom = 1;
  let isDragging = false;
  let startX = 0, startY = 0;
  let translateX = 0, translateY = 0;
  let lastTranslateX = 0, lastTranslateY = 0;
  let zoomInfoTimeout = null;

  function updateTransform() {
    lightboxImage.style.transform = `scale(${currentZoom}) translate(${translateX / currentZoom}px, ${translateY / currentZoom}px)`;
  }

  function showZoomInfo() {
    lightboxZoomInfo.textContent = `${Math.round(currentZoom * 100)}%`;
    lightboxZoomInfo.classList.add('visible');
    clearTimeout(zoomInfoTimeout);
    zoomInfoTimeout = setTimeout(() => lightboxZoomInfo.classList.remove('visible'), 1500);
  }

  function zoom(delta, centerX, centerY) {
    const oldZoom = currentZoom;
    currentZoom = Math.max(0.5, Math.min(5, currentZoom + delta));
    
    if (currentZoom !== oldZoom) {
      if (currentZoom > 1) {
        lightboxImage.classList.add('zoomed');
      } else {
        lightboxImage.classList.remove('zoomed');
        translateX = 0;
        translateY = 0;
      }
      updateTransform();
      showZoomInfo();
    }
  }

  function resetZoom() {
    currentZoom = 1;
    translateX = 0;
    translateY = 0;
    lightboxImage.classList.remove('zoomed');
    updateTransform();
    showZoomInfo();
  }

  function openLightbox(img) {
    let src = img.dataset.fullSrc || img.src;
    const alt = img.alt || '';

    if (!src) return;

    try {
      const decodedSrc = decodeURIComponent(src);
      if (decodedSrc !== src && /[가-힣]/.test(decodedSrc)) {
        src = decodedSrc;
      }
    } catch (e) {}

    currentZoom = 1;
    translateX = 0;
    translateY = 0;
    lightboxImage.classList.remove('zoomed', 'dragging');
    lightboxImage.style.transform = '';
    lightboxImage.style.opacity = '0';
    lightboxImage.style.display = 'block';
    lightboxImage.style.visibility = 'visible';
    
    lightboxCaption.style.color = 'rgba(255, 255, 255, 0.95)';
    lightboxCaption.textContent = alt;

    lightbox.classList.add('active');
    document.body.style.overflow = 'hidden';

    setTimeout(() => {
      lightboxHint.classList.add('visible');
      setTimeout(() => lightboxHint.classList.remove('visible'), 3000);
    }, 500);

    const handleImageLoad = () => {
      lightboxImage.style.opacity = '1';
    };

    const handleImageError = () => {
      lightboxImage.style.opacity = '0.5';
      lightboxCaption.textContent = alt ? `${alt} (이미지를 불러올 수 없습니다)` : '이미지를 불러올 수 없습니다';
      lightboxCaption.style.color = '#ff6b6b';
    };

    lightboxImage.onload = null;
    lightboxImage.onerror = null;
    
    const preloadImage = new Image();
    let retryCount = 0;
    const originalSrc = img.dataset.fullSrc || img.src;
    
    const tryLoadImage = (imageSrc) => {
      preloadImage.onload = () => {
        lightboxImage.src = imageSrc;
        lightboxImage.alt = alt;
        lightboxImage.onload = handleImageLoad;
        lightboxImage.onerror = handleImageError;
        if (lightboxImage.complete && lightboxImage.naturalHeight !== 0) {
          handleImageLoad();
        }
      };
      
      preloadImage.onerror = () => {
        retryCount++;
        if (retryCount === 1 && imageSrc !== originalSrc) {
          tryLoadImage(originalSrc);
        } else {
          handleImageError();
        }
      };
      
      preloadImage.src = imageSrc;
    };
    
    tryLoadImage(src);
  }

  function closeLightbox() {
    lightbox.classList.remove('active');
    document.body.style.overflow = '';
    lightboxHint.classList.remove('visible');
    setTimeout(() => {
      if (!lightbox.classList.contains('active')) {
        lightboxImage.src = '';
        lightboxImage.onload = null;
        lightboxImage.onerror = null;
        resetZoom();
      }
    }, 350);
  }

  function attachImageHandlers() {
    const images = document.querySelectorAll('.clickable-image, .post-content img, .post-image img');
    images.forEach(img => {
      if (img.dataset.lightboxAttached === 'true') return;
      
      img.style.cursor = 'zoom-in';
      img.dataset.lightboxAttached = 'true';
      img.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        openLightbox(this);
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attachImageHandlers);
  } else {
    attachImageHandlers();
  }
  setTimeout(attachImageHandlers, 500);

  lightboxBackdrop.addEventListener('click', (e) => {
    if (e.target === lightboxBackdrop) closeLightbox();
  });

  lightboxClose.addEventListener('click', (e) => {
    e.stopPropagation();
    closeLightbox();
  });

  lightboxZoomIn.addEventListener('click', (e) => {
    e.stopPropagation();
    zoom(0.25);
  });

  lightboxZoomOut.addEventListener('click', (e) => {
    e.stopPropagation();
    zoom(-0.25);
  });

  lightboxReset.addEventListener('click', (e) => {
    e.stopPropagation();
    resetZoom();
  });

  lightboxImage.addEventListener('dblclick', (e) => {
    e.stopPropagation();
    if (currentZoom > 1) {
      resetZoom();
    } else {
      zoom(1);
    }
  });

  lightboxWrapper.addEventListener('wheel', (e) => {
    if (!lightbox.classList.contains('active')) return;
    e.preventDefault();
    const delta = e.deltaY > 0 ? -0.15 : 0.15;
    zoom(delta);
  }, { passive: false });

  lightboxImage.addEventListener('mousedown', (e) => {
    if (currentZoom <= 1) return;
    e.preventDefault();
    isDragging = true;
    startX = e.clientX;
    startY = e.clientY;
    lastTranslateX = translateX;
    lastTranslateY = translateY;
    lightboxImage.classList.add('dragging');
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    translateX = lastTranslateX + (e.clientX - startX);
    translateY = lastTranslateY + (e.clientY - startY);
    updateTransform();
  });

  document.addEventListener('mouseup', () => {
    if (isDragging) {
      isDragging = false;
      lightboxImage.classList.remove('dragging');
    }
  });

  let touchStartDistance = 0;
  let initialZoom = 1;

  lightboxImage.addEventListener('touchstart', (e) => {
    if (e.touches.length === 2) {
      touchStartDistance = Math.hypot(
        e.touches[0].clientX - e.touches[1].clientX,
        e.touches[0].clientY - e.touches[1].clientY
      );
      initialZoom = currentZoom;
    } else if (e.touches.length === 1 && currentZoom > 1) {
      isDragging = true;
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
      lastTranslateX = translateX;
      lastTranslateY = translateY;
    }
  }, { passive: true });

  lightboxImage.addEventListener('touchmove', (e) => {
    if (e.touches.length === 2) {
      const distance = Math.hypot(
        e.touches[0].clientX - e.touches[1].clientX,
        e.touches[0].clientY - e.touches[1].clientY
      );
      const scale = distance / touchStartDistance;
      currentZoom = Math.max(0.5, Math.min(5, initialZoom * scale));
      if (currentZoom > 1) {
        lightboxImage.classList.add('zoomed');
      } else {
        lightboxImage.classList.remove('zoomed');
      }
      updateTransform();
    } else if (isDragging && e.touches.length === 1) {
      translateX = lastTranslateX + (e.touches[0].clientX - startX);
      translateY = lastTranslateY + (e.touches[0].clientY - startY);
      updateTransform();
    }
  }, { passive: true });

  lightboxImage.addEventListener('touchend', () => {
    isDragging = false;
    if (currentZoom <= 1) {
      translateX = 0;
      translateY = 0;
      updateTransform();
    }
    showZoomInfo();
  });

  document.addEventListener('keydown', (e) => {
    if (!lightbox.classList.contains('active')) return;

    switch(e.key) {
      case 'Escape': closeLightbox(); break;
      case '+': case '=': zoom(0.25); break;
      case '-': zoom(-0.25); break;
      case '0': resetZoom(); break;
    }
  });

  lightboxContent.addEventListener('click', (e) => {
    if (e.target === lightboxContent || e.target === lightboxWrapper) {
      closeLightbox();
    }
  });
})();
</script>

{% include mermaid.html %}
