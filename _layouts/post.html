---
layout: default
---
<div class="reading-progress" id="reading-progress"></div>

<article class="post-article" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    {% if page.image %}
    <div class="post-image">
      {% assign image_path = page.image | relative_url %}
      {% comment %} 한글 파일명이 포함된 경우 URL 인코딩 보장 {% endcomment %}
      {% if page.image_alt %}
        {% assign image_alt_text = page.image_alt | escape %}
      {% else %}
        {% assign image_alt_text = page.title | escape %}
      {% endif %}
      <img src="{{ image_path }}" alt="{{ image_alt_text }}" class="clickable-image" data-full-src="{{ image_path }}" data-original-src="{{ page.image }}" loading="eager" decoding="async" fetchpriority="high" width="1200" height="675" style="width:100%; height:auto; border-radius:8px; margin-bottom: 20px; cursor: zoom-in; aspect-ratio: 16/9; object-fit: cover;" onerror="this.style.display='none';" sizes="(max-width: 768px) 100vw, 1200px">
    </div>
    {% endif %}

    {% if page.category %}
    <div class="post-category">
      <a href="{{ '/categories/' | relative_url }}#{{ page.category | downcase }}" class="category-badge {{ page.category | downcase }}">
        {{ page.category }}
      </a>
    </div>
    {% elsif page.categories.first %}
    <div class="post-category">
      <a href="{{ '/categories/' | relative_url }}#{{ page.categories.first | downcase | replace: ' ', '-' }}" class="category-badge {{ page.categories.first | downcase | replace: ' ', '-' }}">
        {{ page.categories.first }}
      </a>
    </div>
    {% endif %}

    <h1 class="post-title" itemprop="name headline">{{ page.title | escape }}</h1>

    <div class="post-meta">
      <span class="meta-item">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
          <line x1="16" y1="2" x2="16" y2="6"/>
          <line x1="8" y1="2" x2="8" y2="6"/>
          <line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
        <time class="dt-published" datetime="{{ page.date | date_to_xmlschema }}" itemprop="datePublished">
          {{ page.date | date: "%Y. %m. %d" }}
        </time>
      </span>

      <span class="meta-item">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
        <span id="reading-time"></span>
      </span>

      <span class="meta-item" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
          <circle cx="12" cy="7" r="4"/>
        </svg>
        <span itemprop="name">{{ site.author.name }}</span>
      </span>

      {% if page.last_modified_at %}
      <span class="meta-item meta-updated" title="Last Updated">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M23 4v6h-6"/>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
        </svg>
        <time class="dt-updated" datetime="{{ page.last_modified_at | date_to_xmlschema }}" itemprop="dateModified">
          {{ page.last_modified_at | date: "%Y. %m. %d" }}
        </time>
      </span>
      {% endif %}
    </div>

    {% if page.tags.size > 0 %}
    <div class="post-tags">
      {% for tag in page.tags %}
      <a href="{{ '/tags/' | relative_url }}#{{ tag | append: '' | slugify }}" class="tag">{{ tag }}</a>
      {% endfor %}
    </div>
    {% endif %}
  </header>

  {% if page.audio_file %}
    {% include audio-player.html audio_url=page.audio_file %}
  {% endif %}

  {% if page.toc %}
  {% include toc.html content=content %}
  {% endif %}

  <div class="post-content" itemprop="articleBody">
    {{ content }}
  </div>

  <footer class="post-footer">
    {% include share-buttons.html %}
  </footer>

  {% assign posts = site.posts | where_exp: "post", "post.url != page.url" %}
  {% if page.category %}
    {% assign related = posts | where: "category", page.category | limit: 3 %}
  {% elsif page.categories.first %}
    {% assign cat = page.categories.first %}
    {% assign related = posts | where_exp: "post", "post.categories contains cat" | limit: 3 %}
  {% else %}
    {% assign related = posts | limit: 3 %}
  {% endif %}

  {% if related.size > 0 %}
  <section class="related-posts">
    <div class="related-header">
      <h3>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
          <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
        </svg>
        Related Posts
      </h3>
    </div>
    <div class="related-grid">
      {% for post in related limit: 3 %}
      <a href="{{ post.url | relative_url }}" class="related-item">
        <div class="related-content">
          <span class="related-category">{{ post.category | default: post.categories.first | default: "Blog" }}</span>
          <h4>{{ post.title | escape }}</h4>
          {% if post.excerpt %}
          <p class="related-excerpt">{{ post.excerpt | strip_html | truncate: 80 }}</p>
          {% endif %}
        </div>
        <div class="related-meta">
          <span class="related-date">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            {{ post.date | date: "%Y. %m. %d" }}
          </span>
          <span class="related-arrow">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"></line>
              <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
          </span>
        </div>
      </a>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  {% include giscus.html %}
</article>

<script>
// Auto-generate IDs for headings (runs immediately for TOC to work)
(function() {
  'use strict';
  
  // Generate safe ID from text (handles Korean and special characters)
  // Matches kramdown's auto_id format as closely as possible
  function generateId(text) {
    if (!text) return '';
    
    // Remove HTML tags if any
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = text;
    text = tempDiv.textContent || tempDiv.innerText || text;
    
    // Remove anchor links if present
    text = text.replace(/<a[^>]*>.*?<\/a>/gi, '');
    
    // Trim and normalize whitespace
    text = text.trim().replace(/\s+/g, ' ');
    
    // Convert to lowercase
    let id = text.toLowerCase();
    
    // Replace spaces with hyphens (kramdown style)
    id = id.replace(/\s+/g, '-');
    
    // Remove special characters but keep alphanumeric, Korean, and hyphens
    // Korean Unicode ranges: \uAC00-\uD7A3 (Hangul syllables), \u3131-\u318E (Hangul Jamo)
    id = id.replace(/[^\w\uAC00-\uD7A3\u3131-\u318E-]/g, '');
    
    // Remove consecutive hyphens
    id = id.replace(/-+/g, '-');
    
    // Remove leading/trailing hyphens
    id = id.replace(/^-+|-+$/g, '');
    
    // If empty, use fallback
    if (!id) {
      id = 'heading';
    }
    
    // If starts with number, add prefix (HTML ID cannot start with number)
    if (/^\d/.test(id)) {
      id = 'heading-' + id;
    }
    
    // Ensure uniqueness
    let uniqueId = id;
    let counter = 1;
    while (document.getElementById(uniqueId)) {
      uniqueId = id + '-' + counter;
      counter++;
    }
    
    return uniqueId;
  }
  
  // Generate IDs for all headings in post content
  function generateHeadingIds() {
    const postContent = document.querySelector('.post-content');
    if (!postContent) return;
    
    const headings = postContent.querySelectorAll('h1, h2, h3, h4, h5, h6');
    
    headings.forEach(heading => {
      // Skip if already has an ID
      if (heading.id) return;
      
      // Get text content excluding any existing anchor links
      let text = '';
      const children = Array.from(heading.childNodes);
      children.forEach(node => {
        if (node.nodeType === Node.TEXT_NODE) {
          text += node.textContent;
        } else if (node.nodeType === Node.ELEMENT_NODE && !node.classList.contains('heading-anchor')) {
          text += node.textContent || node.innerText || '';
        }
      });
      
      // Fallback to textContent if no text found
      if (!text.trim()) {
        text = heading.textContent || heading.innerText || '';
      }
      
      const id = generateId(text);
      
      if (id) {
        heading.id = id;
        
        // Add anchor link icon for better UX
        if (!heading.querySelector('.heading-anchor')) {
          const anchor = document.createElement('a');
          anchor.className = 'heading-anchor';
          anchor.href = '#' + id;
          anchor.setAttribute('aria-label', 'Permalink to ' + text.trim());
          anchor.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>';
          
          // Insert anchor at the beginning
          heading.insertBefore(anchor, heading.firstChild);
        }
      }
    });
  }
  
  // Run immediately when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', generateHeadingIds);
  } else {
    generateHeadingIds();
  }
})();

// Reading time calculation (deferred to idle time)
(function() {
  'use strict';
  
  // Use requestIdleCallback for non-critical work
  const scheduleIdleWork = (callback, timeout = 2000) => {
    if ('requestIdleCallback' in window) {
      requestIdleCallback(callback, { timeout });
    } else {
      setTimeout(callback, 0);
    }
  };
  
  scheduleIdleWork(() => {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initReadingTime);
    } else {
      initReadingTime();
    }
  });
  
  function initReadingTime() {
    const content = document.querySelector('.post-content');
    if (content) {
      const text = content.textContent || content.innerText;
      const wordCount = text.trim().split(/\s+/).length;
      const readingTime = Math.ceil(wordCount / 200);
      const readingTimeEl = document.getElementById('reading-time');
      if (readingTimeEl) {
        readingTimeEl.textContent = readingTime + ' min read';
      }
    }

    // Enhance external links in post content (non-critical)
    scheduleIdleWork(enhanceExternalLinks, 3000);
  }
})();

// Function to enhance external links with icons and attributes
function enhanceExternalLinks() {
  const postContent = document.querySelector('.post-content');
  if (!postContent) return;

  const links = postContent.querySelectorAll('a[href]');
  const currentHost = window.location.hostname;
  const currentProtocol = window.location.protocol;

  links.forEach(link => {
    const href = link.getAttribute('href');
    if (!href) return;

    // Skip if already processed or is a special link
    if (link.classList.contains('external-link-processed') || 
        href.startsWith('#') || 
        href.startsWith('mailto:') || 
        href.startsWith('tel:')) {
      return;
    }

    // Check if it's an external link
    const isExternal = (href.startsWith('http://') || href.startsWith('https://')) &&
                       !href.includes(currentHost) &&
                       !link.hasAttribute('target');

    // Check if it's an internal link that should open in new tab
    const shouldOpenNewTab = link.hasAttribute('target') && 
                             link.getAttribute('target') === '_blank';

    if (isExternal || shouldOpenNewTab) {
      // Add external link attributes for security
      if (!link.hasAttribute('target')) {
        link.setAttribute('target', '_blank');
      }
      if (!link.hasAttribute('rel')) {
        link.setAttribute('rel', 'noopener noreferrer');
      }

      // Add aria-label for accessibility
      const linkText = link.textContent.trim();
      if (!link.hasAttribute('aria-label')) {
        link.setAttribute('aria-label', `${linkText} (새 창에서 열림)`);
      }

      // Add class for styling
      link.classList.add('external-link', 'external-link-processed');

      // Add title attribute if not present
      if (!link.hasAttribute('title')) {
        link.setAttribute('title', '새 창에서 열림');
      }
    }
  });
}

// Reading progress bar
window.addEventListener('scroll', function() {
  const article = document.querySelector('.post-article');
  const progressBar = document.getElementById('reading-progress');
  if (article && progressBar) {
    const articleTop = article.offsetTop;
    const articleHeight = article.offsetHeight;
    const windowHeight = window.innerHeight;
    const scrollY = window.scrollY;
    const progress = Math.min(Math.max((scrollY - articleTop + windowHeight * 0.3) / articleHeight * 100, 0), 100);
    progressBar.style.width = progress + '%';
  }
});

// Giscus loading state management
document.addEventListener('DOMContentLoaded', function() {
  const giscusContainer = document.getElementById('giscus-container');
  const giscusLoading = document.getElementById('giscus-loading');
  
  if (giscusContainer && giscusLoading) {
    // Giscus가 로드되면 로딩 인디케이터 숨기기
    const observer = new MutationObserver(function(mutations) {
      const giscusFrame = giscusContainer.querySelector('iframe');
      if (giscusFrame && giscusFrame.contentDocument) {
        giscusLoading.classList.add('hidden');
        observer.disconnect();
      }
    });

    observer.observe(giscusContainer, {
      childList: true,
      subtree: true
    });

    // 최대 대기 시간 설정 (10초 후 자동으로 로딩 인디케이터 숨기기)
    setTimeout(function() {
      if (!giscusLoading.classList.contains('hidden')) {
        giscusLoading.classList.add('hidden');
      }
    }, 10000);

    // Giscus 스크립트 로드 확인
    const giscusScript = document.querySelector('script[src*="giscus.app"]');
    if (giscusScript) {
      giscusScript.addEventListener('load', function() {
        // 스크립트 로드 후 짧은 지연을 두고 확인
        setTimeout(function() {
          const giscusFrame = giscusContainer.querySelector('iframe');
          if (giscusFrame) {
            giscusLoading.classList.add('hidden');
          }
        }, 2000);
      });
    }
  }
});

// Image Lightbox functionality
(function() {
  // Create lightbox elements
  const lightbox = document.createElement('div');
  lightbox.id = 'image-lightbox';
  lightbox.className = 'image-lightbox';
  lightbox.innerHTML = `
    <div class="lightbox-backdrop"></div>
    <div class="lightbox-content">
      <button class="lightbox-close" aria-label="닫기">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
      <img class="lightbox-image" src="" alt="">
      <div class="lightbox-caption"></div>
      <div class="lightbox-controls">
        <button class="lightbox-zoom-in" aria-label="확대">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            <line x1="11" y1="8" x2="11" y2="14"/>
            <line x1="8" y1="11" x2="14" y2="11"/>
          </svg>
        </button>
        <button class="lightbox-zoom-out" aria-label="축소">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            <line x1="8" y1="11" x2="14" y2="11"/>
          </svg>
        </button>
        <button class="lightbox-reset" aria-label="원본 크기">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 3 21 3 21 9"/>
            <polyline points="9 21 3 21 3 15"/>
            <line x1="21" y1="3" x2="14" y2="10"/>
            <line x1="3" y1="21" x2="10" y2="14"/>
          </svg>
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(lightbox);

  const lightboxImage = lightbox.querySelector('.lightbox-image');
  const lightboxCaption = lightbox.querySelector('.lightbox-caption');
  const lightboxClose = lightbox.querySelector('.lightbox-close');
  const lightboxBackdrop = lightbox.querySelector('.lightbox-backdrop');
  const zoomInBtn = lightbox.querySelector('.lightbox-zoom-in');
  const zoomOutBtn = lightbox.querySelector('.lightbox-zoom-out');
  const resetBtn = lightbox.querySelector('.lightbox-reset');

  let currentScale = 1;
  const scaleStep = 0.25;
  const maxScale = 3;
  const minScale = 0.5;

  // Open lightbox on image click
  function openLightbox(img) {
    let src = img.dataset.fullSrc || img.src;
    const alt = img.alt || '';

    if (!src) {
      console.error('Image source is missing');
      return;
    }

    // URL 인코딩된 경로를 디코딩하여 한글 파일명으로 변환 시도
    try {
      const decodedSrc = decodeURIComponent(src);
      if (decodedSrc !== src && /[가-힣]/.test(decodedSrc)) {
        // 디코딩된 경로(한글 파일명)로 먼저 시도
        src = decodedSrc;
      }
    } catch (e) {
      // 디코딩 실패 시 원본 사용
    }

    // Reset scale and show loading state
    currentScale = 1;
    lightboxImage.style.transform = `scale(${currentScale})`;
    lightboxImage.style.opacity = '0';
    lightboxImage.style.display = 'block';
    lightboxImage.style.visibility = 'visible';
    
    // Reset caption style
    lightboxCaption.style.color = '#ffffff';
    lightboxCaption.textContent = alt;

    // Show lightbox immediately
    lightbox.classList.add('active');
    document.body.style.overflow = 'hidden';

    // Handle image load
    const handleImageLoad = () => {
      lightboxImage.style.opacity = '1';
      lightboxImage.style.transition = 'opacity 0.3s ease';
    };

    const handleImageError = () => {
      // 콘솔 에러는 필터링되므로 조용히 처리
      lightboxImage.style.opacity = '0.5';
      lightboxCaption.textContent = alt ? `${alt} (이미지를 불러올 수 없습니다)` : '이미지를 불러올 수 없습니다';
      lightboxCaption.style.color = '#ff6b6b';
    };

    // Remove previous event listeners
    const newImageLoadHandler = handleImageLoad;
    const newImageErrorHandler = handleImageError;
    
    // Remove old listeners
    lightboxImage.onload = null;
    lightboxImage.onerror = null;
    
    // Preload image to check if it's available
    const preloadImage = new Image();
    let retryCount = 0;
    const originalSrc = img.dataset.fullSrc || img.src;
    
    const tryLoadImage = (imageSrc) => {
      preloadImage.onload = () => {
        // Image is available, set it to lightbox
        lightboxImage.src = imageSrc;
        lightboxImage.alt = alt;
        
        // Add event listeners
        lightboxImage.onload = newImageLoadHandler;
        lightboxImage.onerror = newImageErrorHandler;
        
        // If image is already cached, trigger load immediately
        if (lightboxImage.complete && lightboxImage.naturalHeight !== 0) {
          handleImageLoad();
        }
      };
      
      preloadImage.onerror = () => {
        retryCount++;
        // 재시도: 원본 URL 인코딩된 경로로 시도
        if (retryCount === 1 && imageSrc !== originalSrc) {
          tryLoadImage(originalSrc);
        } else {
          handleImageError();
          lightboxImage.onerror = newImageErrorHandler;
        }
      };
      
      preloadImage.src = imageSrc;
    };
    
    // Start preloading with decoded path first
    tryLoadImage(src);
  }

  // Close lightbox
  function closeLightbox() {
    lightbox.classList.remove('active');
    document.body.style.overflow = '';
    currentScale = 1;
    lightboxImage.style.transform = `scale(${currentScale})`;
    // Reset image styles
    lightboxImage.style.opacity = '1';
    lightboxImage.style.visibility = 'visible';
    lightboxCaption.style.color = '#ffffff';
    // Clear image source to free memory
    setTimeout(() => {
      if (!lightbox.classList.contains('active')) {
        lightboxImage.src = '';
        lightboxImage.onload = null;
        lightboxImage.onerror = null;
      }
    }, 300);
  }

  // Zoom functions
  function zoomIn() {
    if (currentScale < maxScale) {
      currentScale = Math.min(currentScale + scaleStep, maxScale);
      lightboxImage.style.transform = `scale(${currentScale})`;
    }
  }

  function zoomOut() {
    if (currentScale > minScale) {
      currentScale = Math.max(currentScale - scaleStep, minScale);
      lightboxImage.style.transform = `scale(${currentScale})`;
    }
  }

  function resetZoom() {
    currentScale = 1;
    lightboxImage.style.transform = `scale(${currentScale})`;
  }

  // Function to attach click handlers to images
  function attachImageHandlers() {
    const images = document.querySelectorAll('.clickable-image, .post-content img, .post-image img');
    images.forEach(img => {
      // Skip if already processed
      if (img.dataset.lightboxAttached === 'true') return;
      
      img.style.cursor = 'zoom-in';
      img.dataset.lightboxAttached = 'true';
      img.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        openLightbox(this);
      });
    });
  }

  // Attach handlers on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attachImageHandlers);
  } else {
    attachImageHandlers();
  }

  // Also attach handlers after a short delay to catch dynamically loaded images
  setTimeout(attachImageHandlers, 500);

  // Close events
  lightboxClose.addEventListener('click', closeLightbox);
  lightboxBackdrop.addEventListener('click', closeLightbox);

  // Zoom events
  zoomInBtn.addEventListener('click', zoomIn);
  zoomOutBtn.addEventListener('click', zoomOut);
  resetBtn.addEventListener('click', resetZoom);

  // Keyboard events
  document.addEventListener('keydown', function(e) {
    if (!lightbox.classList.contains('active')) return;

    switch(e.key) {
      case 'Escape':
        closeLightbox();
        break;
      case '+':
      case '=':
        zoomIn();
        break;
      case '-':
        zoomOut();
        break;
      case '0':
        resetZoom();
        break;
    }
  });

  // Mouse wheel zoom
  lightboxImage.addEventListener('wheel', function(e) {
    e.preventDefault();
    if (e.deltaY < 0) {
      zoomIn();
    } else {
      zoomOut();
    }
  });
})();
</script>

{% include mermaid.html %}
