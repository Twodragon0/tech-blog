<!-- Performance Monitoring (Production Only) -->
<script>
(function() {
  'use strict';
  
  // Only run in production
  if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    return;
  }

  // Wait for page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPerformanceMonitor);
  } else {
    initPerformanceMonitor();
  }

  function initPerformanceMonitor() {
    // Web Vitals monitoring
    if ('PerformanceObserver' in window) {
      // Largest Contentful Paint (LCP)
      try {
        const lcpObserver = new PerformanceObserver(function(list) {
          const entries = list.getEntries();
          const lastEntry = entries[entries.length - 1];
          if (lastEntry && lastEntry.renderTime) {
            const lcp = lastEntry.renderTime;
            if (lcp > 2500) { // LCP should be < 2.5s
              console.warn('[Performance] LCP is slow:', lcp + 'ms');
            }
          }
        });
        lcpObserver.observe({ entryTypes: ['largest-contentful-paint'] });
      } catch (e) {
        // LCP observer not supported
        // 실제 에러인 경우에만 Sentry로 전송
        if (window.location.hostname === 'tech.2twodragon.com' && typeof Sentry !== 'undefined' && Sentry.captureException) {
          Sentry.captureException(e, {
            tags: { errorType: 'performance_monitor_lcp' },
            level: 'warning'
          });
        }
      }

      // First Input Delay (FID)
      try {
        const fidObserver = new PerformanceObserver(function(list) {
          for (const entry of list.getEntries()) {
            if (entry.processingStart - entry.startTime > 100) { // FID should be < 100ms
              console.warn('[Performance] FID is slow:', (entry.processingStart - entry.startTime) + 'ms');
            }
          }
        });
        fidObserver.observe({ entryTypes: ['first-input'] });
      } catch (e) {
        // FID observer not supported
        // 실제 에러인 경우에만 Sentry로 전송
        if (window.location.hostname === 'tech.2twodragon.com' && typeof Sentry !== 'undefined' && Sentry.captureException) {
          Sentry.captureException(e, {
            tags: { errorType: 'performance_monitor_fid' },
            level: 'warning'
          });
        }
      }

      // Cumulative Layout Shift (CLS) - 상세 추적 및 리포트
      let clsValue = 0;
      let clsEntries = [];
      let clsReportGenerated = false;
      
      // CLS 원인 분석 함수
      function analyzeCLSCause(entry) {
        const causes = [];
        if (entry.sources && entry.sources.length > 0) {
          entry.sources.forEach(function(source) {
            if (source.node) {
              const tagName = source.node.tagName || '';
              const className = source.node.className || '';
              const id = source.node.id || '';
              
              // 주요 원인 분류
              if (tagName === 'IMG' || className.includes('image') || className.includes('img')) {
                causes.push('이미지: ' + (source.node.src || source.node.getAttribute('src') || '알 수 없음'));
              } else if (tagName === 'IFRAME' || className.includes('adsbygoogle') || className.includes('ad')) {
                causes.push('광고: ' + (source.node.src || className || '알 수 없음'));
              } else if (tagName === 'DIV' && className.includes('card')) {
                causes.push('카드 컴포넌트: ' + className);
              } else if (tagName === 'SCRIPT') {
                causes.push('스크립트 삽입');
              } else {
                causes.push(tagName + (id ? '#' + id : '') + (className ? '.' + className.split(' ')[0] : ''));
              }
            }
          });
        }
        return causes.length > 0 ? causes.join(', ') : '알 수 없음';
      }
      
      // CLS 리포트 생성
      function generateCLSReport() {
        if (clsReportGenerated || clsEntries.length === 0) return;
        clsReportGenerated = true;
        
        const report = {
          totalCLS: clsValue.toFixed(6),
          entryCount: clsEntries.length,
          entries: clsEntries.map(function(entry) {
            return {
              value: entry.value.toFixed(6),
              cause: entry.cause || '알 수 없음',
              time: entry.startTime.toFixed(2) + 'ms'
            };
          }),
          topCauses: {}
        };
        
        // 주요 원인 집계
        clsEntries.forEach(function(entry) {
          const cause = entry.cause || '알 수 없음';
          if (!report.topCauses[cause]) {
            report.topCauses[cause] = { count: 0, totalValue: 0 };
          }
          report.topCauses[cause].count++;
          report.topCauses[cause].totalValue += entry.value;
        });
        
        // 개발 환경에서만 상세 리포트 표시
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          console.group('[Performance] CLS 상세 리포트');
          console.log('총 CLS 값:', report.totalCLS);
          console.log('레이아웃 시프트 횟수:', report.entryCount);
          console.log('주요 원인:', report.topCauses);
          console.table(report.entries.slice(0, 10)); // 상위 10개만 표시
          console.groupEnd();
        }
        
        return report;
      }
      
      try {
        const clsObserver = new PerformanceObserver(function(list) {
          for (const entry of list.getEntries()) {
            // 사용자 입력 후 500ms 이내의 시프트는 무시 (사용자 의도적 상호작용)
            if (!entry.hadRecentInput) {
              const cause = analyzeCLSCause(entry);
              clsValue += entry.value;
              
              clsEntries.push({
                value: entry.value,
                sources: entry.sources || [],
                startTime: entry.startTime,
                cause: cause
              });
              
              // CLS 임계값 체크 (0.1 이상이면 경고)
              if (clsValue > 0.1) {
                console.warn('[Performance] CLS is high:', clsValue.toFixed(6), '| 원인:', cause);
              }
            }
          }
        });
        clsObserver.observe({ entryTypes: ['layout-shift'] });
        
        // 페이지 언로드 시 최종 CLS 리포트 생성
        window.addEventListener('beforeunload', function() {
          if (clsValue > 0) {
            const report = generateCLSReport();
            
            // 프로덕션에서도 중요한 CLS 정보만 로깅
            if (clsValue > 0.25) { // 매우 높은 CLS
              console.error('[Performance] CLS is very high:', clsValue.toFixed(6));
            }
            
            // 서버로 전송 (선택사항)
            // if ('sendBeacon' in navigator && report) {
            //   navigator.sendBeacon('/api/metrics', JSON.stringify({
            //     metric: 'CLS',
            //     value: clsValue,
            //     report: report
            //   }));
            // }
          }
        });
        
        // 페이지 로드 완료 후 중간 리포트 (개발 환경)
        window.addEventListener('load', function() {
          setTimeout(function() {
            if ((window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') && clsValue > 0.05) {
              console.warn('[Performance] 페이지 로드 후 CLS:', clsValue.toFixed(6));
              if (clsEntries.length > 0) {
                console.log('[Performance] 주요 원인:', clsEntries.slice(0, 3).map(function(e) {
                  return e.cause + ' (' + e.value.toFixed(4) + ')';
                }).join(', '));
              }
            }
          }, 2000);
        });
      } catch (e) {
        // CLS observer not supported
        // 실제 에러인 경우에만 Sentry로 전송
        if (window.location.hostname === 'tech.2twodragon.com' && typeof Sentry !== 'undefined' && Sentry.captureException) {
          Sentry.captureException(e, {
            tags: { errorType: 'performance_monitor_cls' },
            level: 'warning'
          });
        }
      }
    }

    // Page load time monitoring
    window.addEventListener('load', function() {
      if (window.performance && window.performance.timing) {
        const timing = window.performance.timing;
        const loadTime = timing.loadEventEnd - timing.navigationStart;
        const domReady = timing.domContentLoadedEventEnd - timing.navigationStart;
        
        if (loadTime > 3000) { // Page load should be < 3s
          console.warn('[Performance] Page load is slow:', loadTime + 'ms');
        }
        if (domReady > 2000) { // DOM ready should be < 2s
          console.warn('[Performance] DOM ready is slow:', domReady + 'ms');
        }
      }
    });

    // Resource loading monitoring
    if ('PerformanceObserver' in window) {
      try {
        const resourceObserver = new PerformanceObserver(function(list) {
          for (const entry of list.getEntries()) {
            // API 요청은 타임아웃 직전까지 걸릴 수 있으므로 임계값 조정
            const isApiRequest = entry.name.includes('/api/');
            const threshold = isApiRequest ? 8000 : 2000; // API: 8초, 기타: 2초
            
            // Monitor slow resources
            if (entry.duration > threshold && entry.initiatorType !== 'navigation') {
              // API 요청은 타임아웃 직전이므로 경고만 (에러 아님)
              if (isApiRequest) {
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                  console.warn('[Performance] API response is slow (expected for AI):', entry.name, Math.round(entry.duration) + 'ms');
                }
              } else {
                console.warn('[Performance] Slow resource:', entry.name, Math.round(entry.duration) + 'ms');
              }
            }
          }
        });
        resourceObserver.observe({ entryTypes: ['resource'] });
      } catch (e) {
        // Resource observer not supported
        // 실제 에러인 경우에만 Sentry로 전송
        if (window.location.hostname === 'tech.2twodragon.com' && typeof Sentry !== 'undefined' && Sentry.captureException) {
          Sentry.captureException(e, {
            tags: { errorType: 'performance_monitor_resource' },
            level: 'warning'
          });
        }
      }
    }
  }
})();
</script>
