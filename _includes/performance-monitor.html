<!-- Performance Monitoring (Production Only) -->
<script>
(function() {
  'use strict';
  
  // Only run in production
  if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    return;
  }

  // Wait for page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPerformanceMonitor);
  } else {
    initPerformanceMonitor();
  }

  function initPerformanceMonitor() {
    // Web Vitals monitoring
    if ('PerformanceObserver' in window) {
      // Largest Contentful Paint (LCP)
      try {
        const lcpObserver = new PerformanceObserver(function(list) {
          const entries = list.getEntries();
          const lastEntry = entries[entries.length - 1];
          if (lastEntry && lastEntry.renderTime) {
            const lcp = lastEntry.renderTime;
            if (lcp > 2500) { // LCP should be < 2.5s
              console.warn('[Performance] LCP is slow:', lcp + 'ms');
            }
          }
        });
        lcpObserver.observe({ entryTypes: ['largest-contentful-paint'] });
      } catch (e) {
        // LCP observer not supported
      }

      // First Input Delay (FID)
      try {
        const fidObserver = new PerformanceObserver(function(list) {
          for (const entry of list.getEntries()) {
            if (entry.processingStart - entry.startTime > 100) { // FID should be < 100ms
              console.warn('[Performance] FID is slow:', (entry.processingStart - entry.startTime) + 'ms');
            }
          }
        });
        fidObserver.observe({ entryTypes: ['first-input'] });
      } catch (e) {
        // FID observer not supported
      }

      // Cumulative Layout Shift (CLS)
      let clsValue = 0;
      let clsEntries = [];
      try {
        const clsObserver = new PerformanceObserver(function(list) {
          for (const entry of list.getEntries()) {
            // 사용자 입력 후 500ms 이내의 시프트는 무시 (사용자 의도적 상호작용)
            if (!entry.hadRecentInput) {
              clsValue += entry.value;
              clsEntries.push({
                value: entry.value,
                sources: entry.sources || [],
                startTime: entry.startTime
              });
              
              // CLS 임계값 체크 (0.1 이상이면 경고)
              if (clsValue > 0.1) {
                console.warn('[Performance] CLS is high:', clsValue.toFixed(6));
                // 개발 환경에서만 상세 정보 표시
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                  console.warn('[Performance] CLS entries:', clsEntries.slice(-5)); // 최근 5개만
                }
              }
            }
          }
        });
        clsObserver.observe({ entryTypes: ['layout-shift'] });
        
        // 페이지 언로드 시 최종 CLS 값 기록
        window.addEventListener('beforeunload', function() {
          if (clsValue > 0.1 && 'sendBeacon' in navigator) {
            // 최종 CLS 값을 서버로 전송 (선택사항)
            // navigator.sendBeacon('/api/metrics', JSON.stringify({ cls: clsValue }));
          }
        });
      } catch (e) {
        // CLS observer not supported
      }
    }

    // Page load time monitoring
    window.addEventListener('load', function() {
      if (window.performance && window.performance.timing) {
        const timing = window.performance.timing;
        const loadTime = timing.loadEventEnd - timing.navigationStart;
        const domReady = timing.domContentLoadedEventEnd - timing.navigationStart;
        
        if (loadTime > 3000) { // Page load should be < 3s
          console.warn('[Performance] Page load is slow:', loadTime + 'ms');
        }
        if (domReady > 2000) { // DOM ready should be < 2s
          console.warn('[Performance] DOM ready is slow:', domReady + 'ms');
        }
      }
    });

    // Resource loading monitoring
    if ('PerformanceObserver' in window) {
      try {
        const resourceObserver = new PerformanceObserver(function(list) {
          for (const entry of list.getEntries()) {
            // API 요청은 타임아웃 직전까지 걸릴 수 있으므로 임계값 조정
            const isApiRequest = entry.name.includes('/api/');
            const threshold = isApiRequest ? 8000 : 2000; // API: 8초, 기타: 2초
            
            // Monitor slow resources
            if (entry.duration > threshold && entry.initiatorType !== 'navigation') {
              // API 요청은 타임아웃 직전이므로 경고만 (에러 아님)
              if (isApiRequest) {
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                  console.warn('[Performance] API response is slow (expected for AI):', entry.name, Math.round(entry.duration) + 'ms');
                }
              } else {
                console.warn('[Performance] Slow resource:', entry.name, Math.round(entry.duration) + 'ms');
              }
            }
          }
        });
        resourceObserver.observe({ entryTypes: ['resource'] });
      } catch (e) {
        // Resource observer not supported
      }
    }
  }
})();
</script>
