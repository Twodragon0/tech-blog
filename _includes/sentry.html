<!-- Sentry Error Tracking -->
<!-- 
  공식 Loader Script 사용 (권장)
  DSN: https://61fd23528aff138753e071de26c5b306@o4510686170710016.ingest.us.sentry.io/4510686177984512
  
  설정 방법:
  1. Sentry.io 프로젝트 설정에서 Loader Script 복사
  2. 아래 스크립트 태그의 src URL 업데이트 (필요시)
  3. DSN은 Loader Script에 포함되어 있음
-->

<!-- Sentry Loader Script (페이지 상단에 위치) -->
<script
  src="https://js.sentry-cdn.com/61fd23528aff138753e071de26c5b306.min.js"
  crossorigin="anonymous"
></script>

<!-- Sentry 초기화 (Loader Script 로드 후 실행) -->
<script>
(function() {
  'use strict';
  
  // Sentry가 로드될 때까지 대기 (CSP 위반 시 로드되지 않을 수 있음)
  if (typeof Sentry === 'undefined') {
    // 개발 환경에서만 경고 (프로덕션에서는 조용히 실패)
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      console.warn('[Sentry] Loader script not loaded - CSP may be blocking it');
    }
    return;
  }

  // Sentry.onLoad()를 사용하여 초기화 (Loader Script 방식)
  Sentry.onLoad(function() {
    Sentry.init({
      // 환경 설정
      environment: window.location.hostname === 'tech.2twodragon.com' 
        ? 'production' 
        : window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
        ? 'development'
        : 'preview',
      
      // Tracing: 성능 모니터링 (프리티어 최적화: 10% 샘플링)
      tracesSampleRate: 0.1, // 프로덕션: 10%, 개발: 1.0 (100%)
      
      // Session Replay: 세션 재생 (비용 최적화)
      replaysSessionSampleRate: 0.0, // 0% (비활성화 - 비용 절감)
      replaysOnErrorSampleRate: 0.0, // 0% (비활성화 - 비용 절감)
      
      // 릴리스 정보 (선택사항)
      // release: 'tech-blog@1.0.0',
      
      // 에러 필터링 및 보안
      beforeSend(event, hint) {
        // 민감 정보 제거
        if (event.request) {
          // 쿠키 제거
          delete event.request.cookies;
          
          // URL에서 민감한 쿼리 파라미터 제거
          if (event.request.url) {
            try {
              const url = new URL(event.request.url);
              const sensitiveParams = ['token', 'key', 'password', 'secret', 'api_key', 'apikey'];
              sensitiveParams.forEach(param => {
                url.searchParams.delete(param);
              });
              event.request.url = url.toString();
            } catch (e) {
              // URL 파싱 실패 시 그대로 유지
            }
          }
        }
        
        // 특정 에러 무시 (정상적인 보안 에러)
        if (event.exception) {
          const error = hint.originalException;
          if (error && error.message) {
            const errorMessage = error.message.toLowerCase();
            // CSP 위반, 확장 프로그램 관련 에러는 무시
            if (errorMessage.includes('content security policy') ||
                errorMessage.includes('csp') ||
                errorMessage.includes('extension') ||
                errorMessage.includes('chrome-extension') ||
                errorMessage.includes('moz-extension')) {
              return null; // 이벤트 무시
            }
          }
        }
        
        return event;
      },
      
      // 샘플링 함수 (에러 수집률)
      sampleRate: 1.0, // 100% 에러 수집 (필요시 조정)
      
      // 통합 설정
      integrations: [
        // BrowserTracing은 Loader Script에서 자동 설정됨
      ],
    });

    // 사용자 컨텍스트 설정 (선택사항)
    // Sentry.setUser({
    //   id: 'anonymous',
    //   username: 'visitor'
    // });

    // 개발 환경에서만 로그
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      console.log('[Sentry] Initialized successfully');
    }
  });
})();
</script>
