<!-- Sentry Error Tracking -->
<!-- 
  공식 Loader Script 사용 (권장)
  DSN: https://61fd23528aff138753e071de26c5b306@o4510686170710016.ingest.us.sentry.io/4510686177984512
  
  설정 방법:
  1. Sentry.io 프로젝트 설정에서 Loader Script 복사
  2. 아래 스크립트 태그의 src URL 업데이트 (필요시)
  3. DSN은 Loader Script에 포함되어 있음
-->

<!-- Sentry Loader Script (페이지 상단에 위치) -->
<script
  src="https://js.sentry-cdn.com/61fd23528aff138753e071de26c5b306.min.js"
  crossorigin="anonymous"
></script>

<!-- Sentry 초기화 (Loader Script 로드 후 실행) -->
<script>
(function() {
  'use strict';
  
  // Sentry가 로드될 때까지 대기 (CSP 위반 시 로드되지 않을 수 있음)
  if (typeof Sentry === 'undefined') {
    // 개발 환경에서만 경고 (프로덕션에서는 조용히 실패)
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      console.warn('[Sentry] Loader script not loaded - CSP may be blocking it');
    }
    return;
  }

  // Sentry.onLoad()를 사용하여 초기화 (Loader Script 방식)
  Sentry.onLoad(function() {
    Sentry.init({
      // 환경 설정
      environment: window.location.hostname === 'tech.2twodragon.com' 
        ? 'production' 
        : window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
        ? 'development'
        : 'preview',
      
      // Tracing: 성능 모니터링 (프리티어 최적화: 10% 샘플링)
      tracesSampleRate: 0.1, // 프로덕션: 10%, 개발: 1.0 (100%)
      
      // Session Replay: 세션 재생 (비용 최적화)
      replaysSessionSampleRate: 0.0, // 0% (비활성화 - 비용 절감)
      replaysOnErrorSampleRate: 0.0, // 0% (비활성화 - 비용 절감)
      
      // Logs: 구조화된 로깅 활성화 (SDK 9.41.0+)
      enableLogs: true,
      
      // Source Maps: 프로덕션에서는 비활성화 (CSP 위반 방지 및 보안)
      // 개발 환경에서만 source map 로드
      _experiments: {
        // Source map 로드 비활성화 (프로덕션)
        enableSourceMaps: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      },
      
      // 릴리스 정보 (선택사항)
      // release: 'tech-blog@1.0.0',
      
      // 에러 필터링 및 보안
      beforeSend(event, hint) {
        // 민감 정보 제거
        if (event.request) {
          // 쿠키 제거
          delete event.request.cookies;
          
          // URL에서 민감한 쿼리 파라미터 제거
          if (event.request.url) {
            try {
              const url = new URL(event.request.url);
              const sensitiveParams = ['token', 'key', 'password', 'secret', 'api_key', 'apikey'];
              sensitiveParams.forEach(param => {
                url.searchParams.delete(param);
              });
              event.request.url = url.toString();
            } catch (e) {
              // URL 파싱 실패 시 그대로 유지
            }
          }
        }
        
        // 특정 에러 무시 (정상적인 보안 에러 및 이미지 로드 실패)
        if (event.exception) {
          const error = hint.originalException;
          if (error && error.message) {
            const errorMessage = error.message.toLowerCase();
            // CSP 위반, 확장 프로그램 관련 에러는 무시
            // 이미지 로드 실패 (404, 한글 파일명 인코딩 문제 등)는 무시
            // Long task는 성능 경고이지 에러가 아니므로 무시 (성능 모니터링은 별도로 처리)
            if (errorMessage.includes('content security policy') ||
                errorMessage.includes('csp') ||
                errorMessage.includes('extension') ||
                errorMessage.includes('chrome-extension') ||
                errorMessage.includes('moz-extension') ||
                errorMessage.includes('failed to load') ||
                errorMessage.includes('load link') ||
                errorMessage.includes('long task detected') ||
                errorMessage.includes('layout shift detected') ||
                (errorMessage.includes('image') && (errorMessage.includes('404') || errorMessage.includes('not found')))) {
              return null; // 이벤트 무시
            }
          }
        }
        
        // Long task 및 성능 관련 에러 필터링 (커스텀 컨텍스트 기반)
        if (event.contexts && event.contexts.custom) {
          const customContext = event.contexts.custom;
          // Long task는 성능 경고이지 에러가 아님 (100-200ms는 허용 가능한 범위)
          if (customContext.type === 'performance' && 
              (customContext.duration !== undefined || customContext.metric === 'CLS')) {
            return null; // 성능 메트릭은 에러로 보고하지 않음
          }
        }
        
        // 에러 메시지에서 Long task 패턴 확인 (추가 안전장치)
        if (event.message) {
          const message = event.message.toLowerCase();
          if (message.includes('long task') || message.includes('layout shift')) {
            return null; // 성능 경고는 에러로 보고하지 않음
          }
        }
        
        // 이미지 로드 실패 에러 필터링 (request URL 기반)
        if (event.request && event.request.url) {
          const url = event.request.url.toLowerCase();
          // OG 이미지, 한글 파일명 포함 URL은 무시
          if (url.includes('_og.png') || 
              url.includes('og.png') || 
              url.includes('og.jpg') || 
              url.includes('og.webp') ||
              /[\uAC00-\uD7A3]/.test(event.request.url)) { // 한글 포함된 URL
            return null; // 이벤트 무시
          }
        }
        
        return event;
      },
      
      // 로그 필터링 및 보안 (beforeSendLog)
      beforeSendLog(log, hint) {
        // 민감 정보 제거
        if (log.message) {
          // 민감한 정보가 포함된 로그 필터링
          const sensitivePatterns = [
            /password/i,
            /token/i,
            /secret/i,
            /api[_-]?key/i,
            /apikey/i,
            /authorization/i,
            /bearer/i
          ];
          
          if (sensitivePatterns.some(pattern => pattern.test(log.message))) {
            return null; // 민감한 로그는 전송하지 않음
          }
        }
        
        // 개발 환경의 디버그 로그는 필터링 (프로덕션에서만 중요한 로그 수집)
        if (log.level === 'debug' && window.location.hostname === 'tech.2twodragon.com') {
          return null; // 프로덕션에서는 debug 로그 제외
        }
        
        return log;
      },
      
      // 샘플링 함수 (에러 수집률)
      sampleRate: 1.0, // 100% 에러 수집 (필요시 조정)
      
      // 통합 설정
      integrations: [
        // BrowserTracing은 Loader Script에서 자동 설정됨
      ],
    });

    // 사용자 컨텍스트 설정 (선택사항)
    // Sentry.setUser({
    //   id: 'anonymous',
    //   username: 'visitor'
    // });

    // 개발 환경에서만 로그
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      console.log('[Sentry] Initialized successfully');
    }
    
    // Sentry Logs 테스트 (개발 환경에서만)
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      if (Sentry.logger && typeof Sentry.logger.info === 'function') {
        Sentry.logger.info('Sentry initialized with Logs enabled', {
          environment: window.location.hostname === 'tech.2twodragon.com' ? 'production' : 'development',
          timestamp: new Date().toISOString()
        });
      }
    }
  });
})();
</script>
