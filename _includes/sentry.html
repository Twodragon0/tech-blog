{% if site.sentry_dsn and site.sentry_dsn != "" %}
<!-- Sentry SDK: Error Tracking + Tracing + Session Replay + User Feedback -->
<!-- Defer loading to reduce FID (First Input Delay) -->
<style>
  /* Hide Sentry's default feedback button - we use a custom one in bottom-toolbar */
  #sentry-feedback,
  [data-sentry-feedback],
  div:has(> .widget__actor) {
    display: none !important;
  }
</style>
<script
  src="https://browser.sentry-cdn.com/8.42.0/bundle.tracing.replay.feedback.min.js"
  crossorigin="anonymous"
  defer
></script>
<script>
// Wait for deferred Sentry SDK to load before initializing
function initSentry() {
  'use strict';

  if (typeof Sentry === 'undefined') return;

  var isProduction = window.location.hostname === 'tech.2twodragon.com';
  var isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

  // Free Tier: monthly event tracking via localStorage
  var MONTHLY_LIMIT = 5000;
  var MONTHLY_KEY = 'se_month';
  var MONTHLY_TS = 'se_ts';

  function getMonthlyCount() {
    try {
      var ts = parseInt(localStorage.getItem(MONTHLY_TS) || '0', 10);
      var count = parseInt(localStorage.getItem(MONTHLY_KEY) || '0', 10);
      var now = Date.now();
      if ((now - ts) > 30 * 24 * 60 * 60 * 1000 || ts === 0) {
        localStorage.setItem(MONTHLY_KEY, '0');
        localStorage.setItem(MONTHLY_TS, String(now));
        return 0;
      }
      return count;
    } catch (e) { return 0; }
  }

  function incrementMonthly() {
    try {
      var count = getMonthlyCount() + 1;
      localStorage.setItem(MONTHLY_KEY, String(count));
      return count;
    } catch (e) { return 0; }
  }

  // Dynamic sample rate based on monthly usage
  function getDynamicSampleRate() {
    if (!isProduction) return 0;
    var count = getMonthlyCount();
    if (count > MONTHLY_LIMIT * 0.9) return 0.3;
    if (count > MONTHLY_LIMIT * 0.8) return 0.5;
    if (count > MONTHLY_LIMIT * 0.6) return 0.75;
    return 1.0;
  }

  // Sensitive data patterns for filtering
  var sensitivePatterns = [
    /password/i, /token/i, /secret/i, /api[_-]?key/i,
    /authorization/i, /bearer/i, /credential/i,
    /private[_-]?key/i, /sk-[a-zA-Z0-9]+/i
  ];

  function containsSensitive(text) {
    if (!text) return false;
    return sensitivePatterns.some(function(p) { return p.test(text); });
  }

  // Errors to ignore (noise from extensions, network, CSP)
  var ignorePatterns = [
    /content security policy/i, /csp/i,
    /chrome-extension/i, /moz-extension/i,
    /resizeobserver loop/i, /network error/i,
    /script error/i, /failed to load/i,
    /load link/i, /long task/i, /layout shift/i
  ];

  function isNoiseError(msg) {
    if (!msg) return false;
    var lower = msg.toLowerCase();
    return ignorePatterns.some(function(p) { return p.test(lower); }) || lower === '' || lower === 'unknown error';
  }

  // Duplicate error throttling
  var errorCounts = {};

  function isThrottled(key) {
    var now = Date.now();
    var entry = errorCounts[key];
    if (!entry || (now - entry.ts) > 3600000) {
      errorCounts[key] = { count: 1, ts: now };
      return false;
    }
    entry.count++;
    if (entry.count > 8) return Math.random() > 0.3;
    return false;
  }

  var integrations = [
    Sentry.browserTracingIntegration({
      tracePropagationTargets: ['localhost', /^https:\/\/tech\.2twodragon\.com/]
    }),
    Sentry.replayIntegration({
      maskAllText: true,
      blockAllMedia: true,
      maskAllInputs: true
    })
  ];

  // User Feedback widget (FREE, unlimited)
  // autoInject: false to avoid aria-hidden focus conflict, manually trigger via CSS-positioned button
  if (isProduction && typeof Sentry.feedbackIntegration === 'function') {
    integrations.push(Sentry.feedbackIntegration({
      autoInject: false,
      colorScheme: 'system',
      showBranding: false,
      showName: false,
      showEmail: false,
      formTitle: '문제를 알려주세요',
      submitButtonLabel: '보내기',
      cancelButtonLabel: '취소',
      messageLabel: '메시지',
      messagePlaceholder: '어떤 문제가 있나요?',
      successMessageText: '감사합니다! 피드백이 전송되었습니다.'
    }));
  }

  Sentry.init({
    dsn: '{{ site.sentry_dsn }}',

    environment: isProduction ? 'production' : isDev ? 'development' : 'preview',

    release: (function() {
      if (typeof window !== 'undefined' && window.VERCEL_GIT_COMMIT_SHA) {
        return 'tech-blog@' + window.VERCEL_GIT_COMMIT_SHA.substring(0, 7);
      }
      if (isProduction) {
        var d = new Date();
        return 'tech-blog@' + d.getFullYear() + String(d.getMonth() + 1).padStart(2, '0') + String(d.getDate()).padStart(2, '0');
      }
      return undefined;
    })(),

    integrations: integrations,

    // Error sampling: dynamic based on monthly usage (Free Tier: 5,000/month)
    sampleRate: getDynamicSampleRate(),

    // Tracing: 5% production (Free Tier: 5M spans/month)
    tracesSampleRate: isProduction ? 0.05 : 0,
    enableTracing: true,

    // Session Replay: error-only recording (Free Tier: 50 replays/month)
    replaysSessionSampleRate: 0,
    replaysOnErrorSampleRate: isProduction ? 0.1 : 0,

    maxBreadcrumbs: 30,
    attachStacktrace: true,

    // Only capture errors from our domain
    allowUrls: [/https?:\/\/(www\.)?tech\.2twodragon\.com/],

    ignoreErrors: [
      'fb_xd_fragment', 'top.GLOBALS',
      /^Non-Error promise rejection/,
      /ResizeObserver loop/
    ],

    beforeSend: function(event, hint) {
      if (!isProduction) return null;

      var error = hint && hint.originalException;
      if (error && error.message && isNoiseError(error.message)) return null;

      if (event.message && isNoiseError(event.message)) return null;

      // Filter errors without useful stack from our code
      if (event.exception && event.exception.values && event.exception.values[0]) {
        var exc = event.exception.values[0];
        var hasOurCode = exc.stacktrace && exc.stacktrace.frames &&
          exc.stacktrace.frames.some(function(f) {
            if (!f.filename) return false;
            try {
              if (f.filename.startsWith('/assets/js/')) return true;
              var url = new URL(f.filename, window.location.origin);
              return url.hostname === 'tech.2twodragon.com';
            } catch (e) { return false; }
          });

        if (!hasOurCode && (!exc.value || isNoiseError(exc.value))) return null;
      }

      // Throttle duplicate errors
      var errorKey = event.fingerprint ? event.fingerprint.join('-') :
        (event.message || (event.exception && event.exception.values && event.exception.values[0] && event.exception.values[0].value) || 'unknown');
      if (isThrottled(errorKey.substring(0, 60))) return null;

      // Redact sensitive data in request URL
      if (event.request && event.request.url) {
        try {
          var url = new URL(event.request.url);
          ['token', 'key', 'password', 'secret', 'api_key', 'access_token', 'auth'].forEach(function(p) {
            url.searchParams.delete(p);
          });
          event.request.url = url.toString();
        } catch (e) {}
        delete event.request.cookies;
      }

      // Redact sensitive data in stack frames
      if (event.exception && event.exception.values) {
        event.exception.values.forEach(function(exc) {
          if (exc.stacktrace && exc.stacktrace.frames) {
            exc.stacktrace.frames.forEach(function(frame) {
              if (frame.filename) {
                frame.filename = frame.filename.replace(/\/Users\/[^\/]+/g, '/Users/***');
                frame.filename = frame.filename.replace(/\/home\/[^\/]+/g, '/home/***');
              }
              if (frame.vars) {
                Object.keys(frame.vars).forEach(function(k) {
                  if (containsSensitive(k) || containsSensitive(String(frame.vars[k] || ''))) {
                    frame.vars[k] = '***REDACTED***';
                  }
                });
              }
            });
          }
        });
      }

      // Fingerprint for better grouping
      if (event.exception && event.exception.values && event.exception.values[0]) {
        var first = event.exception.values[0];
        event.fingerprint = [
          first.type || 'Error',
          (first.value || 'Unknown').substring(0, 100)
        ];
      }

      // Track monthly count
      var newCount = incrementMonthly();
      if (isDev && newCount > MONTHLY_LIMIT * 0.8) {
        console.warn('[Sentry] Monthly event limit warning:', newCount, '/', MONTHLY_LIMIT);
      }

      // Limit event size (Free Tier optimization)
      if (event.breadcrumbs && event.breadcrumbs.length > 8) {
        event.breadcrumbs = event.breadcrumbs.slice(-8);
      }

      return event;
    },

    beforeBreadcrumb: function(breadcrumb) {
      if (!isProduction) return null;
      if (breadcrumb.category === 'console' && breadcrumb.level === 'log') return null;
      if (breadcrumb.message && containsSensitive(breadcrumb.message)) return null;
      return breadcrumb;
    }
  });

  if (isDev) console.log('[Sentry] Initialized with all Free Tier features');

  // Attach feedback form to custom toolbar button (must run after Sentry.init)
  var feedbackBtn = document.getElementById('custom-feedback-btn');
  if (feedbackBtn && isProduction) {
    var fb = null;
    // Primary: Sentry.getFeedback() convenience API
    if (typeof Sentry.getFeedback === 'function') {
      fb = Sentry.getFeedback();
    }
    // Fallback: getClient().getIntegrationByName()
    if (!fb && typeof Sentry.getClient === 'function') {
      var client = Sentry.getClient();
      if (client && typeof client.getIntegrationByName === 'function') {
        fb = client.getIntegrationByName('Feedback');
      }
    }
    if (fb && typeof fb.attachTo === 'function') {
      fb.attachTo(feedbackBtn, {
        formTitle: '문제를 알려주세요',
        submitButtonLabel: '보내기',
        cancelButtonLabel: '취소',
        messageLabel: '메시지',
        messagePlaceholder: '어떤 문제가 있나요?',
        successMessageText: '감사합니다! 피드백이 전송되었습니다.'
      });
    }
  }

  // Global error handler with context enrichment
  window.addEventListener('error', function(event) {
    if (!isProduction || typeof Sentry === 'undefined') return;
    if (event.error && event.error.__sentry_captured__) return;

    var error = event.error || new Error(event.message || 'Unknown error');
    error.__sentry_captured__ = true;

    Sentry.captureException(error, {
      tags: { errorType: 'global_error', handled: false },
      extra: {
        filename: (event.filename || 'unknown').substring(0, 100),
        lineno: event.lineno || 0,
        colno: event.colno || 0
      }
    });
  }, true);

  // Unhandled promise rejection handler
  window.addEventListener('unhandledrejection', function(event) {
    if (!isProduction || typeof Sentry === 'undefined') return;
    if (event.reason && event.reason.__sentry_captured__) return;

    var error = event.reason instanceof Error ? event.reason : new Error(String(event.reason || 'Unhandled Promise Rejection'));
    error.__sentry_captured__ = true;

    Sentry.captureException(error, {
      tags: { errorType: 'unhandled_promise_rejection', handled: false }
    });
  });
}
// Call initSentry after deferred Sentry SDK has loaded
if (typeof Sentry !== 'undefined') {
  initSentry();
} else {
  window.addEventListener('load', function() {
    if (typeof Sentry !== 'undefined') initSentry();
  });
}
</script>
{% else %}
<!-- Sentry disabled: sentry_dsn not configured in _config.yml -->
{% endif %}
