{% if include.content %}
{% assign headers = include.content | split: '<h' %}
{% if headers.size > 2 %}
<div class="toc-container">
  <div class="toc-card">
    <div class="toc-header">
      <div class="toc-title-section">
        <div class="toc-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </div>
        <h4 class="toc-title">목차</h4>
        <span class="toc-count" id="toc-count"></span>
      </div>
      <button class="toc-expand-btn" id="toc-toggle" aria-label="목차 펼치기/접기">
        <span class="btn-text">전체보기</span>
        <svg class="chevron-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 12 15 18 9"/>
        </svg>
      </button>
    </div>

    <nav class="toc-nav" id="toc-content" aria-label="Table of Contents">
      <div class="toc-grid">
        {% assign item_count = 0 %}
        {% for header in headers %}
          {% if header contains 'id="' %}
            {% assign level = header | slice: 0, 1 %}
            {% if level == "2" %}
              {% assign id_start = header | split: 'id="' | last %}
              {% assign id = id_start | split: '"' | first %}
              {% assign title_start = header | split: '>' | slice: 1 | join: '>' %}
              {% assign title = title_start | split: '</h' | first | strip_html %}
              {% assign item_count = item_count | plus: 1 %}
              <a href="#{{ id }}" class="toc-card-item" data-index="{{ item_count }}">
                <span class="toc-item-number">{{ item_count }}</span>
                <span class="toc-item-text">{{ title }}</span>
                <svg class="toc-item-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
              </a>
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>

      <!-- 하위 목차 (h3) - 펼치면 표시 -->
      <div class="toc-sublist" id="toc-sublist">
        {% assign current_h2 = 0 %}
        {% for header in headers %}
          {% if header contains 'id="' %}
            {% assign level = header | slice: 0, 1 %}
            {% if level == "2" %}
              {% assign current_h2 = current_h2 | plus: 1 %}
            {% elsif level == "3" %}
              {% assign id_start = header | split: 'id="' | last %}
              {% assign id = id_start | split: '"' | first %}
              {% assign title_start = header | split: '>' | slice: 1 | join: '>' %}
              {% assign title = title_start | split: '</h' | first | strip_html %}
              <a href="#{{ id }}" class="toc-sub-item" data-parent="{{ current_h2 }}">
                <span class="toc-sub-bullet"></span>
                <span class="toc-sub-text">{{ title }}</span>
              </a>
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>
    </nav>
  </div>
</div>

<script>
(function() {
  const tocToggle = document.getElementById('toc-toggle');
  const tocContent = document.getElementById('toc-content');
  const tocSublist = document.getElementById('toc-sublist');
  const tocCount = document.getElementById('toc-count');
  const tocItems = document.querySelectorAll('.toc-card-item');
  const tocSubItems = document.querySelectorAll('.toc-sub-item');

  if (!tocToggle || !tocContent) return;

  // 항목 수 표시
  if (tocCount && tocItems.length > 0) {
    tocCount.textContent = tocItems.length + '개 섹션';
  }

   // 기본: h3 숨김, 4개 이상이면 미리보기
   const maxPreview = 6;
   let isExpanded = false;

   // CLS 최적화: 초기 컨테이너 높이 설정
   const tocContainer = tocContent.closest('.toc-container');
   if (tocContainer) {
     // 초기 높이 계산 및 설정 (CLS 방지)
     const initialHeight = tocContent.offsetHeight;
     tocContainer.style.minHeight = initialHeight + 'px';
     tocContainer.style.contain = 'layout style';
   }

   // 초기 상태: h3 숨김
   if (tocSublist) {
     tocSublist.style.display = 'none';
   }

  // 6개 초과 시 일부만 표시
  if (tocItems.length > maxPreview) {
    tocItems.forEach((item, index) => {
      if (index >= maxPreview) {
        item.classList.add('toc-hidden');
      }
    });
    tocToggle.querySelector('.btn-text').textContent = '+' + (tocItems.length - maxPreview) + ' 더보기';
  } else {
    tocToggle.querySelector('.btn-text').textContent = '상세보기';
  }

   // 토글 버튼 클릭
   tocToggle.addEventListener('click', function() {
     isExpanded = !isExpanded;

     // CLS 최적화: 높이 전환 전 계산
     const currentHeight = tocContent.offsetHeight;
     let targetHeight;

     if (isExpanded) {
       // 전체 펼치기
       tocItems.forEach(item => item.classList.remove('toc-hidden'));
       if (tocSublist && tocSubItems.length > 0) {
         tocSublist.style.display = 'block';
       }

       // 펼친 후 높이 계산
       targetHeight = tocContent.offsetHeight;

       // CLS 최적화: 컨테이너 높이 업데이트
       if (tocContainer) {
         tocContainer.style.minHeight = targetHeight + 'px';
       }

       tocToggle.querySelector('.btn-text').textContent = '접기';
       tocToggle.classList.add('expanded');
      } else {
       // 접기
       if (tocItems.length > maxPreview) {
         tocItems.forEach((item, index) => {
           if (index >= maxPreview) {
             item.classList.add('toc-hidden');
           }
         });
         tocToggle.querySelector('.btn-text').textContent = '+' + (tocItems.length - maxPreview) + ' 더보기';
       } else {
         tocToggle.querySelector('.btn-text').textContent = '상세보기';
       }
       if (tocSublist) {
         tocSublist.style.display = 'none';
       }

       // 접힌 후 높이 계산
       targetHeight = tocContent.offsetHeight;

       // CLS 최적화: 컨테이너 높이 업데이트
       if (tocContainer) {
         tocContainer.style.minHeight = targetHeight + 'px';
       }

       tocToggle.classList.remove('expanded');
    }
  });

  // Update TOC links after headings get IDs (wait for heading ID generation)
  function updateTocLinks() {
    const tocLinks = document.querySelectorAll('.toc-card-item, .toc-sub-item');
    tocLinks.forEach(link => {
      const href = link.getAttribute('href');
      if (!href || href === '#') return;
      
      const targetId = href.substring(1);
      const targetEl = document.getElementById(targetId);
      
      // If target doesn't exist, try to find heading by text content
      if (!targetEl) {
        const linkText = link.textContent.trim();
        const headings = document.querySelectorAll('.post-content h1, .post-content h2, .post-content h3, .post-content h4, .post-content h5, .post-content h6');
        
        headings.forEach(heading => {
          const headingText = heading.textContent.trim().replace(/^#+\s*/, '');
          if (headingText === linkText && heading.id) {
            link.setAttribute('href', '#' + heading.id);
          }
        });
      }
    });
  }
  
  // Wait for heading IDs to be generated, then update TOC links
  setTimeout(updateTocLinks, 100);
  
  // Also update after a short delay to catch any late-generated IDs
  setTimeout(updateTocLinks, 500);

  // 스무스 스크롤
  document.querySelectorAll('.toc-card-item, .toc-sub-item').forEach(link => {
    link.addEventListener('click', function(e) {
      const href = this.getAttribute('href');
      if (!href || href === '#') return;

      const targetId = href.substring(1);
      let targetEl = document.getElementById(targetId);
      
      // If target not found, try to find by text content
      if (!targetEl) {
        const linkText = this.textContent.trim();
        const headings = document.querySelectorAll('.post-content h1, .post-content h2, .post-content h3, .post-content h4, .post-content h5, .post-content h6');
        
        headings.forEach(heading => {
          const headingText = heading.textContent.trim().replace(/^#+\s*/, '');
          if (headingText === linkText) {
            targetEl = heading;
          }
        });
      }

      if (targetEl) {
        e.preventDefault();
        const headerHeight = document.querySelector('.site-header')?.offsetHeight || 70;
        const targetPosition = targetEl.getBoundingClientRect().top + window.pageYOffset - headerHeight - 20;

        window.scrollTo({
          top: targetPosition,
          behavior: 'smooth'
        });
        history.pushState(null, null, '#' + (targetEl.id || targetId));
      }
    });
  });

  // 스크롤 시 현재 섹션 하이라이트
  let ticking = false;
  window.addEventListener('scroll', function() {
    if (!ticking) {
      requestAnimationFrame(function() {
        highlightCurrentSection();
        ticking = false;
      });
      ticking = true;
    }
  });

  function highlightCurrentSection() {
    const scrollPosition = window.pageYOffset + 100;

    tocItems.forEach(item => {
      const href = item.getAttribute('href');
      if (!href) return;

      const targetId = href.substring(1);
      let section = document.getElementById(targetId);
      
      // If section not found by ID, try to find by text content
      if (!section) {
        const linkText = item.textContent.trim();
        const headings = document.querySelectorAll('.post-content h1, .post-content h2, .post-content h3, .post-content h4, .post-content h5, .post-content h6');
        
        headings.forEach(heading => {
          const headingText = heading.textContent.trim().replace(/^#+\s*/, '');
          if (headingText === linkText) {
            section = heading;
          }
        });
      }

      if (section) {
        const sectionTop = section.offsetTop;
        const sectionBottom = sectionTop + section.offsetHeight;

        if (scrollPosition >= sectionTop && scrollPosition < sectionBottom) {
          tocItems.forEach(i => i.classList.remove('active'));
          item.classList.add('active');
        }
      }
    });
  }

  highlightCurrentSection();
})();
</script>
{% endif %}
{% endif %}
