{% if include.content %}
{% assign headers = include.content | split: '<h' %}
{% if headers.size > 2 %}
<div class="toc-container">
  <div class="toc-card">
    <div class="toc-header">
      <div class="toc-title-section">
        <div class="toc-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </div>
        <h4 class="toc-title">목차</h4>
        <span class="toc-count" id="toc-count"></span>
      </div>
      <button class="toc-expand-btn" id="toc-toggle" aria-label="목차 펼치기/접기">
        <span class="btn-text">전체보기</span>
        <svg class="chevron-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 12 15 18 9"/>
        </svg>
      </button>
    </div>

    <nav class="toc-nav" id="toc-content" aria-label="Table of Contents">
      <div class="toc-grid">
        {% assign item_count = 0 %}
        {% for header in headers %}
          {% if header contains 'id="' %}
            {% assign level = header | slice: 0, 1 %}
            {% if level == "2" %}
              {% assign id_start = header | split: 'id="' | last %}
              {% assign id = id_start | split: '"' | first %}
              {% assign title_start = header | split: '>' | slice: 1 | join: '>' %}
              {% assign title = title_start | split: '</h' | first | strip_html %}
              {% assign item_count = item_count | plus: 1 %}
              <a href="#{{ id }}" class="toc-card-item" data-index="{{ item_count }}">
                <span class="toc-item-number">{{ item_count }}</span>
                <span class="toc-item-text">{{ title }}</span>
                <svg class="toc-item-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
              </a>
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>
    </nav>
  </div>
</div>

<script>
(function() {
  const tocToggle = document.getElementById('toc-toggle');
  const tocContent = document.getElementById('toc-content');
  const tocCount = document.getElementById('toc-count');
  const tocItems = document.querySelectorAll('.toc-card-item');

  if (!tocToggle || !tocContent) return;

  // 항목 수 표시
  if (tocCount && tocItems.length > 0) {
    tocCount.textContent = tocItems.length + '개 섹션';
  }

  // 기본 설정
  const maxPreview = 6;
  let isExpanded = false;

  // 6개 초과 시 일부만 표시, 아니면 버튼 숨김
  if (tocItems.length > maxPreview) {
    tocItems.forEach((item, index) => {
      if (index >= maxPreview) {
        item.classList.add('toc-hidden');
      }
    });
    tocToggle.querySelector('.btn-text').textContent = '+' + (tocItems.length - maxPreview) + ' 더보기';
  } else {
    tocToggle.style.display = 'none';
  }

  // 토글 버튼 클릭
  tocToggle.addEventListener('click', function() {
    isExpanded = !isExpanded;

    if (isExpanded) {
      // 전체 펼치기
      tocItems.forEach(item => item.classList.remove('toc-hidden'));
      tocToggle.querySelector('.btn-text').textContent = '접기';
      tocToggle.classList.add('expanded');
    } else {
      // 접기
      if (tocItems.length > maxPreview) {
        tocItems.forEach((item, index) => {
          if (index >= maxPreview) {
            item.classList.add('toc-hidden');
          }
        });
        tocToggle.querySelector('.btn-text').textContent = '+' + (tocItems.length - maxPreview) + ' 더보기';
      }
      tocToggle.classList.remove('expanded');
    }
  });

  // Update TOC links after headings get IDs
  function updateTocLinks() {
    const tocLinks = document.querySelectorAll('.toc-card-item');
    tocLinks.forEach(link => {
      const href = link.getAttribute('href');
      if (!href || href === '#') return;
      
      const targetId = href.substring(1);
      const targetEl = document.getElementById(targetId);
      
      if (!targetEl) {
        const linkText = link.textContent.trim();
        const headings = document.querySelectorAll('.post-content h2');
        
        headings.forEach(heading => {
          const headingText = heading.textContent.trim().replace(/^#+\s*/, '');
          if (headingText === linkText && heading.id) {
            link.setAttribute('href', '#' + heading.id);
          }
        });
      }
    });
  }
  
  setTimeout(updateTocLinks, 100);
  setTimeout(updateTocLinks, 500);

  // 스무스 스크롤
  document.querySelectorAll('.toc-card-item').forEach(link => {
    link.addEventListener('click', function(e) {
      const href = this.getAttribute('href');
      if (!href || href === '#') return;

      const targetId = href.substring(1);
      let targetEl = document.getElementById(targetId);
      
      if (!targetEl) {
        const linkText = this.textContent.trim();
        const headings = document.querySelectorAll('.post-content h2');
        
        headings.forEach(heading => {
          const headingText = heading.textContent.trim().replace(/^#+\s*/, '');
          if (headingText === linkText) {
            targetEl = heading;
          }
        });
      }

      if (targetEl) {
        e.preventDefault();
        const headerHeight = document.querySelector('.site-header')?.offsetHeight || 70;
        const targetPosition = targetEl.getBoundingClientRect().top + window.pageYOffset - headerHeight - 20;

        window.scrollTo({
          top: targetPosition,
          behavior: 'smooth'
        });
        history.pushState(null, null, '#' + (targetEl.id || targetId));
      }
    });
  });

  // 스크롤 시 현재 섹션 하이라이트
  let ticking = false;
  window.addEventListener('scroll', function() {
    if (!ticking) {
      requestAnimationFrame(function() {
        highlightCurrentSection();
        ticking = false;
      });
      ticking = true;
    }
  });

  function highlightCurrentSection() {
    const scrollPosition = window.pageYOffset + 100;

    tocItems.forEach(item => {
      const href = item.getAttribute('href');
      if (!href) return;

      const targetId = href.substring(1);
      let section = document.getElementById(targetId);
      
      if (!section) {
        const linkText = item.textContent.trim();
        const headings = document.querySelectorAll('.post-content h2');
        
        headings.forEach(heading => {
          const headingText = heading.textContent.trim().replace(/^#+\s*/, '');
          if (headingText === linkText) {
            section = heading;
          }
        });
      }

      if (section) {
        const sectionTop = section.offsetTop;
        const sectionBottom = sectionTop + section.offsetHeight;

        if (scrollPosition >= sectionTop && scrollPosition < sectionBottom) {
          tocItems.forEach(i => i.classList.remove('active'));
          item.classList.add('active');
        }
      }
    });
  }

  highlightCurrentSection();
})();
</script>
{% endif %}
{% endif %}
