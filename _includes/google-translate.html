<!-- Google Translate Integration - 시스템 언어 설정 우선 -->
<script type="text/javascript">
// Google Translate 초기화
function googleTranslateElementInit() {
  new google.translate.TranslateElement({
    pageLanguage: 'ko',
    includedLanguages: 'en,ja,zh-CN,zh-TW',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
    autoDisplay: false
  }, 'google_translate_element');
}

// 언어 토글 초기화
(function() {
  'use strict';

  var LANG_MAP = {
    'ko': 'KO',
    'en': 'EN',
    'ja': 'JA',
    'zh-CN': 'CN',
    'zh-TW': 'TW',
    'zh': 'CN'
  };

  var SUPPORTED_LANGS = ['ko', 'en', 'ja', 'zh-CN', 'zh-TW'];

  // 시스템 언어 감지
  function getSystemLanguage() {
    var lang = navigator.language || navigator.userLanguage || 'ko';
    lang = lang.toLowerCase();

    if (lang.startsWith('ko')) return 'ko';
    if (lang.startsWith('ja')) return 'ja';
    if (lang.startsWith('zh-tw') || lang.startsWith('zh-hant')) return 'zh-TW';
    if (lang.startsWith('zh')) return 'zh-CN';
    if (lang.startsWith('en')) return 'en';

    return 'ko';
  }

  // 저장된 언어 또는 시스템 언어 가져오기
  function getPreferredLanguage() {
    var saved = localStorage.getItem('preferredLang');
    if (!saved || saved === 'system') {
      return getSystemLanguage();
    }
    return saved;
  }

  function initLangToggle() {
    var langToggle = document.getElementById('lang-toggle');
    var langDropdown = document.getElementById('lang-dropdown');
    var currentLangSpan = document.getElementById('current-lang');

    if (!langToggle || !langDropdown) {
      return;
    }

    // 토글 버튼 클릭
    langToggle.onclick = function(e) {
      e.preventDefault();
      e.stopPropagation();

      var isActive = langDropdown.classList.contains('active');

      if (isActive) {
        langDropdown.classList.remove('active');
        langToggle.setAttribute('aria-expanded', 'false');
      } else {
        langDropdown.classList.add('active');
        langToggle.setAttribute('aria-expanded', 'true');
      }
    };

    // 더블클릭으로 시스템 설정으로 복귀
    langToggle.ondblclick = function(e) {
      e.preventDefault();
      e.stopPropagation();
      localStorage.setItem('preferredLang', 'system');
      var sysLang = getSystemLanguage();
      if (LANG_MAP[sysLang] && currentLangSpan) {
        currentLangSpan.textContent = LANG_MAP[sysLang];
      }
      changeLang(sysLang);
    };

    // 외부 클릭 시 닫기
    document.addEventListener('click', function(e) {
      if (!langToggle.contains(e.target) && !langDropdown.contains(e.target)) {
        langDropdown.classList.remove('active');
        langToggle.setAttribute('aria-expanded', 'false');
      }
    });

    // 언어 옵션 클릭
    var langOptions = document.querySelectorAll('.lang-option');
    for (var i = 0; i < langOptions.length; i++) {
      langOptions[i].onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();

        var lang = this.getAttribute('data-lang');

        // 드롭다운 닫기
        langDropdown.classList.remove('active');
        langToggle.setAttribute('aria-expanded', 'false');

        // 언어 표시 업데이트
        if (LANG_MAP[lang] && currentLangSpan) {
          currentLangSpan.textContent = LANG_MAP[lang];
        }

        // 수동 선택 시 저장
        localStorage.setItem('preferredLang', lang);

        // 언어 변경
        changeLang(lang);
      };
    }

    // 현재 언어 감지 및 표시
    var currentLang = getCurrentLang();
    if (LANG_MAP[currentLang] && currentLangSpan) {
      currentLangSpan.textContent = LANG_MAP[currentLang];
    }

    // 첫 방문 시 시스템 언어로 자동 번역
    autoTranslateOnFirstVisit();
  }

  function getCurrentLang() {
    var match = document.cookie.match(/googtrans=\/ko\/([^;]+)/);
    return match ? match[1] : 'ko';
  }

  function autoTranslateOnFirstVisit() {
    // 이미 번역 쿠키가 있으면 스킵
    if (document.cookie.indexOf('googtrans=') !== -1) {
      return;
    }

    // 이미 방문한 적 있으면 스킵
    if (localStorage.getItem('hasVisited')) {
      return;
    }

    localStorage.setItem('hasVisited', 'true');

    var preferredLang = getPreferredLanguage();

    // 한국어가 아닌 경우 자동 번역
    if (preferredLang !== 'ko' && SUPPORTED_LANGS.indexOf(preferredLang) !== -1) {
      setTimeout(function() {
        changeLang(preferredLang);
      }, 1500);
    }
  }

  function changeLang(lang) {
    if (lang === 'ko') {
      document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
      document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=.' + location.hostname;
      location.reload();
      return;
    }

    var cookieVal = '/ko/' + lang;
    document.cookie = 'googtrans=' + cookieVal + '; path=/;';
    document.cookie = 'googtrans=' + cookieVal + '; path=/; domain=.' + location.hostname;

    var select = document.querySelector('.goog-te-combo');
    if (select) {
      select.value = lang;
      select.dispatchEvent(new Event('change'));
    } else {
      location.reload();
    }
  }

  // Google Translate가 삽입한 font 태그 제거
  function cleanupFontTags() {
    var selectors = [
      '.notranslate font',
      '[translate="no"] font',
      '.lang-toggle font',
      '.lang-code font',
      '.chat-widget font'
    ];

    selectors.forEach(function(selector) {
      var fonts = document.querySelectorAll(selector);
      fonts.forEach(function(font) {
        var parent = font.parentNode;
        while (font.firstChild) {
          parent.insertBefore(font.firstChild, font);
        }
        parent.removeChild(font);
      });
    });
  }

  // Google Translate 배너/팝업 강제 숨김
  function hideGoogleTranslateBanner() {
    var banners = document.querySelectorAll(
      '.goog-te-banner-frame, [class*="VIpgJd"], #goog-gt-tt, .goog-te-balloon-frame'
    );
    banners.forEach(function(el) {
      el.style.display = 'none';
      el.style.visibility = 'hidden';
    });

    // body top 강제 리셋
    if (document.body) {
      document.body.style.top = '0';
    }
  }

  // DOM 준비 시 초기화
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      initLangToggle();
      cleanupFontTags();
      hideGoogleTranslateBanner();
    });
  } else {
    initLangToggle();
    cleanupFontTags();
    hideGoogleTranslateBanner();
  }

  // 주기적으로 정리 실행 (Google Translate가 나중에 요소를 추가할 수 있음)
  setInterval(function() {
    cleanupFontTags();
    hideGoogleTranslateBanner();
  }, 1000);
})();
</script>
<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
