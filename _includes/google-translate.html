<!-- Google Translate Integration - 시스템 언어 설정 자동 적용 -->
<script type="text/javascript">
// Google Translate 초기화 (지연 로딩)
var googleTranslateLoaded = false;

function googleTranslateElementInit() {
  new google.translate.TranslateElement({
    pageLanguage: 'ko',
    includedLanguages: 'en,ja,zh-CN,zh-TW',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
    autoDisplay: false
  }, 'google_translate_element');
  googleTranslateLoaded = true;
}

// 언어 토글 초기화
(function() {
  'use strict';

  var LANG_MAP = {
    'ko': 'KO',
    'en': 'EN',
    'ja': 'JA',
    'zh-CN': 'CN',
    'zh-TW': 'TW',
    'zh': 'CN'
  };

  var SUPPORTED_LANGS = ['ko', 'en', 'ja', 'zh-CN', 'zh-TW'];
  var translateScriptLoaded = false;

  // 시스템 언어 감지
  function getSystemLanguage() {
    var lang = navigator.language || navigator.userLanguage || 'ko';
    lang = lang.toLowerCase();

    if (lang.startsWith('ko')) return 'ko';
    if (lang.startsWith('ja')) return 'ja';
    if (lang.startsWith('zh-tw') || lang.startsWith('zh-hant')) return 'zh-TW';
    if (lang.startsWith('zh')) return 'zh-CN';
    if (lang.startsWith('en')) return 'en';

    return 'ko';
  }

  // 저장된 언어 또는 시스템 언어 가져오기
  function getPreferredLanguage() {
    var saved = localStorage.getItem('preferredLang');
    if (!saved || saved === 'system') {
      return getSystemLanguage();
    }
    return saved;
  }

  // Google Translate 스크립트 지연 로딩
  function loadTranslateScript(callback) {
    if (translateScriptLoaded) {
      if (callback) callback();
      return;
    }

    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = '//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
    script.onload = function() {
      translateScriptLoaded = true;
      if (callback) {
        // Google Translate 초기화 대기
        setTimeout(callback, 500);
      }
    };
    document.head.appendChild(script);
  }

  function initLangToggle() {
    var langToggle = document.getElementById('lang-toggle');
    var langDropdown = document.getElementById('lang-dropdown');
    var currentLangSpan = document.getElementById('current-lang');

    if (!langToggle || !langDropdown) {
      return;
    }

    // 토글 버튼 클릭 - addEventListener 사용
    langToggle.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();

      var isActive = langDropdown.classList.contains('active');

      if (isActive) {
        langDropdown.classList.remove('active');
        langToggle.setAttribute('aria-expanded', 'false');
      } else {
        langDropdown.classList.add('active');
        langToggle.setAttribute('aria-expanded', 'true');
      }
    }, true);

    // 더블클릭으로 시스템 설정으로 복귀
    langToggle.addEventListener('dblclick', function(e) {
      e.preventDefault();
      e.stopPropagation();
      localStorage.setItem('preferredLang', 'system');
      var sysLang = getSystemLanguage();
      if (LANG_MAP[sysLang] && currentLangSpan) {
        currentLangSpan.textContent = LANG_MAP[sysLang];
      }
      // 시스템 언어로 복귀 시 플래그 초기화
      sessionStorage.removeItem('langApplied');
      sessionStorage.removeItem('langChanging');
      changeLang(sysLang);
    }, true);

    // 외부 클릭 시 닫기
    document.addEventListener('click', function(e) {
      var target = e.target;
      while (target && target.tagName === 'FONT') {
        target = target.parentNode;
      }
      if (!langToggle.contains(target) && !langDropdown.contains(target)) {
        langDropdown.classList.remove('active');
        langToggle.setAttribute('aria-expanded', 'false');
      }
    });

    // 언어 옵션 클릭 - 이벤트 위임 사용
    langDropdown.addEventListener('click', function(e) {
      var target = e.target;
      while (target && !target.classList.contains('lang-option')) {
        if (target === langDropdown) {
          return;
        }
        target = target.parentNode;
      }

      if (target && target.classList.contains('lang-option')) {
        e.preventDefault();
        e.stopPropagation();

        var lang = target.getAttribute('data-lang');

        langDropdown.classList.remove('active');
        langToggle.setAttribute('aria-expanded', 'false');

        if (LANG_MAP[lang] && currentLangSpan) {
          currentLangSpan.textContent = LANG_MAP[lang];
        }

        localStorage.setItem('preferredLang', lang);
        // 수동 언어 변경 시 플래그 초기화
        sessionStorage.removeItem('langApplied');
        sessionStorage.removeItem('langChanging');
        changeLang(lang);
      }
    }, true);

    // 현재 언어 감지 및 표시
    var currentLang = getCurrentLang();
    if (LANG_MAP[currentLang] && currentLangSpan) {
      currentLangSpan.textContent = LANG_MAP[currentLang];
    }

    // 시스템 언어 자동 적용
    applySystemLanguage();
  }

  function getCurrentLang() {
    // 쿠키에서 언어 정보 읽기
    var match = document.cookie.match(/googtrans=\/ko\/([^;]+)/);
    if (match && match[1]) {
      return match[1];
    }
    
    // 쿠키가 없으면 한국어로 간주
    return 'ko';
  }

  // 시스템 언어 자동 적용 (한 번만 실행)
  function applySystemLanguage() {
    // 이미 실행되었는지 확인 (무한 루프 방지)
    var appliedFlag = sessionStorage.getItem('langApplied');
    if (appliedFlag === 'true') {
      return;
    }

    var currentLang = getCurrentLang();
    var preferredLang = getPreferredLanguage();
    var savedPref = localStorage.getItem('preferredLang');

    // 사용자가 수동으로 선택한 경우 그 설정 유지
    if (savedPref && savedPref !== 'system' && savedPref === currentLang) {
      sessionStorage.setItem('langApplied', 'true');
      return;
    }

    // 시스템 언어와 현재 언어가 다르면 변경
    if (preferredLang !== currentLang) {
      // 플래그 설정 (무한 루프 방지)
      sessionStorage.setItem('langApplied', 'true');
      
      // Google Translate 스크립트 로딩 후 언어 변경
      if (preferredLang !== 'ko') {
        loadTranslateScript(function() {
          setTimeout(function() {
            changeLang(preferredLang);
          }, 300);
        });
      } else if (currentLang !== 'ko') {
        // 시스템 언어가 한국어인데 현재 다른 언어로 번역되어 있으면 원본으로
        changeLang('ko');
      }
    } else {
      // 이미 올바른 언어면 플래그 설정
      sessionStorage.setItem('langApplied', 'true');
      
      if (preferredLang !== 'ko' && !translateScriptLoaded) {
        // 이미 올바른 언어지만 스크립트 로딩 필요
        loadTranslateScript();
      }
    }
  }

  function changeLang(lang) {
    // 무한 루프 방지: 이미 언어 변경이 진행 중이면 중단
    var changingFlag = sessionStorage.getItem('langChanging');
    if (changingFlag === 'true') {
      return;
    }
    
    // 언어 변경 시작 플래그 설정
    sessionStorage.setItem('langChanging', 'true');
    
    if (lang === 'ko') {
      document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
      document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=.' + location.hostname;
      
      // 쿠키 설정 후 짧은 지연 후 리로드 (쿠키가 확실히 설정되도록)
      setTimeout(function() {
        location.reload();
      }, 100);
      return;
    }

    var cookieVal = '/ko/' + lang;
    document.cookie = 'googtrans=' + cookieVal + '; path=/;';
    document.cookie = 'googtrans=' + cookieVal + '; path=/; domain=.' + location.hostname;

    var select = document.querySelector('.goog-te-combo');
    if (select) {
      select.value = lang;
      select.dispatchEvent(new Event('change'));
      // 언어 변경 완료 플래그 설정
      sessionStorage.setItem('langChanging', 'false');
      sessionStorage.setItem('langApplied', 'true');
    } else {
      // 쿠키 설정 후 짧은 지연 후 리로드 (쿠키가 확실히 설정되도록)
      setTimeout(function() {
        location.reload();
      }, 100);
    }
  }

  // Google Translate가 삽입한 font 태그 제거
  function cleanupFontTags() {
    var selectors = [
      '.notranslate font',
      '[translate="no"] font',
      '.lang-toggle font',
      '.lang-code font',
      '.chat-widget font'
    ];

    selectors.forEach(function(selector) {
      var fonts = document.querySelectorAll(selector);
      fonts.forEach(function(font) {
        var parent = font.parentNode;
        while (font.firstChild) {
          parent.insertBefore(font.firstChild, font);
        }
        parent.removeChild(font);
      });
    });
  }

  // Google Translate 배너/팝업 강제 숨김
  function hideGoogleTranslateBanner() {
    var banners = document.querySelectorAll(
      '.goog-te-banner-frame, [class*="VIpgJd"], #goog-gt-tt, .goog-te-balloon-frame'
    );
    banners.forEach(function(el) {
      el.style.display = 'none';
      el.style.visibility = 'hidden';
    });

    if (document.body) {
      document.body.style.top = '0';
    }
  }

  // DOM 준비 시 초기화
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      // 페이지 로드 후 짧은 지연으로 언어 적용 (쿠키가 확실히 읽히도록)
      setTimeout(function() {
        initLangToggle();
        cleanupFontTags();
        hideGoogleTranslateBanner();
      }, 100);
    });
  } else {
    // 페이지 로드 후 짧은 지연으로 언어 적용 (쿠키가 확실히 읽히도록)
    setTimeout(function() {
      initLangToggle();
      cleanupFontTags();
      hideGoogleTranslateBanner();
    }, 100);
  }

  // 주기적으로 정리 실행 (간격 늘림 - 성능 최적화)
  setInterval(function() {
    cleanupFontTags();
    hideGoogleTranslateBanner();
  }, 2000);

  // 한국어 사이트이고 시스템 언어도 한국어면 스크립트 로딩 안함
  // 다른 언어면 필요시 로딩
  var sysLang = getSystemLanguage();
  var currentLang = getCurrentLang();

  // 번역이 필요한 경우에만 스크립트 로딩
  if (sysLang !== 'ko' || currentLang !== 'ko') {
    // 페이지 로드 완료 후 지연 로딩
    if (document.readyState === 'complete') {
      setTimeout(loadTranslateScript, 100);
    } else {
      window.addEventListener('load', function() {
        setTimeout(loadTranslateScript, 100);
      });
    }
  }
})();
</script>
