<!-- Google Translate Integration - ì‹œìŠ¤í…œ ì–¸ì–´ ì„¤ì • ìë™ ì ìš© -->
<script type="text/javascript">
// Google Translate ì´ˆê¸°í™” (ì§€ì—° ë¡œë”©)
var googleTranslateLoaded = false;

function googleTranslateElementInit() {
  new google.translate.TranslateElement({
    pageLanguage: 'ko',
    includedLanguages: 'en,ja,zh-CN,zh-TW',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
    autoDisplay: false
  }, 'google_translate_element');
  googleTranslateLoaded = true;
}

// ì–¸ì–´ í† ê¸€ ì´ˆê¸°í™”
(function() {
  'use strict';

  var LANG_MAP = {
    'ko': 'KO',
    'en': 'EN',
    'ja': 'JA',
    'zh-CN': 'CN',
    'zh-TW': 'TW',
    'zh': 'CN'
  };

  var SUPPORTED_LANGS = ['ko', 'en', 'ja', 'zh-CN', 'zh-TW'];
  var translateScriptLoaded = false;

  // ì‹œìŠ¤í…œ ì–¸ì–´ ê°ì§€
  function getSystemLanguage() {
    var lang = navigator.language || navigator.userLanguage || 'ko';
    lang = lang.toLowerCase();

    if (lang.startsWith('ko')) return 'ko';
    if (lang.startsWith('ja')) return 'ja';
    if (lang.startsWith('zh-tw') || lang.startsWith('zh-hant')) return 'zh-TW';
    if (lang.startsWith('zh')) return 'zh-CN';
    if (lang.startsWith('en')) return 'en';

    return 'ko';
  }

  // ì €ì¥ëœ ì–¸ì–´ ë˜ëŠ” ì‹œìŠ¤í…œ ì–¸ì–´ ê°€ì ¸ì˜¤ê¸°
  function getPreferredLanguage() {
    var saved = localStorage.getItem('preferredLang');
    if (!saved || saved === 'system') {
      return getSystemLanguage();
    }
    return saved;
  }

  // Google Translate ìŠ¤í¬ë¦½íŠ¸ ì§€ì—° ë¡œë”©
  function loadTranslateScript(callback) {
    if (translateScriptLoaded) {
      if (callback) callback();
      return;
    }

    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = '//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
    script.onload = function() {
      translateScriptLoaded = true;
      if (callback) {
        // Google Translate ì´ˆê¸°í™” ëŒ€ê¸°
        setTimeout(callback, 500);
      }
    };
    document.head.appendChild(script);
  }

  function initLangToggle() {
    var langToggle = document.getElementById('lang-toggle');
    var langDropdown = document.getElementById('lang-dropdown');
    var currentLangSpan = document.getElementById('current-lang');

    if (!langToggle || !langDropdown) {
      return;
    }

    // í† ê¸€ ë²„íŠ¼ í´ë¦­ - addEventListener ì‚¬ìš©
    langToggle.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();

      var isActive = langDropdown.classList.contains('active');

      if (isActive) {
        langDropdown.classList.remove('active');
        langToggle.setAttribute('aria-expanded', 'false');
      } else {
        langDropdown.classList.add('active');
        langToggle.setAttribute('aria-expanded', 'true');
      }
    }, true);

    // ë”ë¸”í´ë¦­ìœ¼ë¡œ ì‹œìŠ¤í…œ ì„¤ì •ìœ¼ë¡œ ë³µê·€
    langToggle.addEventListener('dblclick', function(e) {
      e.preventDefault();
      e.stopPropagation();
      localStorage.setItem('preferredLang', 'system');
      var sysLang = getSystemLanguage();
      if (LANG_MAP[sysLang] && currentLangSpan) {
        currentLangSpan.textContent = LANG_MAP[sysLang];
      }
      // ì‹œìŠ¤í…œ ì–¸ì–´ë¡œ ë³µê·€ ì‹œ í”Œë˜ê·¸ ì´ˆê¸°í™”
      sessionStorage.removeItem('langApplied');
      sessionStorage.removeItem('langChanging');
      changeLang(sysLang);
    }, true);

    // ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.addEventListener('click', function(e) {
      var target = e.target;
      while (target && target.tagName === 'FONT') {
        target = target.parentNode;
      }
      if (!langToggle.contains(target) && !langDropdown.contains(target)) {
        langDropdown.classList.remove('active');
        langToggle.setAttribute('aria-expanded', 'false');
      }
    });

    // ì–¸ì–´ ì˜µì…˜ í´ë¦­ - ì´ë²¤íŠ¸ ìœ„ì„ ì‚¬ìš©
    langDropdown.addEventListener('click', function(e) {
      var target = e.target;
      
      // font íƒœê·¸ë‚˜ í…ìŠ¤íŠ¸ ë…¸ë“œë¥¼ í†µê³¼í•˜ì—¬ lang-option ì°¾ê¸°
      while (target && !target.classList.contains('lang-option')) {
        if (target === langDropdown || target === document.body) {
          return;
        }
        target = target.parentNode;
      }

      if (target && target.classList.contains('lang-option')) {
        e.preventDefault();
        e.stopPropagation();

        var lang = target.getAttribute('data-lang');
        
        // lang ì†ì„±ì´ ì—†ìœ¼ë©´ í…ìŠ¤íŠ¸ì—ì„œ ì¶”ì¶œ ì‹œë„
        if (!lang) {
          var text = target.textContent.trim();
          if (text.includes('í•œêµ­ì–´') || text.includes('ğŸ‡°ğŸ‡·')) lang = 'ko';
          else if (text.includes('English') || text.includes('ğŸ‡ºğŸ‡¸')) lang = 'en';
          else if (text.includes('æ—¥æœ¬èª') || text.includes('ğŸ‡¯ğŸ‡µ')) lang = 'ja';
          else if (text.includes('ç®€ä½“ä¸­æ–‡') || text.includes('ğŸ‡¨ğŸ‡³')) lang = 'zh-CN';
          else if (text.includes('ç¹é«”ä¸­æ–‡') || text.includes('ğŸ‡¹ğŸ‡¼')) lang = 'zh-TW';
        }

        if (lang) {
          langDropdown.classList.remove('active');
          langToggle.setAttribute('aria-expanded', 'false');

          if (LANG_MAP[lang] && currentLangSpan) {
            currentLangSpan.textContent = LANG_MAP[lang];
          }

          localStorage.setItem('preferredLang', lang);
          // ìˆ˜ë™ ì–¸ì–´ ë³€ê²½ ì‹œ í”Œë˜ê·¸ ì´ˆê¸°í™”
          sessionStorage.removeItem('langApplied');
          sessionStorage.removeItem('langChanging');
          changeLang(lang);
        }
      }
    }, true);

    // í˜„ì¬ ì–¸ì–´ ê°ì§€ ë° í‘œì‹œ
    var currentLang = getCurrentLang();
    if (LANG_MAP[currentLang] && currentLangSpan) {
      currentLangSpan.textContent = LANG_MAP[currentLang];
    }

    // ì‹œìŠ¤í…œ ì–¸ì–´ ìë™ ì ìš©
    applySystemLanguage();
  }

  function getCurrentLang() {
    // ì¿ í‚¤ì—ì„œ ì–¸ì–´ ì •ë³´ ì½ê¸°
    var match = document.cookie.match(/googtrans=\/ko\/([^;]+)/);
    if (match && match[1]) {
      return match[1];
    }
    
    // ì¿ í‚¤ê°€ ì—†ìœ¼ë©´ í•œêµ­ì–´ë¡œ ê°„ì£¼
    return 'ko';
  }

  // ì‹œìŠ¤í…œ ì–¸ì–´ ìë™ ì ìš© (í•œ ë²ˆë§Œ ì‹¤í–‰)
  function applySystemLanguage() {
    // ì´ë¯¸ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€ í™•ì¸ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
    var appliedFlag = sessionStorage.getItem('langApplied');
    if (appliedFlag === 'true') {
      return;
    }

    var currentLang = getCurrentLang();
    var preferredLang = getPreferredLanguage();
    var savedPref = localStorage.getItem('preferredLang');

    // ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ì„ íƒí•œ ê²½ìš° ê·¸ ì„¤ì • ìœ ì§€
    if (savedPref && savedPref !== 'system' && savedPref === currentLang) {
      sessionStorage.setItem('langApplied', 'true');
      return;
    }

    // ì‹œìŠ¤í…œ ì–¸ì–´ì™€ í˜„ì¬ ì–¸ì–´ê°€ ë‹¤ë¥´ë©´ ë³€ê²½
    if (preferredLang !== currentLang) {
      // í”Œë˜ê·¸ ì„¤ì • (ë¬´í•œ ë£¨í”„ ë°©ì§€)
      sessionStorage.setItem('langApplied', 'true');
      
      // Google Translate ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© í›„ ì–¸ì–´ ë³€ê²½
      if (preferredLang !== 'ko') {
        loadTranslateScript(function() {
          setTimeout(function() {
            changeLang(preferredLang);
          }, 300);
        });
      } else if (currentLang !== 'ko') {
        // ì‹œìŠ¤í…œ ì–¸ì–´ê°€ í•œêµ­ì–´ì¸ë° í˜„ì¬ ë‹¤ë¥¸ ì–¸ì–´ë¡œ ë²ˆì—­ë˜ì–´ ìˆìœ¼ë©´ ì›ë³¸ìœ¼ë¡œ
        changeLang('ko');
      }
    } else {
      // ì´ë¯¸ ì˜¬ë°”ë¥¸ ì–¸ì–´ë©´ í”Œë˜ê·¸ ì„¤ì •
      sessionStorage.setItem('langApplied', 'true');
      
      if (preferredLang !== 'ko' && !translateScriptLoaded) {
        // ì´ë¯¸ ì˜¬ë°”ë¥¸ ì–¸ì–´ì§€ë§Œ ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© í•„ìš”
        loadTranslateScript();
      }
    }
  }

  function changeLang(lang) {
    // ë¬´í•œ ë£¨í”„ ë°©ì§€: ì´ë¯¸ ì–¸ì–´ ë³€ê²½ì´ ì§„í–‰ ì¤‘ì´ë©´ ì¤‘ë‹¨
    var changingFlag = sessionStorage.getItem('langChanging');
    if (changingFlag === 'true') {
      return;
    }
    
    // ì–¸ì–´ ë³€ê²½ ì‹œì‘ í”Œë˜ê·¸ ì„¤ì •
    sessionStorage.setItem('langChanging', 'true');
    
    if (lang === 'ko') {
      document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
      document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=.' + location.hostname;
      
      // ì¿ í‚¤ ì„¤ì • í›„ ì§§ì€ ì§€ì—° í›„ ë¦¬ë¡œë“œ (ì¿ í‚¤ê°€ í™•ì‹¤íˆ ì„¤ì •ë˜ë„ë¡)
      setTimeout(function() {
        location.reload();
      }, 100);
      return;
    }

    var cookieVal = '/ko/' + lang;
    document.cookie = 'googtrans=' + cookieVal + '; path=/;';
    document.cookie = 'googtrans=' + cookieVal + '; path=/; domain=.' + location.hostname;

    var select = document.querySelector('.goog-te-combo');
    if (select) {
      select.value = lang;
      select.dispatchEvent(new Event('change'));
      // ì–¸ì–´ ë³€ê²½ ì™„ë£Œ í”Œë˜ê·¸ ì„¤ì •
      sessionStorage.setItem('langChanging', 'false');
      sessionStorage.setItem('langApplied', 'true');
    } else {
      // ì¿ í‚¤ ì„¤ì • í›„ ì§§ì€ ì§€ì—° í›„ ë¦¬ë¡œë“œ (ì¿ í‚¤ê°€ í™•ì‹¤íˆ ì„¤ì •ë˜ë„ë¡)
      setTimeout(function() {
        location.reload();
      }, 100);
    }
  }

  // Google Translateê°€ ì‚½ì…í•œ font íƒœê·¸ ì œê±°
  function cleanupFontTags() {
    var selectors = [
      '.notranslate font',
      '[translate="no"] font',
      '.lang-toggle font',
      '.lang-code font',
      '.lang-dropdown font',
      '.lang-option font',
      '.chat-widget font'
    ];

    selectors.forEach(function(selector) {
      var fonts = document.querySelectorAll(selector);
      fonts.forEach(function(font) {
        var parent = font.parentNode;
        while (font.firstChild) {
          parent.insertBefore(font.firstChild, font);
        }
        parent.removeChild(font);
      });
    });
  }

  // lang-dropdownê³¼ lang-option êµ¬ì¡° ë³µêµ¬
  function restoreLangStructure() {
    var langDropdown = document.getElementById('lang-dropdown');
    if (!langDropdown) return;

    // lang-dropdownì— ì§ì ‘ ì¶”ê°€ëœ í…ìŠ¤íŠ¸ ë…¸ë“œ ì œê±°
    var childNodes = Array.from(langDropdown.childNodes);
    childNodes.forEach(function(node) {
      if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
        // í…ìŠ¤íŠ¸ ë…¸ë“œê°€ ìˆê³  ë²„íŠ¼ì´ ì•„ë‹Œ ê²½ìš° ì œê±°
        langDropdown.removeChild(node);
      }
    });

    // lang-option êµ¬ì¡° ë³µêµ¬
    var langOptions = document.querySelectorAll('.lang-option');
    langOptions.forEach(function(option) {
      // lang-flagì™€ lang-nameì´ ì—†ëŠ” ê²½ìš° ë³µêµ¬
      var hasFlag = option.querySelector('.lang-flag');
      var hasName = option.querySelector('.lang-name');
      var textContent = option.textContent.trim();

      if (!hasFlag || !hasName) {
        // í…ìŠ¤íŠ¸ ë‚´ìš©ì—ì„œ í”Œë˜ê·¸ì™€ ì´ë¦„ ì¶”ì¶œ
        var flagMatch = textContent.match(/[\u{1F1E6}-\u{1F1FF}]{2}/u);
        var flag = flagMatch ? flagMatch[0] : '';
        var name = textContent.replace(/[\u{1F1E6}-\u{1F1FF}]{2}\s*/u, '').trim();

        // ê¸°ì¡´ ë‚´ìš© ì œê±°
        while (option.firstChild) {
          option.removeChild(option.firstChild);
        }

        // êµ¬ì¡° ë³µêµ¬
        if (flag) {
          var flagSpan = document.createElement('span');
          flagSpan.className = 'lang-flag';
          flagSpan.textContent = flag;
          option.appendChild(flagSpan);
        }

        if (name) {
          var nameSpan = document.createElement('span');
          nameSpan.className = 'lang-name';
          nameSpan.textContent = name;
          option.appendChild(nameSpan);
        }
      }
    });
  }

  // Google Translate ë°°ë„ˆ/íŒì—… ê°•ì œ ìˆ¨ê¹€
  function hideGoogleTranslateBanner() {
    var banners = document.querySelectorAll(
      '.goog-te-banner-frame, [class*="VIpgJd"], #goog-gt-tt, .goog-te-balloon-frame'
    );
    banners.forEach(function(el) {
      el.style.display = 'none';
      el.style.visibility = 'hidden';
    });

    if (document.body) {
      document.body.style.top = '0';
    }
  }

  // DOM ì¤€ë¹„ ì‹œ ì´ˆê¸°í™”
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      // í˜ì´ì§€ ë¡œë“œ í›„ ì§§ì€ ì§€ì—°ìœ¼ë¡œ ì–¸ì–´ ì ìš© (ì¿ í‚¤ê°€ í™•ì‹¤íˆ ì½íˆë„ë¡)
      setTimeout(function() {
        initLangToggle();
        cleanupFontTags();
        restoreLangStructure();
        hideGoogleTranslateBanner();
      }, 100);
    });
  } else {
    // í˜ì´ì§€ ë¡œë“œ í›„ ì§§ì€ ì§€ì—°ìœ¼ë¡œ ì–¸ì–´ ì ìš© (ì¿ í‚¤ê°€ í™•ì‹¤íˆ ì½íˆë„ë¡)
    setTimeout(function() {
      initLangToggle();
      cleanupFontTags();
      restoreLangStructure();
      hideGoogleTranslateBanner();
    }, 100);
  }

  // ì£¼ê¸°ì ìœ¼ë¡œ ì •ë¦¬ ì‹¤í–‰ (ê°„ê²© ëŠ˜ë¦¼ - ì„±ëŠ¥ ìµœì í™”)
  setInterval(function() {
    cleanupFontTags();
    restoreLangStructure();
    hideGoogleTranslateBanner();
  }, 2000);

  // í•œêµ­ì–´ ì‚¬ì´íŠ¸ì´ê³  ì‹œìŠ¤í…œ ì–¸ì–´ë„ í•œêµ­ì–´ë©´ ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ì•ˆí•¨
  // ë‹¤ë¥¸ ì–¸ì–´ë©´ í•„ìš”ì‹œ ë¡œë”©
  var sysLang = getSystemLanguage();
  var currentLang = getCurrentLang();

  // ë²ˆì—­ì´ í•„ìš”í•œ ê²½ìš°ì—ë§Œ ìŠ¤í¬ë¦½íŠ¸ ë¡œë”©
  if (sysLang !== 'ko' || currentLang !== 'ko') {
    // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì§€ì—° ë¡œë”©
    if (document.readyState === 'complete') {
      setTimeout(loadTranslateScript, 100);
    } else {
      window.addEventListener('load', function() {
        setTimeout(loadTranslateScript, 100);
      });
    }
  }
})();
</script>
