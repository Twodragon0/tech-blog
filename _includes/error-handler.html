<!-- Global Error Handler for Production -->
<script>
(function() {
  'use strict';
  
  // Only run in production
  if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    return;
  }

  // Error tracking configuration
  const ERROR_CONFIG = {
    maxErrors: 10, // 최대 에러 수 (메모리 보호)
    errorWindow: 60000, // 1분 윈도우
    errors: []
  };

  // Clean old errors
  function cleanOldErrors() {
    const now = Date.now();
    ERROR_CONFIG.errors = ERROR_CONFIG.errors.filter(err => 
      now - err.timestamp < ERROR_CONFIG.errorWindow
    );
  }

  // Log error to console (development only)
  function logError(error, context) {
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      console.error('[Error Handler]', error, context);
    }
  }

  // Report error (can be extended to send to error tracking service)
  function reportError(error, context) {
    cleanOldErrors();
    
    // Prevent error spam
    if (ERROR_CONFIG.errors.length >= ERROR_CONFIG.maxErrors) {
      return;
    }

    // 안전한 에러 정보 추출
    let errorMessage = 'Unknown error';
    let errorStack = null;
    
    if (error) {
      if (typeof error === 'string') {
        errorMessage = error;
      } else if (error.message) {
        errorMessage = error.message;
      } else if (error.toString) {
        errorMessage = error.toString();
      }
      
      if (error.stack) {
        errorStack = error.stack;
      }
    }

    const errorInfo = {
      message: errorMessage,
      stack: errorStack,
      context: context || {},
      url: window.location.href,
      userAgent: navigator.userAgent,
      timestamp: Date.now()
    };

    ERROR_CONFIG.errors.push(errorInfo);

    // Log to console in development
    logError(error, context);

    // Send to Sentry if available
    if (window.Sentry && typeof window.Sentry.captureException === 'function') {
      try {
        const sentryError = error instanceof Error ? error : new Error(errorMessage);
        window.Sentry.captureException(sentryError, { 
          contexts: { custom: context || {} } 
        });
      } catch (e) {
        // Sentry 전송 실패 시 무시
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          console.warn('[Error Handler] Failed to send to Sentry:', e);
        }
      }
    }
  }

  // Global error handler
  window.addEventListener('error', function(event) {
    // Ignore errors from external scripts (CSP violations, etc.)
    if (event.filename && !event.filename.includes(window.location.hostname)) {
      // CSP 위반은 정상적인 보안 동작이므로 무시
      if (event.message && event.message.includes('Content Security Policy')) {
        return;
      }
      return;
    }

    // 안전한 에러 객체 생성
    const error = event.error || new Error(event.message || 'Unknown error');
    
    reportError(error, {
      type: 'error',
      filename: event.filename || 'unknown',
      lineno: event.lineno || 0,
      colno: event.colno || 0
    });
  }, true);

  // Unhandled promise rejection handler
  window.addEventListener('unhandledrejection', function(event) {
    // 안전한 에러 객체 생성
    let error = event.reason;
    if (!error) {
      error = new Error('Unhandled promise rejection');
    } else if (typeof error === 'string') {
      error = new Error(error);
    } else if (!(error instanceof Error)) {
      error = new Error(String(error));
    }
    
    reportError(error, {
      type: 'unhandledrejection',
      promise: event.promise ? 'Promise' : 'unknown'
    });
  }, true);

  // Resource loading error handler
  window.addEventListener('error', function(event) {
    if (event.target && event.target.tagName) {
      const tagName = event.target.tagName.toLowerCase();
      if (['img', 'script', 'link', 'style'].includes(tagName)) {
        reportError(`Failed to load ${tagName}: ${event.target.src || event.target.href}`, {
          type: 'resource',
          tag: tagName,
          src: event.target.src || event.target.href
        });
      }
    }
  }, true);

  // Performance monitoring
  if ('PerformanceObserver' in window) {
    try {
      // Long task monitoring
      const longTaskObserver = new PerformanceObserver(function(list) {
        for (const entry of list.getEntries()) {
          if (entry.duration > 50) { // 50ms 이상의 긴 작업
            reportError(`Long task detected: ${entry.duration}ms`, {
              type: 'performance',
              duration: entry.duration,
              startTime: entry.startTime
            });
          }
        }
      });
      longTaskObserver.observe({ entryTypes: ['longtask'] });
    } catch (e) {
      // Long task observer not supported
    }

    // Layout shift monitoring (CLS)
    try {
      const layoutShiftObserver = new PerformanceObserver(function(list) {
        for (const entry of list.getEntries()) {
          if (!entry.hadRecentInput && entry.value > 0.1) {
            reportError(`Layout shift detected: ${entry.value}`, {
              type: 'performance',
              metric: 'CLS',
              value: entry.value
            });
          }
        }
      });
      layoutShiftObserver.observe({ entryTypes: ['layout-shift'] });
    } catch (e) {
      // Layout shift observer not supported
    }
  }
})();
</script>
