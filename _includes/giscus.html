{% if site.giscus.repo_id != "" and site.giscus.category_id != "" %}
<section class="comments-section" id="comments">
  <div class="comments-container">
    <!-- Comments Header -->
    <div class="comments-header">
      <div class="comments-title-wrapper">
        <h3 class="comments-title">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          Comments
        </h3>
        <span class="comments-badge" id="comments-count">0</span>
      </div>
      <p class="comments-description">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
        </svg>
        GitHub 계정으로 로그인하여 댓글을 작성하세요
      </p>
    </div>

    <!-- Quick Reactions -->
    <div class="quick-reactions" id="quick-reactions">
      <span class="reactions-label">이 글이 도움이 되셨나요?</span>
      <div class="reactions-buttons">
        <button class="reaction-btn" data-reaction="thumbsUp" title="좋아요">
          <span class="reaction-emoji">&#x1F44D;</span>
          <span class="reaction-count" id="reaction-thumbsUp">0</span>
        </button>
        <button class="reaction-btn" data-reaction="heart" title="하트">
          <span class="reaction-emoji">&#x2764;&#xFE0F;</span>
          <span class="reaction-count" id="reaction-heart">0</span>
        </button>
        <button class="reaction-btn" data-reaction="rocket" title="로켓">
          <span class="reaction-emoji">&#x1F680;</span>
          <span class="reaction-count" id="reaction-rocket">0</span>
        </button>
        <button class="reaction-btn" data-reaction="eyes" title="관심">
          <span class="reaction-emoji">&#x1F440;</span>
          <span class="reaction-count" id="reaction-eyes">0</span>
        </button>
      </div>
    </div>

    <!-- Giscus Widget -->
    <div class="giscus-wrapper">
      <div class="giscus-loading" id="giscus-loading">
        <div class="loading-spinner"></div>
        <span>댓글을 불러오는 중...</span>
      </div>
      <div class="giscus" id="giscus-container">
        <noscript>
          <div class="noscript-message">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <p>댓글을 보려면 JavaScript를 활성화하세요.</p>
          </div>
        </noscript>
      </div>
    </div>

    <!-- Comment Guidelines -->
    <div class="comment-guidelines">
      <details>
        <summary>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
          댓글 작성 가이드
        </summary>
        <ul>
          <li>건설적인 피드백과 질문을 환영합니다</li>
          <li>마크다운 문법을 사용할 수 있습니다</li>
          <li>코드 블록은 ``` 로 감싸주세요</li>
          <li>상대방을 존중하는 표현을 사용해주세요</li>
        </ul>
      </details>
    </div>
  </div>

  <script>
    // Lazy load Giscus with performance optimization
    (function() {
      'use strict';

      const giscusContainer = document.getElementById('giscus-container');
      const loadingEl = document.getElementById('giscus-loading');
      const commentsCountEl = document.getElementById('comments-count');

      if (!giscusContainer) return;

      let giscusLoaded = false;
      const giscusConfig = {
        repo: "{{ site.giscus.repo }}",
        repoId: "{{ site.giscus.repo_id }}",
        category: "{{ site.giscus.category }}",
        categoryId: "{{ site.giscus.category_id }}",
        mapping: "{{ site.giscus.mapping }}",
        {% if site.giscus.mapping == "title" %}term: "{{ page.title | escape }}",{% endif %}
        strict: "0",
        reactionsEnabled: "1",
        emitMetadata: "1",
        inputPosition: "top",
        theme: localStorage.getItem('theme') === 'light' ? 'light' : 'dark_dimmed',
        lang: "{{ site.giscus.lang | default: 'ko' }}",
        crossorigin: "anonymous"
      };

      function loadGiscus() {
        if (giscusLoaded) return;
        giscusLoaded = true;

        const script = document.createElement('script');
        script.src = 'https://giscus.app/client.js';
        script.async = true;
        script.crossOrigin = giscusConfig.crossorigin;

        // Set data attributes
        script.setAttribute('data-repo', giscusConfig.repo);
        script.setAttribute('data-repo-id', giscusConfig.repoId);
        script.setAttribute('data-category', giscusConfig.category);
        script.setAttribute('data-category-id', giscusConfig.categoryId);
        script.setAttribute('data-mapping', giscusConfig.mapping);
        if (giscusConfig.term) script.setAttribute('data-term', giscusConfig.term);
        script.setAttribute('data-strict', giscusConfig.strict);
        script.setAttribute('data-reactions-enabled', giscusConfig.reactionsEnabled);
        script.setAttribute('data-emit-metadata', giscusConfig.emitMetadata);
        script.setAttribute('data-input-position', giscusConfig.inputPosition);
        script.setAttribute('data-theme', giscusConfig.theme);
        script.setAttribute('data-lang', giscusConfig.lang);
        script.setAttribute('data-loading', 'lazy');

        giscusContainer.appendChild(script);
      }

      // Handle Giscus messages
      window.addEventListener('message', function(event) {
        if (event.origin !== 'https://giscus.app') return;

        if (event.data && event.data.giscus) {
          const { discussion, type } = event.data.giscus;

          // Update comment count
          if (discussion && commentsCountEl) {
            const count = discussion.totalCommentCount || 0;
            commentsCountEl.textContent = count;
            commentsCountEl.style.display = count > 0 ? 'inline-flex' : 'none';
          }

          // Handle loading complete
          if (type === 'ready' || discussion) {
            if (loadingEl) loadingEl.style.display = 'none';
          }

          // Update reactions from discussion
          if (discussion && discussion.reactions) {
            updateReactionCounts(discussion.reactions);
          }
        }
      });

      // Update reaction counts
      function updateReactionCounts(reactions) {
        const reactionMap = {
          'THUMBS_UP': 'thumbsUp',
          'HEART': 'heart',
          'ROCKET': 'rocket',
          'EYES': 'eyes'
        };

        Object.keys(reactionMap).forEach(key => {
          const el = document.getElementById('reaction-' + reactionMap[key]);
          if (el && reactions[key] !== undefined) {
            el.textContent = reactions[key];
          }
        });
      }

      // Quick reaction buttons (link to GitHub discussion)
      document.querySelectorAll('.reaction-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          // Scroll to Giscus widget to interact with reactions
          const giscusFrame = giscusContainer.querySelector('iframe');
          if (giscusFrame) {
            giscusFrame.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        });
      });

      // Theme sync with site theme
      document.addEventListener('themeChanged', function(e) {
        const theme = e.detail === 'light' ? 'light' : 'dark_dimmed';
        const giscusFrame = giscusContainer.querySelector('iframe');
        if (giscusFrame) {
          giscusFrame.contentWindow.postMessage(
            { giscus: { setConfig: { theme: theme } } },
            'https://giscus.app'
          );
        }
      });

      // Intersection Observer for lazy loading
      if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              loadGiscus();
              observer.disconnect();
            }
          });
        }, { rootMargin: '400px' });

        observer.observe(giscusContainer);

        // Fallback timeout
        setTimeout(() => {
          if (!giscusLoaded && document.visibilityState === 'visible') {
            loadGiscus();
          }
        }, 8000);
      } else {
        // Fallback for older browsers
        setTimeout(loadGiscus, 1000);
      }

      // Hide loading after timeout
      setTimeout(() => {
        if (loadingEl) loadingEl.style.display = 'none';
      }, 12000);
    })();
  </script>
</section>
{% else %}
<section class="comments-section">
  <div class="comments-container">
    <div class="comments-header">
      <h3 class="comments-title">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        Comments
      </h3>
    </div>
    <div class="comments-disabled">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        <line x1="9" y1="10" x2="15" y2="10"/>
      </svg>
      <p>댓글 기능을 사용하려면 <a href="https://giscus.app" target="_blank" rel="noopener">Giscus</a>를 설정하세요.</p>
    </div>
  </div>
</section>
{% endif %}
