{% if site.giscus.repo_id != "" and site.giscus.category_id != "" %}
<section class="comments-section" id="comments">
  <div class="comments-container">
    <!-- Comments Header Card -->
    <div class="comments-header-card">
      <div class="comments-header-content">
        <div class="comments-icon-wrapper">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            <path d="M8 9h8M8 13h4" opacity="0.5"/>
          </svg>
        </div>
        <div class="comments-header-text">
          <h3 class="comments-title">
            Discussion
            <span class="comments-badge" id="comments-count">0</span>
          </h3>
          <p class="comments-description">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
            GitHub 계정으로 참여하세요
          </p>
        </div>
      </div>
      <div class="comments-header-decoration"></div>
    </div>

    <!-- Engagement Card -->
    <div class="engagement-card" id="quick-reactions" role="region" aria-label="게시글 반응">
      <div class="engagement-header">
        <span class="engagement-label">이 글이 도움이 되셨나요?</span>
        <span class="engagement-hint">클릭하여 반응을 남겨주세요</span>
      </div>
      <div class="reactions-grid" role="group" aria-label="반응 버튼">
        <button class="reaction-card" data-reaction="thumbsUp" aria-label="유용해요" aria-pressed="false" type="button">
          <span class="reaction-emoji" aria-hidden="true">👍</span>
          <span class="reaction-label">유용해요</span>
          <span class="reaction-count" id="reaction-thumbsUp">0</span>
        </button>
        <button class="reaction-card" data-reaction="heart" aria-label="좋아요" aria-pressed="false" type="button">
          <span class="reaction-emoji" aria-hidden="true">❤️</span>
          <span class="reaction-label">좋아요</span>
          <span class="reaction-count" id="reaction-heart">0</span>
        </button>
        <button class="reaction-card" data-reaction="rocket" aria-label="대단해요" aria-pressed="false" type="button">
          <span class="reaction-emoji" aria-hidden="true">🚀</span>
          <span class="reaction-label">대단해요</span>
          <span class="reaction-count" id="reaction-rocket">0</span>
        </button>
        <button class="reaction-card" data-reaction="eyes" aria-label="관심있어요" aria-pressed="false" type="button">
          <span class="reaction-emoji" aria-hidden="true">👀</span>
          <span class="reaction-label">관심있어요</span>
          <span class="reaction-count" id="reaction-eyes">0</span>
        </button>
      </div>
    </div>

    <!-- Giscus Widget -->
    <div class="giscus-card">
      <div class="giscus-wrapper">
        <div class="giscus-loading" id="giscus-loading">
          <div class="loading-dots">
            <span></span><span></span><span></span>
          </div>
          <span class="loading-text">댓글을 불러오는 중...</span>
        </div>
        <div class="giscus" id="giscus-container">
          <noscript>
            <div class="noscript-message">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
              </svg>
              <p>댓글을 보려면 JavaScript를 활성화하세요.</p>
            </div>
          </noscript>
        </div>
      </div>
    </div>

    <!-- Comment Guidelines -->
    <div class="guidelines-card">
      <details>
        <summary>
          <div class="guidelines-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
              <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
          </div>
          <span class="guidelines-title">댓글 작성 가이드</span>
          <svg class="guidelines-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
        </summary>
        <div class="guidelines-content">
          <div class="guideline-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            <span>건설적인 피드백과 질문을 환영합니다</span>
          </div>
          <div class="guideline-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 7V4h16v3M9 20h6M12 4v16"/>
            </svg>
            <span>마크다운 문법을 사용할 수 있습니다</span>
          </div>
          <div class="guideline-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="16 18 22 12 16 6"/>
              <polyline points="8 6 2 12 8 18"/>
            </svg>
            <span>코드 블록은 <code>```</code> 로 감싸주세요</span>
          </div>
          <div class="guideline-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            <span>상대방을 존중하는 표현을 사용해주세요</span>
          </div>
        </div>
      </details>
    </div>
  </div>

  <script>
    // Lazy load Giscus with performance optimization
    (function() {
      'use strict';

      const giscusContainer = document.getElementById('giscus-container');
      const loadingEl = document.getElementById('giscus-loading');
      const commentsCountEl = document.getElementById('comments-count');

      if (!giscusContainer) return;

      let giscusLoaded = false;
      const giscusConfig = {
        repo: "{{ site.giscus.repo }}",
        repoId: "{{ site.giscus.repo_id }}",
        category: "{{ site.giscus.category }}",
        categoryId: "{{ site.giscus.category_id }}",
        mapping: "{{ site.giscus.mapping }}",
        {% if site.giscus.mapping == "title" %}
        // 한글 제목을 그대로 전달 - Giscus가 자체적으로 처리
        term: "{{ page.title | escape }}",
        {% endif %}
        strict: "0",
        reactionsEnabled: "1",
        emitMetadata: "1",
        inputPosition: "top",
        theme: localStorage.getItem('theme') === 'light' ? 'light' : 'dark_dimmed',
        lang: "{{ site.giscus.lang | default: 'ko' }}",
        crossorigin: "anonymous"
      };

      function loadGiscus() {
        if (giscusLoaded) return;
        giscusLoaded = true;

        const script = document.createElement('script');
        script.src = 'https://giscus.app/client.js';
        script.async = true;
        script.crossOrigin = giscusConfig.crossorigin;

        // 에러 핸들링: 스크립트 로드 실패 시 조용히 처리
        script.onerror = function() {
          if (loadingEl) loadingEl.style.display = 'none';
          // Giscus 로드 실패는 조용히 처리 (네트워크 문제, 설정 문제 등)
          // 404 에러는 이미 head.html의 콘솔 필터에서 처리됨
        };

        // Set data attributes
        script.setAttribute('data-repo', giscusConfig.repo);
        script.setAttribute('data-repo-id', giscusConfig.repoId);
        script.setAttribute('data-category', giscusConfig.category);
        script.setAttribute('data-category-id', giscusConfig.categoryId);
        script.setAttribute('data-mapping', giscusConfig.mapping);
        if (giscusConfig.term) {
          // term은 이미 encodeURIComponent로 인코딩되었으므로 그대로 사용
          script.setAttribute('data-term', giscusConfig.term);
        }
        script.setAttribute('data-strict', giscusConfig.strict);
        script.setAttribute('data-reactions-enabled', giscusConfig.reactionsEnabled);
        script.setAttribute('data-emit-metadata', giscusConfig.emitMetadata);
        script.setAttribute('data-input-position', giscusConfig.inputPosition);
        script.setAttribute('data-theme', giscusConfig.theme);
        script.setAttribute('data-lang', giscusConfig.lang);
        script.setAttribute('data-loading', 'lazy');

        giscusContainer.appendChild(script);
      }

      // Handle Giscus messages
      window.addEventListener('message', function(event) {
        if (event.origin !== 'https://giscus.app') return;

        if (event.data && event.data.giscus) {
          const { discussion, type } = event.data.giscus;

          // Update comment count
          if (discussion && commentsCountEl) {
            const count = discussion.totalCommentCount || 0;
            commentsCountEl.textContent = count;
            commentsCountEl.style.display = count > 0 ? 'inline-flex' : 'none';
          }

          // Handle loading complete
          if (type === 'ready' || discussion) {
            if (loadingEl) loadingEl.style.display = 'none';
          }

          // Handle error messages
          if (type === 'error') {
            if (loadingEl) loadingEl.style.display = 'none';
            // 404 에러 등은 조용히 처리 (GitHub Discussions 설정 문제일 수 있음)
          }

          // Update reactions from discussion
          if (discussion && discussion.reactions) {
            updateReactionCounts(discussion.reactions);
          }
        }
      });

      // Update reaction counts
      function updateReactionCounts(reactions) {
        const reactionMap = {
          'THUMBS_UP': 'thumbsUp',
          'HEART': 'heart',
          'ROCKET': 'rocket',
          'EYES': 'eyes'
        };

        Object.keys(reactionMap).forEach(key => {
          const el = document.getElementById('reaction-' + reactionMap[key]);
          if (el && reactions[key] !== undefined) {
            el.textContent = reactions[key];
          }
        });
      }

      // Quick reaction cards
      document.querySelectorAll('.reaction-card').forEach(btn => {
        const reactionType = btn.getAttribute('data-reaction');
        const savedState = localStorage.getItem(`reaction-${reactionType}`);
        if (savedState === 'active') {
          btn.classList.add('active');
          btn.setAttribute('aria-pressed', 'true');
        }

        btn.addEventListener('click', function(e) {
          e.preventDefault();
          
          const isActive = this.classList.contains('active');
          
          if (isActive) {
            this.classList.remove('active');
            this.setAttribute('aria-pressed', 'false');
            localStorage.removeItem(`reaction-${reactionType}`);
          } else {
            document.querySelectorAll('.reaction-card').forEach(b => {
              b.classList.remove('active');
              b.setAttribute('aria-pressed', 'false');
              localStorage.removeItem(`reaction-${b.getAttribute('data-reaction')}`);
            });
            
            this.classList.add('active');
            this.setAttribute('aria-pressed', 'true');
            localStorage.setItem(`reaction-${reactionType}`, 'active');
          }

          // Scroll to Giscus widget to interact with reactions
          const giscusFrame = giscusContainer.querySelector('iframe');
          if (giscusFrame) {
            setTimeout(() => {
              giscusFrame.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
          }
        });
      });

      // Theme sync with site theme
      document.addEventListener('themeChanged', function(e) {
        const theme = e.detail === 'light' ? 'light' : 'dark_dimmed';
        const giscusFrame = giscusContainer.querySelector('iframe');
        if (giscusFrame) {
          giscusFrame.contentWindow.postMessage(
            { giscus: { setConfig: { theme: theme } } },
            'https://giscus.app'
          );
        }
      });

      // Intersection Observer for lazy loading
      if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              loadGiscus();
              observer.disconnect();
            }
          });
        }, { rootMargin: '400px' });

        observer.observe(giscusContainer);

        // Fallback timeout
        setTimeout(() => {
          if (!giscusLoaded && document.visibilityState === 'visible') {
            loadGiscus();
          }
        }, 8000);
      } else {
        // Fallback for older browsers
        setTimeout(loadGiscus, 1000);
      }

      // Hide loading after timeout
      setTimeout(() => {
        if (loadingEl) loadingEl.style.display = 'none';
      }, 12000);
    })();
  </script>
</section>
{% else %}
<section class="comments-section">
  <div class="comments-container">
    <div class="comments-header">
      <h3 class="comments-title">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        Comments
      </h3>
    </div>
    <div class="comments-disabled">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        <line x1="9" y1="10" x2="15" y2="10"/>
      </svg>
      <p>댓글 기능을 사용하려면 <a href="https://giscus.app" target="_blank" rel="noopener">Giscus</a>를 설정하세요.</p>
    </div>
  </div>
</section>
{% endif %}
